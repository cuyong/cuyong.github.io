<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.1.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"liketostudy.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="百学须先立志">
<meta property="og:type" content="website">
<meta property="og:title" content="琛的个人博客">
<meta property="og:url" content="http://liketostudy.com/index.html">
<meta property="og:site_name" content="琛的个人博客">
<meta property="og:description" content="百学须先立志">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="文晨">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://liketostudy.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>琛的个人博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">琛的个人博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-resources">

    <a href="/resources/" rel="section"><i class="download fa-fw"></i>资源</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-schedule">

    <a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>日程表</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://liketostudy.com/2023/02/13/%E5%AE%9E%E4%B9%A0-05-YTS%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="文晨">
      <meta itemprop="description" content="百学须先立志">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="琛的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/13/%E5%AE%9E%E4%B9%A0-05-YTS%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B/" class="post-title-link" itemprop="url">实习-05-YTS测试用例</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-02-13 15:02:57" itemprop="dateCreated datePublished" datetime="2023-02-13T15:02:57+08:00">2023-02-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-02-14 15:50:48" itemprop="dateModified" datetime="2023-02-14T15:50:48+08:00">2023-02-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AE%9E%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">实习</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="YTS测试"><a href="#YTS测试" class="headerlink" title="YTS测试"></a>YTS测试</h1><blockquote>
<p>参考文档链接如下</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://uap-wiki.yyrd.com/pages/viewpage.action?pageId=177940639#yts%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3-3.2.2Httpclient-tcc%E8%B0%83%E7%94%A8">https://uap-wiki.yyrd.com/pages/viewpage.action?pageId=177940639#yts%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3-3.2.2Httpclient-tcc%E8%B0%83%E7%94%A8</a>:</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230213142706813.png" alt="image-20230213142706813"></p>
<p>调用方式：<a target="_blank" rel="noopener" href="http://bip-daily.yyuap.com/http-send-demo/http/httpClientSave?uid=7&amp;amount=20&amp;orderId=02&amp;ytsMode=tcc">http://bip-daily.yyuap.com/http-send-demo/http/httpClientSave?uid=7&amp;amount=20&amp;orderId=02&amp;ytsMode=tcc</a></p>
<p>3.2.2.1 无桩情况</p>
<p>通过查询所有节点status状态是否为confirmed;</p>
<p>查询语句：</p>
<p>select * from <code>yts-http-client</code>.yts_trans_xxxx where gtx_id&#x3D;’#####’ ;</p>
<p>select * from <code>yts-http-client</code>.yts_rel_xxxx where gtx_id&#x3D;’#####’ ;</p>
<table>
<thead>
<tr>
<th align="left">数据库</th>
<th align="left">表</th>
<th align="left">期望状态</th>
</tr>
</thead>
<tbody><tr>
<td align="left">yts-http-client</td>
<td align="left">trans</td>
<td align="left">confirmed</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">rel</td>
<td align="left">confirmed</td>
</tr>
<tr>
<td align="left">yts-http-provider</td>
<td align="left">trans</td>
<td align="left">confirmed</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">rel</td>
<td align="left">confirmed</td>
</tr>
<tr>
<td align="left">yts-http-provider</td>
<td align="left">trans</td>
<td align="left">confirmed</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">rel</td>
<td align="left">confirmed</td>
</tr>
</tbody></table>
<p>1.点击调用链接<a target="_blank" rel="noopener" href="http://bip-daily.yyuap.com/http-send-demo/http/httpClientSave?uid=7&amp;amount=20&amp;orderId=02&amp;ytsMode=tcc">http://bip-daily.yyuap.com/http-send-demo/http/httpClientSave?uid=7&amp;amount=20&amp;orderId=02&amp;ytsMode=tcc</a></p>
<p>出现如下结果：</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230213142821202.png" alt="image-20230213142821202"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;orderId&quot;:&quot;02&quot;,&quot;gtxId&quot;:&quot;20230213140715@98ff5cb0-7060-46c1-87c5-523ca58fb99b&quot;,&quot;message&quot;:&quot;付款成功，请到对应库中验证&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>2.查询结果</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> `yts<span class="operator">-</span>http<span class="operator">-</span>client`.yts_trans_20230213 <span class="keyword">where</span> gtx_id<span class="operator">=</span><span class="string">&#x27;20230213140715@98ff5cb0-7060-46c1-87c5-523ca58fb99b&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>pk</strong>, id, module_name, service_name, method_name, <strong>gtx_id</strong>, <strong>tx_id</strong>, <strong>ptx_id</strong>, cancel_method, type, <strong>status</strong>, create_time, interface_name, update_time, confirm_method, reported, context, env, call_tag, provider_id, invocation, all_confirmed, mode, retry_status, bill_no, trace_id, rule_id</p>
<p><strong>‘139’</strong>, ‘ef8887d3-5bb3-45fb-af9d-18e39569120b’, ‘http-send-demo’, ‘http-send-demo’, ‘GET’, <strong>‘20230213140715@98ff5cb0-7060-46c1-87c5-523ca58fb99b’</strong>, <strong>‘59c4d67a-39a4-4e3b-ad56-75503bdd26f5’</strong>, <strong>NULL</strong>, NULL, ‘ROOT’, <strong>‘CONFIRMED’</strong>, ‘1676268435439’, ‘com.yonyou.ucf.mdd.api.interfaces.rpc.IRuleApi’, ‘1676268451304’, NULL, ‘’, ‘{&quot;rootProviderId&quot;:&quot;c87e2267-1001-4c70-bb2a-ab41f3b81aa3&quot;,&quot;rootServiceName&quot;:&quot;http-send-demo&quot;}’, ‘combine’, NULL, ‘c87e2267-1001-4c70-bb2a-ab41f3b81aa3’, ?, ‘0’, ‘httpClient_tcc’, NULL, NULL, ‘1602eb0fceb13732’, ‘&#x2F;yts-http-demo&#x2F;yts&#x2F;httpClientTccSave’</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> `yts<span class="operator">-</span>http<span class="operator">-</span>client`.yts_rel_20230213 <span class="keyword">where</span> gtx_id<span class="operator">=</span><span class="string">&#x27;20230213140715@98ff5cb0-7060-46c1-87c5-523ca58fb99b&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>pk</strong>, id, module_name, call_service_name, call_interface_name, call_method_name, service_name, interface_name, <strong>method_name</strong>, <strong>gtx_id</strong>, <strong>ptx_id</strong>, <strong>tx_id</strong>, cancel_method, invocation, cancel_invocation, provider_id, server_provider_id, create_time, update_time, confirm_method, env, parent_pk, call_tag, mode, retry_count, <strong>status</strong>, retry_status, reported, bill_no, trace_id, rule_id, confirm</p>
<p>‘<strong>139</strong>‘, ‘2f00baa6-6b22-4489-bac2-da9095c820dc’, ‘<a target="_blank" rel="noopener" href="http://bip-daily.yyuap.com&/#39;">http://bip-daily.yyuap.com&#39;</a>, ‘http-send-demo’, NULL, NULL, ‘<a target="_blank" rel="noopener" href="http://bip-daily.yyuap.com&/#39;">http://bip-daily.yyuap.com&#39;</a>, ‘&#x2F;yts-http-demo&#x2F;yts&#x2F;httpClientTccSave’, ‘<strong>GET</strong>‘, ‘<strong>20230213140715@98ff5cb0-7060-46c1-87c5-523ca58fb99b</strong>‘, ‘<strong>59c4d67a-39a4-4e3b-ad56-75503bdd26f5</strong>‘, ‘<strong>6f8e15fc-f9b2-4545-b022-2c2f422340e9</strong>‘, ‘cancel’, ?, ?, ‘c87e2267-1001-4c70-bb2a-ab41f3b81aa3’, NULL, ‘1676268435504’, ‘1676268451238’, NULL, ‘combine’, ‘139’, NULL, ‘httpClient_tcc’, ‘1’, ‘<strong>CONFIRMED</strong>‘, NULL, NULL, NULL, NULL, NULL, ‘0’</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> `yts<span class="operator">-</span>http<span class="operator">-</span>provider`.yts_trans_20230213 <span class="keyword">where</span> gtx_id<span class="operator">=</span><span class="string">&#x27;20230213140715@98ff5cb0-7060-46c1-87c5-523ca58fb99b&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>pk</strong>, id, module_name, service_name, method_name, <strong>gtx_id</strong>, <strong>tx_id</strong>, <strong>ptx_id</strong>, cancel_method, type, <strong>status</strong>, create_time, interface_name, update_time, confirm_method, reported, context, env, call_tag, provider_id, invocation, all_confirmed, mode, retry_status, bill_no, trace_id, rule_id</p>
<p>‘<strong>214</strong>‘, ‘e7dac527-896c-4be6-9a47-dc6034b927fd’, ‘yts-http-provider’, ‘yts-http-provider’, ‘GET’, ‘<strong>20230213140715@98ff5cb0-7060-46c1-87c5-523ca58fb99b</strong>‘, ‘<strong>6f8e15fc-f9b2-4545-b022-2c2f422340e9</strong>‘, ‘<strong>59c4d67a-39a4-4e3b-ad56-75503bdd26f5</strong>‘, NULL, ‘BRANCH’, ‘<strong>CONFIRMED</strong>‘, ‘1676268450611’, ‘com.yonyou.ucf.mdd.api.interfaces.rpc.IRuleApi’, ‘1676268451184’, NULL, ‘’, ‘{&quot;rootProviderId&quot;:&quot;c87e2267-1001-4c70-bb2a-ab41f3b81aa3&quot;,&quot;rootServiceName&quot;:&quot;http-send-demo&quot;}’, ‘combine’, ‘’, ‘c87e2267-1001-4c70-bb2a-ab41f3b81aa3’, ?, ‘0’, ‘httpClient_tcc’, ‘’, NULL, ‘237b53c582d36d47’, ‘&#x2F;yts&#x2F;httpClientTccSave’</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> `yts<span class="operator">-</span>http<span class="operator">-</span>provider`.yts_rel_20230213 <span class="keyword">where</span> gtx_id<span class="operator">=</span><span class="string">&#x27;20230213140715@98ff5cb0-7060-46c1-87c5-523ca58fb99b&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>pk</strong>, id, module_name, call_service_name, call_interface_name, call_method_name, service_name, interface_name, method_name, <strong>gtx_id, ptx_id, tx_id</strong>, cancel_method, invocation, cancel_invocation, provider_id, server_provider_id, create_time, update_time, confirm_method, env, parent_pk, call_tag, mode, retry_count, status, retry_status, reported, bill_no, trace_id, rule_id, confirm</p>
<p>‘<strong>101</strong>‘, ‘6d7efcc1-9e9b-4a2a-95cf-d63987502461’, ‘<a target="_blank" rel="noopener" href="http://bip-daily.yyuap.com&/#39;">http://bip-daily.yyuap.com&#39;</a>, ‘yts-http-provider’, NULL, NULL, ‘<a target="_blank" rel="noopener" href="http://bip-daily.yyuap.com&/#39;">http://bip-daily.yyuap.com&#39;</a>, ‘&#x2F;yts-http-privider2&#x2F;yts&#x2F;httpClientTccSave’, ‘GET’, ‘<strong>20230213140715@98ff5cb0-7060-46c1-87c5-523ca58fb99b’, ‘6f8e15fc-f9b2-4545-b022-2c2f422340e9’, ‘649a5ace-30f3-4ab6-bf77-6efced96ff1f</strong>‘, ‘cancel’, ?, ?, ‘c87e2267-1001-4c70-bb2a-ab41f3b81aa3’, NULL, ‘1676268450678’, ‘1676268451096’, NULL, ‘combine’, ‘214’, NULL, ‘httpClient_tcc’, ‘1’, ‘CONFIRMED’, NULL, NULL, NULL, NULL, NULL, ‘0’</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> `yts<span class="operator">-</span>http<span class="operator">-</span>provider2`.yts_trans_20230213 <span class="keyword">where</span> gtx_id<span class="operator">=</span><span class="string">&#x27;20230213140715@98ff5cb0-7060-46c1-87c5-523ca58fb99b&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>pk</strong>, id, module_name, service_name, method_name, <strong>gtx_id</strong>, <strong>tx_id</strong>, <strong>ptx_id</strong>, cancel_method, type, <strong>status</strong>, create_time, interface_name, update_time, confirm_method, reported, context, env, call_tag, provider_id, invocation, all_confirmed, mode, retry_status, bill_no, trace_id, rule_id</p>
<p>‘<strong>158</strong>‘, ‘afa9ae81-cc3f-45d9-8bae-a6b8f48c32d4’, ‘yts-http-privider2’, ‘yts-http-privider2’, ‘GET’, ‘<strong>20230213140715@98ff5cb0-7060-46c1-87c5-523ca58fb99b</strong>‘, ‘<strong>649a5ace-30f3-4ab6-bf77-6efced96ff1f</strong>‘, ‘<strong>6f8e15fc-f9b2-4545-b022-2c2f422340e9</strong>‘, NULL, ‘BRANCH’, ‘<strong>CONFIRMED</strong>‘, ‘1676268450745’, ‘com.yonyou.ucf.mdd.api.interfaces.rpc.IRuleApi’, ‘1676268451070’, NULL, ‘’, ‘{&quot;rootProviderId&quot;:&quot;c87e2267-1001-4c70-bb2a-ab41f3b81aa3&quot;,&quot;rootServiceName&quot;:&quot;http-send-demo&quot;}’, ‘combine’, ‘’, ‘c87e2267-1001-4c70-bb2a-ab41f3b81aa3’, ?, ‘0’, ‘httpClient_tcc’, ‘’, NULL, ‘a7f0390cf8ce46e0’, ‘&#x2F;yts&#x2F;httpClientTccSave’</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> `yts<span class="operator">-</span>http<span class="operator">-</span>provider2`.yts_rel_20230213 <span class="keyword">where</span> gtx_id<span class="operator">=</span><span class="string">&#x27;20230213140715@98ff5cb0-7060-46c1-87c5-523ca58fb99b&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>没查到，表是空表</p>
<p><strong>trans</strong></p>
<table>
<thead>
<tr>
<th></th>
<th><code>yts-http-client</code></th>
<th><code>yts-http-provider</code></th>
<th>‘yts-http-privider2’</th>
</tr>
</thead>
<tbody><tr>
<td>gtx_id</td>
<td>20230213140715@98ff5cb0-7060-46c1-87c5-523ca58fb99b</td>
<td>20230213140715@98ff5cb0-7060-46c1-87c5-523ca58fb99b</td>
<td>20230213140715@98ff5cb0-7060-46c1-87c5-523ca58fb99b</td>
</tr>
<tr>
<td>tx_id</td>
<td>59c4d67a-39a4-4e3b-ad56-75503bdd26f5</td>
<td>6f8e15fc-f9b2-4545-b022-2c2f422340e9</td>
<td>649a5ace-30f3-4ab6-bf77-6efced96ff1f</td>
</tr>
<tr>
<td>ptx_id</td>
<td>NULL</td>
<td>59c4d67a-39a4-4e3b-ad56-75503bdd26f5</td>
<td>6f8e15fc-f9b2-4545-b022-2c2f422340e9</td>
</tr>
</tbody></table>
<p><strong>rel</strong></p>
<table>
<thead>
<tr>
<th></th>
<th><code>yts-http-client</code></th>
<th><code>yts-http-provider</code></th>
<th>‘yts-http-privider2’</th>
</tr>
</thead>
<tbody><tr>
<td>gtx_id</td>
<td>20230213140715@98ff5cb0-7060-46c1-87c5-523ca58fb99b</td>
<td>20230213140715@98ff5cb0-7060-46c1-87c5-523ca58fb99b</td>
<td>20230213140715@98ff5cb0-7060-46c1-87c5-523ca58fb99b</td>
</tr>
<tr>
<td>tx_id</td>
<td>59c4d67a-39a4-4e3b-ad56-75503bdd26f5</td>
<td>6f8e15fc-f9b2-4545-b022-2c2f422340e9</td>
<td></td>
</tr>
<tr>
<td>ptx_id</td>
<td>6f8e15fc-f9b2-4545-b022-2c2f422340e9</td>
<td>649a5ace-30f3-4ab6-bf77-6efced96ff1f</td>
<td></td>
</tr>
</tbody></table>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://liketostudy.com/2023/02/09/%E5%AE%9E%E4%B9%A0-04-YMS-JDBC%E5%B7%A5%E7%A8%8B%E6%B5%8B%E8%AF%95%E5%8F%8A%E6%8E%A5%E5%8F%A3%E7%BC%96%E5%86%99/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="文晨">
      <meta itemprop="description" content="百学须先立志">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="琛的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/09/%E5%AE%9E%E4%B9%A0-04-YMS-JDBC%E5%B7%A5%E7%A8%8B%E6%B5%8B%E8%AF%95%E5%8F%8A%E6%8E%A5%E5%8F%A3%E7%BC%96%E5%86%99/" class="post-title-link" itemprop="url">实习-04-YMS-JDBC工程测试及接口编写</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-02-09 15:22:57" itemprop="dateCreated datePublished" datetime="2023-02-09T15:22:57+08:00">2023-02-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-02-14 16:05:40" itemprop="dateModified" datetime="2023-02-14T16:05:40+08:00">2023-02-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AE%9E%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">实习</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="git拉取yms-library项目"><a href="#git拉取yms-library项目" class="headerlink" title="git拉取yms-library项目"></a>git拉取yms-library项目</h1><p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230209103638993.png" alt="image-20230209103638993"></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>运行报错找不到sql.translator.impl</p>
<p>询问诗涵解决</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230209103722555.png" alt="image-20230209103722555"></p>
<p>已解决</p>
<h1 id="进行test排查异常报错等"><a href="#进行test排查异常报错等" class="headerlink" title="进行test排查异常报错等"></a>进行test排查异常报错等</h1><h2 id="测试过程"><a href="#测试过程" class="headerlink" title="测试过程"></a>测试过程</h2><h3 id="测试test-BaseDAOTest-testUpdate"><a href="#测试test-BaseDAOTest-testUpdate" class="headerlink" title="测试test.BaseDAOTest#testUpdate"></a>测试test.BaseDAOTest#testUpdate</h3><p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230209110353196.png" alt="image-20230209110353196"></p>
<p>存疑 有问题（已解决）</p>
<blockquote>
<p>测试test.BaseDAOTest#testUpdate3</p>
<p>同上</p>
<p>测试test.BaseDAOTest#testUpdate2</p>
<p>同上</p>
</blockquote>
<h3 id="测试test-BaseDAOTest-testUpdate4"><a href="#测试test-BaseDAOTest-testUpdate4" class="headerlink" title="测试test.BaseDAOTest#testUpdate4"></a>测试test.BaseDAOTest#testUpdate4</h3><blockquote>
<p>测试成功，实现update持久化</p>
</blockquote>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230209135614895.png" alt="image-20230209135614895"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUpdate4</span><span class="params">()</span> <span class="keyword">throws</span> DAOException &#123;</span><br><span class="line">    <span class="type">SQLParameter</span> <span class="variable">parameter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SQLParameter</span>();</span><br><span class="line">    parameter.addParam(<span class="string">&quot;btax_test5&quot;</span>);</span><br><span class="line">    parameter.addParam(<span class="string">&quot;0000026a-f46f-4eee-98a7-ff4d4114bcf3&quot;</span>);</span><br><span class="line">    parameter.addParam(<span class="string">&quot;2022-07-21 18:45:09.0&quot;</span>);</span><br><span class="line">    baseDAO.update(<span class="string">&quot;update ipuquotation_test set btax=? where ipuquotaionid=? and pubts=? &quot;</span>, parameter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><input disabled type="checkbox"> 梳理流程</li>
</ul>
<h3 id="测试test-BaseDAOTest-testSaveWithPk"><a href="#测试test-BaseDAOTest-testSaveWithPk" class="headerlink" title="测试test.BaseDAOTest#testSaveWithPk"></a>测试test.BaseDAOTest#testSaveWithPk</h3><blockquote>
<p>测试成功</p>
</blockquote>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230209135550209.png" alt="image-20230209135550209"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSaveWithPk</span><span class="params">()</span> <span class="keyword">throws</span> DAOException &#123;</span><br><span class="line">    <span class="comment">//IpuQuotation quotation = baseDAO.queryByPK(IpuQuotation.class, &quot;2&quot;, new String[]&#123;&quot;ipuquotaionid&quot;, &quot;btax&quot;&#125;);</span></span><br><span class="line">    <span class="type">IpuQuotation</span> <span class="variable">quotation1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IpuQuotation</span>();</span><br><span class="line">    quotation1.setBtax(<span class="string">&quot;btax_test&quot;</span>);</span><br><span class="line">    quotation1.setIpuquotaionid(<span class="string">&quot;5&quot;</span>);</span><br><span class="line">    baseDAO.insertWithPK(quotation1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><input disabled type="checkbox"> 梳理流程</li>
</ul>
<h3 id="测试test-BaseDAOTest-testSave"><a href="#测试test-BaseDAOTest-testSave" class="headerlink" title="测试test.BaseDAOTest#testSave"></a>测试test.BaseDAOTest#testSave</h3><blockquote>
<p>测试成功</p>
</blockquote>
<p><img src="/.com//Users\温家琛\AppData\Roaming\Typora\typora-user-images\image-20230209135745373.png" alt="image-20230209135745373"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSave</span><span class="params">()</span> <span class="keyword">throws</span> DAOException &#123;</span><br><span class="line">    <span class="type">IpuQuotation</span> <span class="variable">quotation</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IpuQuotation</span>();</span><br><span class="line">    quotation.setBtax(<span class="string">&quot;btax_test1&quot;</span>);</span><br><span class="line">    quotation.setIpuquotaionid(<span class="string">&quot;test_save12&quot;</span>);</span><br><span class="line">    baseDAO.insert(quotation);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><input disabled type="checkbox"> 梳理流程</li>
</ul>
<h3 id="测试test-BaseDAOTest-testSaveList"><a href="#测试test-BaseDAOTest-testSaveList" class="headerlink" title="测试test.BaseDAOTest#testSaveList"></a>测试test.BaseDAOTest#testSaveList</h3><h3 id="测试test-BaseDAOTest-testSaveList2"><a href="#测试test-BaseDAOTest-testSaveList2" class="headerlink" title="测试test.BaseDAOTest#testSaveList2"></a>测试test.BaseDAOTest#testSaveList2</h3><h3 id="测试test-BaseDAOTest-testDelete"><a href="#测试test-BaseDAOTest-testDelete" class="headerlink" title="测试test.BaseDAOTest#testDelete"></a>测试test.BaseDAOTest#testDelete</h3><blockquote>
<p>测试成功</p>
</blockquote>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230209143756540.png" alt="image-20230209143756540"></p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230209143805344.png" alt="image-20230209143805344"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDelete</span><span class="params">()</span> <span class="keyword">throws</span> DAOException &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">IpuQuotation</span> <span class="variable">ipuQuotation</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IpuQuotation</span>();</span><br><span class="line">    ipuQuotation.setIpuquotaionid(<span class="string">&quot;test2&quot;</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">IpuQuotation</span> <span class="variable">ipuQuotation2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IpuQuotation</span>();</span><br><span class="line">    ipuQuotation2.setIpuquotaionid(<span class="string">&quot;test1&quot;</span>);</span><br><span class="line">    baseDAO.remove(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;IpuQuotation&gt;() &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            add(ipuQuotation);</span><br><span class="line">            add(ipuQuotation2);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="测试test-BaseDAOTest-testQueryAll"><a href="#测试test-BaseDAOTest-testQueryAll" class="headerlink" title="测试test.BaseDAOTest#testQueryAll"></a>测试test.BaseDAOTest#testQueryAll</h3><blockquote>
<p>测试成功</p>
</blockquote>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230209144618751.png" alt="image-20230209144618751"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testQueryAll</span><span class="params">()</span> <span class="keyword">throws</span> DAOException &#123;</span><br><span class="line">    <span class="type">IpuQuotation</span> <span class="variable">ipuQuotation</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IpuQuotation</span>();</span><br><span class="line">    List&lt;IpuQuotation&gt; quotation = baseDAO.queryAll(ipuQuotation);</span><br><span class="line">    System.out.println(quotation.size());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="测试test-BaseDAOTest-testQueryByClause"><a href="#测试test-BaseDAOTest-testQueryByClause" class="headerlink" title="测试test.BaseDAOTest#testQueryByClause"></a>测试test.BaseDAOTest#testQueryByClause</h3><blockquote>
<p>测试成功</p>
</blockquote>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230209144735753.png" alt="image-20230209144735753"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testQueryByClause2</span><span class="params">()</span> <span class="keyword">throws</span> DAOException &#123;</span><br><span class="line">    <span class="type">SQLParameter</span> <span class="variable">parameter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SQLParameter</span>();</span><br><span class="line">    parameter.addParam(<span class="string">&quot;btax_test&quot;</span>);</span><br><span class="line">    <span class="type">IpuQuotation</span> <span class="variable">ipuQuotation</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IpuQuotation</span>();</span><br><span class="line">    List&lt;IpuQuotation&gt; ipuQuotations =</span><br><span class="line">            baseDAO.queryByClause(ipuQuotation, <span class="string">&quot;select * from ipuquotation_test&quot;</span> + <span class="string">&quot; where btax=?&quot;</span>,</span><br><span class="line">                    parameter);</span><br><span class="line">    System.out.println(ipuQuotations.size());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="测试test-BaseDAOTest-testQueryByClause2"><a href="#测试test-BaseDAOTest-testQueryByClause2" class="headerlink" title="测试test.BaseDAOTest#testQueryByClause2"></a>测试test.BaseDAOTest#testQueryByClause2</h3><blockquote>
<p>测试成功</p>
</blockquote>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230209144933387.png" alt="image-20230209144933387"></p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230209144857363.png" alt="image-20230209144857363"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testQueryByClause2</span><span class="params">()</span> <span class="keyword">throws</span> DAOException &#123;</span><br><span class="line">    <span class="type">SQLParameter</span> <span class="variable">parameter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SQLParameter</span>();</span><br><span class="line">    parameter.addParam(<span class="string">&quot;btax_test&quot;</span>);</span><br><span class="line">    <span class="type">IpuQuotation</span> <span class="variable">ipuQuotation</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IpuQuotation</span>();</span><br><span class="line">    List&lt;IpuQuotation&gt; ipuQuotations =</span><br><span class="line">            baseDAO.queryByClause(ipuQuotation, <span class="string">&quot;select * from ipuquotation_test&quot;</span> + <span class="string">&quot; where btax=?&quot;</span>,</span><br><span class="line">                    parameter);</span><br><span class="line">    System.out.println(ipuQuotations.size());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="问题梳理总结"><a href="#问题梳理总结" class="headerlink" title="问题梳理总结"></a>问题梳理总结</h2><p>queryByPK</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUpdate</span><span class="params">()</span> <span class="keyword">throws</span> DAOException &#123;</span><br><span class="line">    <span class="type">IpuQuotation</span> <span class="variable">ipuQuotation</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IpuQuotation</span>();</span><br><span class="line">    <span class="type">IpuQuotation</span> <span class="variable">quotation</span> <span class="operator">=</span> baseDAO.queryByPK(ipuQuotation, <span class="string">&quot;2&quot;</span>);</span><br><span class="line">    quotation.setBtax(<span class="string">&quot;btax_test4&quot;</span>);</span><br><span class="line">    baseDAO.update(quotation, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;btax&quot;</span>&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>com.yonyou.iuap.yms.dao.AbstractDAO#queryByPK(com.yonyou.iuap.yms.param.BaseEntity, ID)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据PK查询指定VO</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> baseEntity</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pk        主键</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">queryByPK</span><span class="params">(BaseEntity baseEntity, ID pk)</span> <span class="keyword">throws</span> DAOException &#123;</span><br><span class="line">    <span class="keyword">return</span> queryByPK(baseEntity, pk, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>com.yonyou.iuap.yms.dao.AbstractDAO#queryByPK(com.yonyou.iuap.yms.param.BaseEntity, ID, java.lang.String[])</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据主键返回指定列的VO对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">queryByPK</span><span class="params">(BaseEntity baseEntity, ID pk, String[] selectedFields)</span> <span class="keyword">throws</span> DAOException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        manager = createPersistenceManager();</span><br><span class="line">        <span class="keyword">return</span> (T) manager.retrieveByPK(baseEntity, pk, selectedFields);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        logger.error(e.getMessage(), e);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DAOException</span>(e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>com.yonyou.iuap.yms.jdbc.AbstractJdbcPersistenceManager#retrieveByPK(com.yonyou.iuap.yms.param.BaseEntity, ID, java.lang.String[])</p>
<blockquote>
<p>Entity entity &#x3D; MetaEntityHelper.getMetaEntity(fullName);</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据主键查询</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> &lt;T, ID&gt; T <span class="title function_">retrieveByPK</span><span class="params">(BaseEntity baseEntity, ID pk, String[] selectedFields)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (pk == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;pk is null&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">T</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">ormAttributeSign</span> <span class="operator">=</span> BeanDataOperateHelper.initOrmAttributeSign(baseEntity);</span><br><span class="line">    Map&lt;String, Object&gt; resultMap = <span class="literal">null</span>;</span><br><span class="line">    <span class="type">SQLParameter</span> <span class="variable">param</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SQLParameter</span>();</span><br><span class="line">    param.addParam(pk);</span><br><span class="line">    <span class="type">Class</span> <span class="variable">clz</span> <span class="operator">=</span> baseEntity.getClass();</span><br><span class="line">    <span class="type">String</span> <span class="variable">fullName</span> <span class="operator">=</span> baseEntity.getFullName();</span><br><span class="line">    Map&lt;String, ORMColumnInfo&gt; types = findColumnInfo(clz, fullName);</span><br><span class="line">    <span class="type">Entity</span> <span class="variable">entity</span> <span class="operator">=</span> MetaEntityHelper.getMetaEntity(fullName);</span><br><span class="line">    List&lt;Property&gt; elasticAttributes = entity.getElasticAttributes();</span><br><span class="line">    <span class="comment">//buildSQL</span></span><br><span class="line">    <span class="keyword">for</span> (Property elasticProperty : elasticAttributes) &#123;</span><br><span class="line">        types.remove(elasticProperty.columnName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">StringBuffer</span> <span class="variable">columnsForQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">    <span class="keyword">for</span> (String columnName : types.keySet()) &#123;</span><br><span class="line">        columnsForQuery.append(columnName).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    columnsForQuery.delete(columnsForQuery.length() - <span class="number">1</span>, columnsForQuery.length());</span><br><span class="line"></span><br><span class="line">    List&lt;OneToOneType&gt; parallelTypes = BizMetaHelper.getOneToOneField(baseEntity, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">    List&lt;OneToOneType&gt; characteristicTypes = BeanProcessorHelper.getCharacteristicOneToOneField(fullName);</span><br><span class="line">    <span class="type">String</span> <span class="variable">condition</span> <span class="operator">=</span> BeanProcessorHelper.getPkColumn(baseEntity.getClass(), baseEntity.getFullName()) + <span class="string">&quot;=?&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (CollectionUtils.isEmpty(parallelTypes) &amp;&amp; CollectionUtils.isEmpty(characteristicTypes)) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">pkName</span> <span class="operator">=</span> BeanProcessorHelper.getPkColumn(clz, fullName);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">hasPKField</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">mainSQL</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">tableName</span> <span class="operator">=</span> BeanProcessorHelper.getTableName(clz, fullName);</span><br><span class="line">        <span class="keyword">if</span> (selectedFields == <span class="literal">null</span>) &#123;</span><br><span class="line">            mainSQL.append(<span class="string">&quot;SELECT &quot;</span>).append(columnsForQuery).append(<span class="string">&quot; FROM &quot;</span>).append(tableName);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            selectedFields = transPropertyNameToFieldNames(clz, fullName, selectedFields);</span><br><span class="line">            String[] columns = getValidNames(fullName, clz, types, baseEntity, selectedFields);</span><br><span class="line">            mainSQL.append(<span class="string">&quot;SELECT &quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; columns.length; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (columns[i] != <span class="literal">null</span>) &#123;</span><br><span class="line">                    mainSQL.append(columns[i]).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (columns[i].equalsIgnoreCase(pkName)) &#123;</span><br><span class="line">                        hasPKField = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!hasPKField) &#123;</span><br><span class="line">                mainSQL.append(pkName).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            mainSQL.setLength(mainSQL.length() - <span class="number">1</span>);</span><br><span class="line">            mainSQL.append(<span class="string">&quot; FROM &quot;</span>).append(tableName);</span><br><span class="line">        &#125;</span><br><span class="line">        mainSQL.append(<span class="string">&quot; WHERE &quot;</span>).append(condition);</span><br><span class="line">        <span class="type">BaseProcessor</span> <span class="variable">processor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanListProcessor</span>(baseEntity);</span><br><span class="line">        List&lt;T&gt; results = getJdbcSession().executeQuery(mainSQL.toString(), param, processor);</span><br><span class="line">        <span class="keyword">if</span> (results.size() &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">            result = results.get(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(<span class="string">&quot;query for oneToOne .. &#123;&#125; &quot;</span>, clz.getClasses());</span><br><span class="line">        &#125;</span><br><span class="line">        Field[] fields = baseEntity.getClass().getDeclaredFields();</span><br><span class="line">        String[] propNames = <span class="keyword">new</span> <span class="title class_">String</span>[fields.length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; fields.length; i++) &#123;</span><br><span class="line">            propNames[i] = fields[i].getName();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">pkName</span> <span class="operator">=</span> BeanProcessorHelper.getPkColumn(clz, fullName);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">hasPKField</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">mainSQL</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">tableName</span> <span class="operator">=</span> BeanProcessorHelper.getTableName(clz, fullName);</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">mapSQL</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        mapSQL.append(<span class="string">&quot;SELECT * FROM &quot;</span>).append(tableName).append(<span class="string">&quot; WHERE &quot;</span>).append(condition);</span><br><span class="line">        List&lt;Map&gt; mapList = getJdbcSession().executeQuery(mapSQL.toString(), param, <span class="keyword">new</span> <span class="title class_">MapListProcessor</span>());</span><br><span class="line">        <span class="keyword">if</span> (mapList.size() &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">            resultMap = mapList.get(<span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.debug(<span class="string">&quot;查询结果为空！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (selectedFields == <span class="literal">null</span>) &#123;</span><br><span class="line">            mainSQL.append(<span class="string">&quot;SELECT &quot;</span>).append(columnsForQuery).append(<span class="string">&quot; FROM &quot;</span>).append(tableName).append(<span class="string">&quot; WHERE &quot;</span>).append(condition);</span><br><span class="line">            List&lt;T&gt; results = getJdbcSession().executeQuery(mainSQL.toString(), param, <span class="keyword">new</span> <span class="title class_">BeanListProcessor</span>(baseEntity));</span><br><span class="line">            <span class="keyword">if</span> (results.size() &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">                result = results.get(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//特征</span></span><br><span class="line">            <span class="keyword">for</span> (OneToOneType oneToOneType : characteristicTypes) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">childSQL</span> <span class="operator">=</span> buildSQLWithoutSelectFields(oneToOneType, clz, fullName, resultMap);</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.isNotEmpty(childSQL)) &#123;</span><br><span class="line">                    characteristicEntityHandler(baseEntity, childSQL, fullName, result, ormAttributeSign);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//平行</span></span><br><span class="line">            <span class="keyword">for</span> (OneToOneType oneToOneType : parallelTypes) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">childTable</span> <span class="operator">=</span> BeanProcessorHelper.getTableName(oneToOneType.getTargetEntity(), oneToOneType.getTargetFullName());</span><br><span class="line">                <span class="type">String</span> <span class="variable">childSQL</span> <span class="operator">=</span> buildSQLWithoutSelectFields(oneToOneType, clz, fullName, resultMap);</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.isNotEmpty(childSQL)) &#123;</span><br><span class="line">                    parallelEntityHandler(baseEntity, childSQL, childTable, result, ormAttributeSign);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String[] filterFileds = transPropertyNameToFieldNames(clz, fullName, selectedFields);</span><br><span class="line">            Set&lt;String&gt; filerdFieldSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">            filerdFieldSet.addAll(Arrays.asList(filterFileds));</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">columnBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; filterFileds.length; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (filterFileds[i] != <span class="literal">null</span>) &#123;</span><br><span class="line">                    columnBuilder.append(filterFileds[i]).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (filterFileds[i].equalsIgnoreCase(pkName)) &#123;</span><br><span class="line">                        hasPKField = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            columnBuilder.append(<span class="string">&quot;pubts&quot;</span>).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            columnBuilder.append(<span class="string">&quot;dr&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (!hasPKField) &#123;</span><br><span class="line">                columnBuilder.append(<span class="string">&quot;,&quot;</span>).append(pkName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            sql.append(<span class="string">&quot;SELECT &quot;</span>).append(columnBuilder).append(<span class="string">&quot; FROM &quot;</span>).append(tableName).append(<span class="string">&quot; WHERE &quot;</span>).append(condition);</span><br><span class="line">            <span class="type">BaseProcessor</span> <span class="variable">processor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanListProcessor</span>(baseEntity);</span><br><span class="line">            List&lt;T&gt; results = getJdbcSession().executeQuery(sql.toString(), param, processor);</span><br><span class="line">            <span class="keyword">if</span> (results.size() &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">                result = results.get(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//特征</span></span><br><span class="line">            <span class="keyword">for</span> (OneToOneType oneToOneType : characteristicTypes) &#123;</span><br><span class="line">                <span class="type">Class</span> <span class="variable">childClz</span> <span class="operator">=</span> oneToOneType.getTargetEntity();</span><br><span class="line">                <span class="type">String</span> <span class="variable">childTable</span> <span class="operator">=</span> BeanProcessorHelper.getTableName(childClz, oneToOneType.getTargetFullName());</span><br><span class="line">                <span class="type">String</span> <span class="variable">childSQL</span> <span class="operator">=</span> buildSQLWithSelectedFields(oneToOneType, clz, fullName, selectedFields, resultMap, childTable);</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.isNotEmpty(childSQL)) &#123;</span><br><span class="line">                    characteristicEntityHandler(baseEntity, childSQL, fullName, result, ormAttributeSign);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//平行</span></span><br><span class="line">            <span class="keyword">for</span> (OneToOneType oneToOneType : parallelTypes) &#123;</span><br><span class="line">                <span class="type">Class</span> <span class="variable">childClz</span> <span class="operator">=</span> oneToOneType.getTargetEntity();</span><br><span class="line">                <span class="type">String</span> <span class="variable">childTable</span> <span class="operator">=</span> BeanProcessorHelper.getTableName(childClz, oneToOneType.getTargetFullName());</span><br><span class="line">                <span class="type">String</span> <span class="variable">childSQL</span> <span class="operator">=</span> buildSQLWithSelectedFields(oneToOneType, clz, fullName, selectedFields, resultMap, childTable);</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.isNotEmpty(childSQL)) &#123;</span><br><span class="line">                    parallelEntityHandler(baseEntity, childSQL, childTable, result, ormAttributeSign);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>com.yonyou.iuap.yms.imeta.MetaEntityHelper#getMetaEntity</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据fullName获取元数据信息</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fullName</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Entity <span class="title function_">getMetaEntity</span><span class="params">(String fullName)</span> &#123;</span><br><span class="line">    <span class="type">Entity</span> <span class="variable">entity</span> <span class="operator">=</span> BizContext.getMetaRepository().entity(fullName);</span><br><span class="line">    <span class="keyword">if</span> (entity == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;can&#x27;t get the meta info of&quot;</span> + fullName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> entity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BizContext.getMetaRepository()得到的是空指针，因此出现异常</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><blockquote>
<p>询问张健</p>
</blockquote>
<ul>
<li>找到yms-jdbc-biz模块</li>
<li>找到src&#x2F;test&#x2F;java&#x2F;imetatest&#x2F;MetaEntityHelperTest.java</li>
<li>找到com.yonyou.iuap.yms.imeta.MetaEntityHelper</li>
<li>将前者的类文件内容拷贝至后者中即可</li>
</ul>
<h2 id="YMS控制台配置数据源（诗涵解决）"><a href="#YMS控制台配置数据源（诗涵解决）" class="headerlink" title="YMS控制台配置数据源（诗涵解决）"></a>YMS控制台配置数据源（诗涵解决）</h2><p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230209150237331.png" alt="image-20230209150237331"></p>
<h1 id="编写接口queryByUnionKeyMap实现联合查询"><a href="#编写接口queryByUnionKeyMap实现联合查询" class="headerlink" title="编写接口queryByUnionKeyMap实现联合查询"></a>编写接口queryByUnionKeyMap实现联合查询</h1><h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>public <T> T queryByUnionKeyMap(BaseEntity baseEntity, Map&lt;String,Object&gt; unionKeyMap, String[] selectedFields) throws BusinessException;</T></p>
<p>实现：</p>
<p>select name,id from table where id&#x3D;1;</p>
<p>map.put(“id”,1)<br>map.put(“ytenant_id”,1)<br>map.put(“dr”,1)<br>select name,id from table where id&#x3D;1 and ytenant_id&#x3D;aaa and dr&#x3D;1</p>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><h3 id="IYmsJdbcApi-queryByUnionKeyMap"><a href="#IYmsJdbcApi-queryByUnionKeyMap" class="headerlink" title="IYmsJdbcApi#queryByUnionKeyMap"></a>IYmsJdbcApi#queryByUnionKeyMap</h3><blockquote>
<p>com.yonyou.iuap.yms.api.IYmsJdbcApi#queryByUnionKeyMap</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据Map查询数据，只返回指定字段的数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> baseEntity</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> unionKeyMap</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> selectedFields</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> BusinessException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">queryByUnionKeyMap</span><span class="params">(BaseEntity baseEntity, Map&lt;String,Object&gt; unionKeyMap, String[] selectedFields)</span> <span class="keyword">throws</span> BusinessException;</span><br></pre></td></tr></table></figure>

<h3 id="AbstractDAO-queryByUnionKeyMap-amp-queryByUnionKeyMap"><a href="#AbstractDAO-queryByUnionKeyMap-amp-queryByUnionKeyMap" class="headerlink" title="AbstractDAO#queryByUnionKeyMap&amp;queryByUnionKeyMap"></a>AbstractDAO#queryByUnionKeyMap&amp;queryByUnionKeyMap</h3><blockquote>
<p>com.yonyou.iuap.yms.dao.AbstractDAO#<strong>queryByUnionKeyMap</strong>(com.yonyou.iuap.yms.param.BaseEntity, java.util.Map&lt;java.lang.String,java.lang.Object&gt;)以及com.yonyou.iuap.yms.dao.AbstractDAO#<strong>queryByUnionKeyMap</strong>(com.yonyou.iuap.yms.param.BaseEntity, java.util.Map&lt;java.lang.String,java.lang.Object&gt;, java.lang.String[])</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据主键列表查询数据，查询指定VO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> baseEntity</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> unionKeyMap</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> BusinessException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">queryByUnionKeyMap</span><span class="params">(BaseEntity baseEntity, Map&lt;String, Object&gt; unionKeyMap)</span> <span class="keyword">throws</span> BusinessException &#123;</span><br><span class="line">    <span class="keyword">return</span> queryByUnionKeyMap(baseEntity, unionKeyMap, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据主键列表查询数据，返回指定列的VO对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> baseEntity</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> unionKeyMap</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> selectedFields</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> BusinessException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">queryByUnionKeyMap</span><span class="params">(BaseEntity baseEntity, Map&lt;String, Object&gt; unionKeyMap, String[] selectedFields)</span> <span class="keyword">throws</span> BusinessException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        manager = createPersistenceManager();</span><br><span class="line">        <span class="keyword">return</span> (T) manager.retrieveByUnionKeyMap(baseEntity, unionKeyMap, selectedFields);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        logger.error(e.getMessage(), e);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DAOException</span>(e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="AbstractJdbcPersistenceManager-retrieveByPK-amp-retrieveByUnionKeyMap"><a href="#AbstractJdbcPersistenceManager-retrieveByPK-amp-retrieveByUnionKeyMap" class="headerlink" title="AbstractJdbcPersistenceManager#retrieveByPK&amp;retrieveByUnionKeyMap"></a>AbstractJdbcPersistenceManager#retrieveByPK&amp;retrieveByUnionKeyMap</h3><blockquote>
<p>com.yonyou.iuap.yms.jdbc.AbstractJdbcPersistenceManager#<strong>retrieveByPK</strong>(com.yonyou.iuap.yms.param.BaseEntity, ID, java.lang.String[])以及com.yonyou.iuap.yms.jdbc.AbstractJdbcPersistenceManager#<strong>retrieveByUnionKeyMap</strong>(com.yonyou.iuap.yms.param.BaseEntity, java.util.Map&lt;java.lang.String,java.lang.Object&gt;)</p>
</blockquote>
<blockquote>
<p>修改原方法<strong>retrieveByPK</strong>()，添加现方法<strong>retrieveByUnionKeyMap</strong>()</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据主键查询</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> &lt;T, ID&gt; T <span class="title function_">retrieveByPK</span><span class="params">(BaseEntity baseEntity, ID pk)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">return</span> retrieveByPK(baseEntity, pk, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据主键查询</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> &lt;T, ID&gt; T <span class="title function_">retrieveByPK</span><span class="params">(BaseEntity baseEntity, ID pk, String[] selectedFields)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (pk == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;pk is null&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">T</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    Map&lt;String, Object&gt; unionKeyMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    unionKeyMap.put(BeanProcessorHelper.getPkColumn(baseEntity.getClass(), baseEntity.getFullName()), pk);</span><br><span class="line">    <span class="comment">//直接调用联合查询方法</span></span><br><span class="line">    result = retrieveByUnionKeyMap(baseEntity, unionKeyMap, selectedFields);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 联合查询，返回指定字段数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">retrieveByUnionKeyMap</span><span class="params">(BaseEntity baseEntity, Map&lt;String, Object&gt; unionKeyMap)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">return</span> retrieveByUnionKeyMap(baseEntity, unionKeyMap, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 联合查询，返回指定字段数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">retrieveByUnionKeyMap</span><span class="params">(BaseEntity baseEntity, Map&lt;String, Object&gt; unionKeyMap, String[] selectedFields)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">//先判断传入的unionKeyMap是否为空，如果为空返回</span></span><br><span class="line">    <span class="keyword">if</span> (unionKeyMap == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;unionKeyMap is null&quot;</span>); <span class="comment">//pk改为unionKeyMap</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">T</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">ormAttributeSign</span> <span class="operator">=</span> BeanDataOperateHelper.initOrmAttributeSign(baseEntity);</span><br><span class="line">    Map&lt;String, Object&gt; resultMap = <span class="literal">null</span>;</span><br><span class="line">    <span class="type">SQLParameter</span> <span class="variable">param</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SQLParameter</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//遍历Map的Key和Value，Key加入到临时conditionList中，Value加入到param.paramList中</span></span><br><span class="line">    List&lt;String&gt; conditionList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span>(Map.Entry&lt;String, Object&gt; entry : unionKeyMap.entrySet())&#123;</span><br><span class="line">        conditionList.add(entry.getKey());</span><br><span class="line">        param.addParam(entry.getValue());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Class</span> <span class="variable">clz</span> <span class="operator">=</span> baseEntity.getClass();</span><br><span class="line">    <span class="type">String</span> <span class="variable">fullName</span> <span class="operator">=</span> baseEntity.getFullName();</span><br><span class="line">    Map&lt;String, ORMColumnInfo&gt; types = findColumnInfo(clz, fullName);</span><br><span class="line">    <span class="type">Entity</span> <span class="variable">entity</span> <span class="operator">=</span> MetaEntityHelper.getMetaEntity(fullName);</span><br><span class="line">    List&lt;Property&gt; elasticAttributes = entity.getElasticAttributes();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//buildSQL</span></span><br><span class="line">    <span class="keyword">for</span> (Property elasticProperty : elasticAttributes) &#123;</span><br><span class="line">        types.remove(elasticProperty.columnName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">StringBuffer</span> <span class="variable">columnsForQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">    <span class="keyword">for</span> (String columnName : types.keySet()) &#123;</span><br><span class="line">        columnsForQuery.append(columnName).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//删掉最后一个逗号</span></span><br><span class="line">    columnsForQuery.delete(columnsForQuery.length() - <span class="number">1</span>, columnsForQuery.length());</span><br><span class="line"></span><br><span class="line">    List&lt;OneToOneType&gt; parallelTypes = BizMetaHelper.getOneToOneField(baseEntity, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">    List&lt;OneToOneType&gt; characteristicTypes = BeanProcessorHelper.getCharacteristicOneToOneField(fullName);</span><br><span class="line">    <span class="comment">//改前：condition仅包括主键</span></span><br><span class="line">    <span class="comment">//String condition = BeanProcessorHelper.getPkColumn(baseEntity.getClass(), baseEntity.getFullName()) + &quot;=?&quot;;</span></span><br><span class="line">    <span class="comment">//改后：condition包括unionKeyMap中的所有Key值</span></span><br><span class="line">    <span class="type">StringBuffer</span> <span class="variable">condition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">    <span class="keyword">for</span>(String s : conditionList)&#123;</span><br><span class="line">        condition.append(s + <span class="string">&quot;=? and &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    condition.delete(condition.length() - <span class="number">5</span>, condition.length());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (CollectionUtils.isEmpty(parallelTypes) &amp;&amp; CollectionUtils.isEmpty(characteristicTypes)) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">pkName</span> <span class="operator">=</span> BeanProcessorHelper.getPkColumn(clz, fullName);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">hasPKField</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">mainSQL</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">tableName</span> <span class="operator">=</span> BeanProcessorHelper.getTableName(clz, fullName);</span><br><span class="line">        <span class="keyword">if</span> (selectedFields == <span class="literal">null</span>) &#123;</span><br><span class="line">            mainSQL.append(<span class="string">&quot;SELECT &quot;</span>).append(columnsForQuery).append(<span class="string">&quot; FROM &quot;</span>).append(tableName);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            selectedFields = transPropertyNameToFieldNames(clz, fullName, selectedFields);</span><br><span class="line">            String[] columns = getValidNames(fullName, clz, types, baseEntity, selectedFields);</span><br><span class="line">            mainSQL.append(<span class="string">&quot;SELECT &quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; columns.length; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (columns[i] != <span class="literal">null</span>) &#123;</span><br><span class="line">                    mainSQL.append(columns[i]).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (columns[i].equalsIgnoreCase(pkName)) &#123;</span><br><span class="line">                        hasPKField = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!hasPKField) &#123;</span><br><span class="line">                mainSQL.append(pkName).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            mainSQL.setLength(mainSQL.length() - <span class="number">1</span>);</span><br><span class="line">            mainSQL.append(<span class="string">&quot; FROM &quot;</span>).append(tableName);</span><br><span class="line">        &#125;</span><br><span class="line">        mainSQL.append(<span class="string">&quot; WHERE &quot;</span>).append(condition);</span><br><span class="line">        <span class="type">BaseProcessor</span> <span class="variable">processor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanListProcessor</span>(baseEntity);</span><br><span class="line">        List&lt;T&gt; results = getJdbcSession().executeQuery(mainSQL.toString(), param, processor);</span><br><span class="line">        <span class="keyword">if</span> (results.size() &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">            result = results.get(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(<span class="string">&quot;query for oneToOne .. &#123;&#125; &quot;</span>, clz.getClasses());</span><br><span class="line">        &#125;</span><br><span class="line">        Field[] fields = baseEntity.getClass().getDeclaredFields();</span><br><span class="line">        String[] propNames = <span class="keyword">new</span> <span class="title class_">String</span>[fields.length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; fields.length; i++) &#123;</span><br><span class="line">            propNames[i] = fields[i].getName();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">pkName</span> <span class="operator">=</span> BeanProcessorHelper.getPkColumn(clz, fullName);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">hasPKField</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">mainSQL</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">tableName</span> <span class="operator">=</span> BeanProcessorHelper.getTableName(clz, fullName);</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">mapSQL</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        mapSQL.append(<span class="string">&quot;SELECT * FROM &quot;</span>).append(tableName).append(<span class="string">&quot; WHERE &quot;</span>).append(condition);</span><br><span class="line">        List&lt;Map&gt; mapList = getJdbcSession().executeQuery(mapSQL.toString(), param, <span class="keyword">new</span> <span class="title class_">MapListProcessor</span>());</span><br><span class="line">        <span class="keyword">if</span> (mapList.size() &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">            resultMap = mapList.get(<span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.debug(<span class="string">&quot;查询结果为空！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (selectedFields == <span class="literal">null</span>) &#123;</span><br><span class="line">            mainSQL.append(<span class="string">&quot;SELECT &quot;</span>).append(columnsForQuery).append(<span class="string">&quot; FROM &quot;</span>).append(tableName).append(<span class="string">&quot; WHERE &quot;</span>).append(condition);</span><br><span class="line">            List&lt;T&gt; results = getJdbcSession().executeQuery(mainSQL.toString(), param, <span class="keyword">new</span> <span class="title class_">BeanListProcessor</span>(baseEntity));</span><br><span class="line">            <span class="keyword">if</span> (results.size() &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">                result = results.get(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//特征</span></span><br><span class="line">            <span class="keyword">for</span> (OneToOneType oneToOneType : characteristicTypes) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">childSQL</span> <span class="operator">=</span> buildSQLWithoutSelectFields(oneToOneType, clz, fullName, resultMap);</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.isNotEmpty(childSQL)) &#123;</span><br><span class="line">                    characteristicEntityHandler(baseEntity, childSQL, fullName, result, ormAttributeSign);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//平行</span></span><br><span class="line">            <span class="keyword">for</span> (OneToOneType oneToOneType : parallelTypes) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">childTable</span> <span class="operator">=</span> BeanProcessorHelper.getTableName(oneToOneType.getTargetEntity(), oneToOneType.getTargetFullName());</span><br><span class="line">                <span class="type">String</span> <span class="variable">childSQL</span> <span class="operator">=</span> buildSQLWithoutSelectFields(oneToOneType, clz, fullName, resultMap);</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.isNotEmpty(childSQL)) &#123;</span><br><span class="line">                    parallelEntityHandler(baseEntity, childSQL, childTable, result, ormAttributeSign);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String[] filterFileds = transPropertyNameToFieldNames(clz, fullName, selectedFields);</span><br><span class="line">            Set&lt;String&gt; filerdFieldSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">            filerdFieldSet.addAll(Arrays.asList(filterFileds));</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">columnBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; filterFileds.length; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (filterFileds[i] != <span class="literal">null</span>) &#123;</span><br><span class="line">                    columnBuilder.append(filterFileds[i]).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (filterFileds[i].equalsIgnoreCase(pkName)) &#123;</span><br><span class="line">                        hasPKField = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            columnBuilder.append(<span class="string">&quot;pubts&quot;</span>).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            columnBuilder.append(<span class="string">&quot;dr&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (!hasPKField) &#123;</span><br><span class="line">                columnBuilder.append(<span class="string">&quot;,&quot;</span>).append(pkName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            sql.append(<span class="string">&quot;SELECT &quot;</span>).append(columnBuilder).append(<span class="string">&quot; FROM &quot;</span>).append(tableName).append(<span class="string">&quot; WHERE &quot;</span>).append(condition);</span><br><span class="line">            <span class="type">BaseProcessor</span> <span class="variable">processor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanListProcessor</span>(baseEntity);</span><br><span class="line">            List&lt;T&gt; results = getJdbcSession().executeQuery(sql.toString(), param, processor);</span><br><span class="line">            <span class="keyword">if</span> (results.size() &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">                result = results.get(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//特征</span></span><br><span class="line">            <span class="keyword">for</span> (OneToOneType oneToOneType : characteristicTypes) &#123;</span><br><span class="line">                <span class="type">Class</span> <span class="variable">childClz</span> <span class="operator">=</span> oneToOneType.getTargetEntity();</span><br><span class="line">                <span class="type">String</span> <span class="variable">childTable</span> <span class="operator">=</span> BeanProcessorHelper.getTableName(childClz, oneToOneType.getTargetFullName());</span><br><span class="line">                <span class="type">String</span> <span class="variable">childSQL</span> <span class="operator">=</span> buildSQLWithSelectedFields(oneToOneType, clz, fullName, selectedFields, resultMap, childTable);</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.isNotEmpty(childSQL)) &#123;</span><br><span class="line">                    characteristicEntityHandler(baseEntity, childSQL, fullName, result, ormAttributeSign);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//平行</span></span><br><span class="line">            <span class="keyword">for</span> (OneToOneType oneToOneType : parallelTypes) &#123;</span><br><span class="line">                <span class="type">Class</span> <span class="variable">childClz</span> <span class="operator">=</span> oneToOneType.getTargetEntity();</span><br><span class="line">                <span class="type">String</span> <span class="variable">childTable</span> <span class="operator">=</span> BeanProcessorHelper.getTableName(childClz, oneToOneType.getTargetFullName());</span><br><span class="line">                <span class="type">String</span> <span class="variable">childSQL</span> <span class="operator">=</span> buildSQLWithSelectedFields(oneToOneType, clz, fullName, selectedFields, resultMap, childTable);</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.isNotEmpty(childSQL)) &#123;</span><br><span class="line">                    parallelEntityHandler(baseEntity, childSQL, childTable, result, ormAttributeSign);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="上传git"><a href="#上传git" class="headerlink" title="上传git"></a>上传git</h2><p>develop_wjc分支</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230213162630405.png" alt="image-20230213162630405"></p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230213162720140.png" alt="image-20230213162720140"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://liketostudy.com/2023/02/07/%E5%AE%9E%E4%B9%A0-03-MDD%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="文晨">
      <meta itemprop="description" content="百学须先立志">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="琛的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/07/%E5%AE%9E%E4%B9%A0-03-MDD%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">实习-03-MDD框架学习</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-02-07 14:59:57" itemprop="dateCreated datePublished" datetime="2023-02-07T14:59:57+08:00">2023-02-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-02-14 15:56:22" itemprop="dateModified" datetime="2023-02-14T15:56:22+08:00">2023-02-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AE%9E%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">实习</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="MDD框架学习"><a href="#MDD框架学习" class="headerlink" title="MDD框架学习"></a>MDD框架学习</h1><h2 id="任务"><a href="#任务" class="headerlink" title="任务"></a>任务</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://bip-daily.yyuap.com/#/">https://bip-daily.yyuap.com/#/</a><br>用户名：19908188888<br>密码： test0630</p>
<p>验证码666666</p>
</blockquote>
<h3 id="从图书订单TCC开始看，跟代码进行逻辑梳理"><a href="#从图书订单TCC开始看，跟代码进行逻辑梳理" class="headerlink" title="从图书订单TCC开始看，跟代码进行逻辑梳理"></a>从图书订单TCC开始看，跟代码进行逻辑梳理</h3><ul>
<li>首先是进入页面</li>
</ul>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230202170945908.png" alt="image-20230202170945908"></p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230202171010198.png" alt="image-20230202171010198"></p>
<ul>
<li>查看构建</li>
</ul>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230202171110864.png" alt="image-20230202171110864"></p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230202171203111.png" alt="image-20230202171203111"></p>
<p>可以对应上开发和实际页面，点击配置后进行代码跟进</p>
<h3 id="order–-gt-stock–-gt-pay"><a href="#order–-gt-stock–-gt-pay" class="headerlink" title="order–&gt;stock–&gt;pay"></a>order–&gt;stock–&gt;pay</h3><ul>
<li>工程间调用关系梳理</li>
</ul>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230201111246717.png" alt="image-20230201111246717"></p>
<ul>
<li>工程中，分别学习</li>
</ul>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230202171333291.png" alt="image-20230202171333291"></p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230202171348768.png" alt="image-20230202171348768"></p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230202171404751.png" alt="image-20230202171404751"></p>
<h3 id="看的过程中，结合mdd工程代码，进行学习"><a href="#看的过程中，结合mdd工程代码，进行学习" class="headerlink" title="看的过程中，结合mdd工程代码，进行学习"></a>看的过程中，结合mdd工程代码，进行学习</h3><p>采用double shift进行查找yts相关进行学习，结合yts评审文档中mdd和yts结合过程，梳理yts在mdd中的作用，结合方式等</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230202171448043.png" alt="image-20230202171448043"></p>
<h2 id="学习笔记"><a href="#学习笔记" class="headerlink" title="学习笔记"></a>学习笔记</h2><h3 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h3><p>全局：</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230214151116644.png" alt="image-20230214151116644"></p>
<p>上方：</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230214150755125.png" alt="image-20230214150755125"></p>
<p>左侧：</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230214151429919.png" alt="image-20230214151429919"></p>
<p>右侧为：</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230214151002135.png" alt="image-20230214151002135"></p>
<p>下左侧为：</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230214151036553.png"></p>
<p>下右侧为：</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230214151053561.png" alt="image-20230214151053561"></p>
<h3 id="配置保存流程–跟进代码-md"><a href="#配置保存流程–跟进代码-md" class="headerlink" title="配置保存流程–跟进代码.md"></a>配置保存流程–跟进代码.md</h3><h4 id="页面操作及规则查看"><a href="#页面操作及规则查看" class="headerlink" title="页面操作及规则查看"></a>页面操作及规则查看</h4><p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230203100154865.png" alt="image-20230203100154865"></p>
<p>对应</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230203100239463.png" alt="image-20230203100239463"></p>
<p>查看保存过程</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230203100319880.png" alt="image-20230203100319880"></p>
<h4 id="规则详细内容"><a href="#规则详细内容" class="headerlink" title="规则详细内容"></a>规则详细内容</h4><h5 id="com-yonyou-ucf-mdd-ext-bill-rule-biz-FillPKRule"><a href="#com-yonyou-ucf-mdd-ext-bill-rule-biz-FillPKRule" class="headerlink" title="com.yonyou.ucf.mdd.ext.bill.rule.biz.FillPKRule"></a>com.yonyou.ucf.mdd.ext.bill.rule.biz.FillPKRule</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service(&quot;fillPKRule&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FillPKRule</span> <span class="keyword">extends</span> <span class="title class_">AbstractCommonRule</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FillPKRule</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> RuleExecuteResult <span class="title function_">execute</span><span class="params">(BillContext billContext, Map&lt;String, Object&gt; paramMap)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//列表查询dto:查询条件、分页、汇总显示</span></span><br><span class="line">        <span class="type">BillDataDto</span> <span class="variable">billData</span> <span class="operator">=</span> (BillDataDto)<span class="built_in">this</span>.getParam(paramMap);</span><br><span class="line">        </span><br><span class="line">        List&lt;BizObject&gt; bills = <span class="built_in">this</span>.getBills(billContext, paramMap);</span><br><span class="line">        FillFkDao.execute(billContext.getFullname(), bills);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RuleExecuteResult</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">###  com.yonyou.ucf.mdd.ext.dao.meta.biz.FillFkDao</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T <span class="keyword">extends</span> <span class="title class_">BizObject</span>&gt; <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(String fullname, List&lt;T&gt; bills)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    initIPKGeneratorConfig();</span><br><span class="line">    Map&lt;String, KeyIterator&gt; insertEntityPK = ipkGeneratorConfig.configMap();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Entity entity=MetaDaoHelper.getEntity(fullname);</span><br><span class="line">    <span class="comment">// 遍历所有对象</span></span><br><span class="line">    <span class="keyword">for</span> (BizObject bill : bills) &#123;</span><br><span class="line"></span><br><span class="line">        ObjectHierarchyBuilder.build(bill, entity);</span><br><span class="line">        <span class="comment">// 设置主键</span></span><br><span class="line">        <span class="comment">//20200722 只支持number 类型 ObjectPKWalker pkWalker = new ObjectPKWalker(insertEntityPK);</span></span><br><span class="line">        <span class="type">MddObjectPKWalker</span> <span class="variable">pkWalker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MddObjectPKWalker</span>(insertEntityPK);</span><br><span class="line">        ObjectWalker.walk(pkWalker, bill, fullname);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置关联关系字段值（主子实体中，子对象外键）</span></span><br><span class="line">        <span class="type">ObjectFKWalker</span> <span class="variable">fkWalker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectFKWalker</span>();</span><br><span class="line">        <span class="comment">// 在一次遍历中通过next可以设置多个walker</span></span><br><span class="line">        <span class="comment">// ChainWalker&lt;Association, BizObject&gt; otherWalker = new ...;</span></span><br><span class="line">        <span class="comment">// fkWalker.setNext(otherWalker);</span></span><br><span class="line">        ObjectWalker.walk(fkWalker, bill, fullname);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="com-yonyou-ucf-mdd-ext-bill-rule-check-CheckUniqueRule"><a href="#com-yonyou-ucf-mdd-ext-bill-rule-check-CheckUniqueRule" class="headerlink" title="com.yonyou.ucf.mdd.ext.bill.rule.check.CheckUniqueRule"></a>com.yonyou.ucf.mdd.ext.bill.rule.check.CheckUniqueRule</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service(&quot;checkUniqueRule&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CheckUniqueRule</span> <span class="keyword">extends</span> <span class="title class_">AbstractCommonRule</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(CheckUniqueRule.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CheckUniqueRule</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> RuleExecuteResult <span class="title function_">execute</span><span class="params">(BillContext billContext, Map&lt;String, Object&gt; paramMap)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (billContext == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RuleExecuteResult</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            List&lt;BizObject&gt; bills = <span class="built_in">this</span>.getBills(billContext, paramMap);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != bills &amp;&amp; bills.size() != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="type">Entity</span> <span class="variable">entity</span> <span class="operator">=</span> MetaDaoHelper.getEntity(billContext.getFullname());</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> == entity) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">&quot;查询元数据失败:&quot;</span> + billContext.getFullname());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="type">ServiceSupportHolder</span> <span class="variable">holder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServiceSupportHolder</span>(billContext, paramMap, bills, entity);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">config</span> <span class="operator">=</span> <span class="built_in">this</span>.getConfig();</span><br><span class="line">                    holder.setConfig(config);</span><br><span class="line">                    <span class="type">BillDataDto</span> <span class="variable">billDataDto</span> <span class="operator">=</span> (BillDataDto)<span class="built_in">this</span>.getParam(paramMap);</span><br><span class="line">                    holder.setBillData(billDataDto);</span><br><span class="line">                    <span class="type">IServiceSupportApi</span> <span class="variable">iServiceSupportApi</span> <span class="operator">=</span> (IServiceSupportApi)AppContext.getBean(CheckUniqueSupportService.class);</span><br><span class="line">                    <span class="keyword">return</span> (RuleExecuteResult)iServiceSupportApi.execute(holder);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RuleExecuteResult</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### com.yonyou.ucf.mdd.support.abs.AbstractServiceSupport</span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">execute</span><span class="params">(ServiceSupportHolder holder)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    beforeHandler(holder);	<span class="comment">//空</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">resultHandler</span> <span class="operator">=</span> doExecute(holder);</span><br><span class="line">    afterExecute(holder, resultHandler);	<span class="comment">//空</span></span><br><span class="line">    <span class="keyword">return</span> resultHandler;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">### com.yonyou.ucf.mdd.support.support.CheckUniqueSupportService</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">doExecute</span><span class="params">(ServiceSupportHolder holder)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">IDoBillService</span> <span class="variable">iDoBillService</span> <span class="operator">=</span> getBeanDo(ServiceSupportStatic.CheckUnique.DO);</span><br><span class="line">        <span class="keyword">return</span> iDoBillService.doExecute(holder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">### com.yonyou.ucf.mdd.support.support.check.checkunique.DoExecuteCheckUniqueService</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">doExecute</span><span class="params">(ServiceSupportHolder holder)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">BillDataDto</span> <span class="variable">item</span> <span class="operator">=</span> holder.getBillData();</span><br><span class="line">    <span class="comment">//是否check具体某个属性比如check_name,check_code</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isHasItem</span> <span class="operator">=</span> <span class="literal">null</span> == item.getItem() ? <span class="literal">false</span> : <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (isHasItem) &#123;</span><br><span class="line">        <span class="type">CheckItem</span> <span class="variable">checkItem</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Gson</span>().fromJson(item.getItem(), CheckItem.class);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == checkItem || checkItem.getKey() == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RuleExecuteResult</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Entity</span> <span class="variable">entity</span> <span class="operator">=</span> holder.getEntity();</span><br><span class="line">    <span class="comment">//构建检查唯一性的BO对象</span></span><br><span class="line">    <span class="type">CheckUnionBO</span> <span class="variable">checkUnionBO</span> <span class="operator">=</span> createCheckUnionBO(holder);</span><br><span class="line">    <span class="comment">//待回滚的参数 并发唯一了</span></span><br><span class="line">    List&lt;String&gt; needRollList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    List&lt;BizObject&gt; bills = holder.getBillList();</span><br><span class="line">    <span class="comment">//是否支持内存check</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">autoCode</span> <span class="operator">=</span> checkUnionBO.isAutoCode();</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; codeTempDataCaches = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 自动编码下需要把编码换成UUID，防止并发时被唯一校验控制，在UpdateBillCodeRule由编码规则统一控制</span></span><br><span class="line">        <span class="keyword">if</span> (!isHasItem &amp;&amp; autoCode) &#123;</span><br><span class="line">            codeTempDataCaches = checkUniqueCodeService.writeTempCode(bills, entity, holder.getBillContext(), holder.getParamMap());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//内存+redis检查</span></span><br><span class="line">        checkLocalUniqueService.checkUnionKeyObJVM(holder.getBillContext(), entity, checkUnionBO, bills, needRollList);</span><br><span class="line">        <span class="comment">//数据库检查 联合唯一性校验， 当校验参数为 null 用 is null 拼接条件</span></span><br><span class="line">        <span class="type">UniqueCheckWalker</span> <span class="variable">uniqueCheckWalker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UniqueCheckWalker</span>(AppContext.getPartitionContextData(entity, <span class="literal">true</span>), <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (!isHasItem) &#123;</span><br><span class="line">            checkDbUniqueService.checkUnionWithOutItem(holder, bills, entity, checkUnionBO.isCheckChild(), uniqueCheckWalker);</span><br><span class="line">            <span class="keyword">if</span> (autoCode) &#123;</span><br><span class="line">                checkUniqueCodeService.reWriteCode(codeTempDataCaches, bills, autoCode);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            checkDbUniqueService.checkUnionWithItem(holder.getBillContext(), bills, item, entity, uniqueCheckWalker);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != needRollList &amp;&amp; needRollList.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (TransactionSynchronizationManager.isActualTransactionActive()) &#123;</span><br><span class="line">                TransactionSynchronizationManager.registerSynchronization(<span class="keyword">new</span> <span class="title class_">DoExecuteAfterTransactionCompletion</span>(needRollList));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RuleExecuteResult</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="com-yonyou-ucf-mdd-ext-bill-rule-crud-SaveBillRule"><a href="#com-yonyou-ucf-mdd-ext-bill-rule-crud-SaveBillRule" class="headerlink" title="com.yonyou.ucf.mdd.ext.bill.rule.crud.SaveBillRule"></a>com.yonyou.ucf.mdd.ext.bill.rule.crud.SaveBillRule</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service(&quot;saveBillRule&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SaveBillRule</span> <span class="keyword">extends</span> <span class="title class_">AbstractCommonRule</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(SaveBillRule.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SaveBillRule</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ResubmitAnnotations</span></span><br><span class="line">    <span class="keyword">public</span> RuleExecuteResult <span class="title function_">execute</span><span class="params">(BillContext billContext, Map&lt;String, Object&gt; paramMap)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.executeCommon(billContext, paramMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> RuleExecuteResult <span class="title function_">executeCommon</span><span class="params">(BillContext billContext, Map&lt;String, Object&gt; paramMap)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        List&lt;BizObject&gt; bills = <span class="built_in">this</span>.getBills(billContext, paramMap);</span><br><span class="line">        <span class="type">Entity</span> <span class="variable">entity</span> <span class="operator">=</span> StringUtils.isBlank(billContext.getFullname()) ? <span class="literal">null</span> : IMetaUtils.entity(billContext.getFullname());</span><br><span class="line">        <span class="type">ServiceSupportHolder</span> <span class="variable">holder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServiceSupportHolder</span>(billContext, paramMap, bills, entity);</span><br><span class="line">        holder.setcBillNo(billContext.getBillnum());</span><br><span class="line">        <span class="built_in">this</span>.extendEnhance(holder);</span><br><span class="line">        <span class="type">IServiceSupportApi</span> <span class="variable">iServiceSupportApi</span> <span class="operator">=</span> (IServiceSupportApi)AppContext.getBean(SaveBillSupportService.class);</span><br><span class="line">        <span class="keyword">return</span> (RuleExecuteResult)iServiceSupportApi.execute(holder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">extendEnhance</span><span class="params">(ServiceSupportHolder holder)</span> &#123;</span><br><span class="line">        holder.getAttribute().setAttr(<span class="string">&quot;saveRealAutoCode&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### com.yonyou.ucf.mdd.support.abs.AbstractServiceSupport</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">execute</span><span class="params">(ServiceSupportHolder holder)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        beforeHandler(holder);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">resultHandler</span> <span class="operator">=</span> doExecute(holder);</span><br><span class="line">        afterExecute(holder, resultHandler);</span><br><span class="line">        <span class="keyword">return</span> resultHandler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> Object <span class="title function_">doExecute</span><span class="params">(ServiceSupportHolder holder)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### com.yonyou.ucf.mdd.support.support.SaveBillSupportService</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">doExecute</span><span class="params">(ServiceSupportHolder holder)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">IDoBillService</span> <span class="variable">iDoBillService</span> <span class="operator">=</span> getBeanDo(ServiceSupportStatic.Save.DO);</span><br><span class="line">        <span class="keyword">return</span> iDoBillService.doExecute(holder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">### com.yonyou.ucf.mdd.support.support.save.DoExecuteSaveBillService</span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> holder</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Seraph</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2021/5/2710:57 PM</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">doExecute</span><span class="params">(ServiceSupportHolder holder)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        List&lt;BizObject&gt; bills = holder.getBillList();</span><br><span class="line">        <span class="keyword">for</span> (BizObject bill : bills) &#123;</span><br><span class="line">            checkRelevantRuleVerify(holder,bill);</span><br><span class="line">            executeOneBill(holder, bill);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RuleExecuteResult</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> holder</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bill</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Seraph</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2021/5/2710:57 PM</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">executeOneBill</span><span class="params">(ServiceSupportHolder holder, BizObject bill)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">BillContext</span> <span class="variable">billContext</span> <span class="operator">=</span> holder.getBillContext();</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isInsert</span> <span class="operator">=</span> EntityStatus.Insert == bill.getEntityStatus() ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line">        setAudit(isInsert, bill, holder.getEntity().fullname());</span><br><span class="line">        BarCodeSupport.generateBarCode(billContext, holder.getEntity(), bill);<span class="comment">//处理条形码</span></span><br><span class="line">        setStatusInfoWhenInsert(holder,Status.newopen, bill, isInsert); <span class="comment">//设置单据状态</span></span><br><span class="line">        dealSupportBpm(bill, billContext, isInsert);<span class="comment">//处理工作流</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> getAndDealCode(holder, billContext, bill, isInsert); <span class="comment">//获取处置编码规则</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//保存业务逻辑</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> saveBillServiceImpl.executeSave(billContext, bill, holder.getParamMap(), holder.getEntity(), isInsert);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//重置编码规则</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != code) &#123;</span><br><span class="line">            bill.set(<span class="string">&quot;code&quot;</span>, code);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">BillSaveResult</span> <span class="variable">billSaveResult</span> <span class="operator">=</span> (BillSaveResult) result;</span><br><span class="line">        <span class="type">String</span> <span class="variable">partitionWhereCondition</span> <span class="operator">=</span> saveBillServiceImpl.buildQueryWhere4UpdateTree(holder.getEntity(), billContext); <span class="comment">//构建扩展分词条件</span></span><br><span class="line">        updateTree(bill, billContext.getFullname(), AppContext.getTenantId(), billSaveResult, partitionWhereCondition);    <span class="comment">//更新树</span></span><br><span class="line"><span class="comment">//        sendTimeLineSnapshot(billContext, bill, holder.getParamMap(), isInsert);  //新增时上传时间轴快照</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### com.yonyou.ucf.mdd.ext.bill.service.SaveBillServiceImpl</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> SaveBillServiceImpl#executeSave(com.yonyou.ucf.mdd.ext.model.BillContext, org.imeta.orm.base.BizObject, java.util.Map, org.imeta.core.model.Entity, java.lang.Boolean)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> InsertSqlExecutor#execute(org.imeta.core.model.Entity, java.util.List)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> UpdateSqlExecutor#execute(org.imeta.core.model.Entity, java.util.List)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     *      execute insert or update with _statis value &lt;code&gt;String&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> billContext billContext is one thread context &#123;<span class="doctag">@link</span> BillContext&#125; in the variable has props  context &#123;<span class="doctag">@link</span> Map&#125; &lt;code&gt;null&lt;/code&gt;save Resubmit key and other So.</span></span><br><span class="line"><span class="comment">     *      *             fullname : metaUri of metaServer  is the index of entity of meta</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bill  business data in &#123;<span class="doctag">@link</span> com.yonyou.ucf.mdd.ext.bill.dto.BillDataDto&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> paramMap Singleton instance in rule china &#123;<span class="doctag">@link</span> Map&#125; ,the request DTO in paramMap when in rule ,the DTO is instance of &#123;<span class="doctag">@link</span> BizObject&#125; Array</span></span><br><span class="line"><span class="comment">     *      *          when complete this rule  set paramMap for return</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> entity meta entity in metaServer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> isInert _statis value &lt;code&gt;String&lt;/code&gt;  insert or update</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> execute result</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">executeSave</span><span class="params">(BillContext billContext, BizObject bill, Map&lt;String, Object&gt; paramMap, Entity entity, Boolean isInert)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (isInert) &#123;</span><br><span class="line">                <span class="keyword">return</span> executeInsert(billContext, bill, paramMap, entity);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> executeUpdate(billContext, bill, entity);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (MddZeroResultMsgException zr)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MddVouchStateMsgException</span>(MsgExceptionCode.BILL_CHANGED_PLEASE_REFRESH);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> SaveBillServiceImpl#executeSave(com.yonyou.ucf.mdd.ext.model.BillContext, org.imeta.orm.base.BizObject, java.util.Map, org.imeta.core.model.Entity, java.lang.Boolean)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> InsertSqlExecutor#execute(org.imeta.core.model.Entity, java.util.List)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     *      execute insert or update with _statis value &lt;code&gt;String&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> billContext billContext is one thread context &#123;<span class="doctag">@link</span> BillContext&#125; in the variable has props  context &#123;<span class="doctag">@link</span> Map&#125; &lt;code&gt;null&lt;/code&gt;save Resubmit key and other So.</span></span><br><span class="line"><span class="comment">     *      *             fullname : metaUri of metaServer  is the index of entity of meta</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bill  business data in &#123;<span class="doctag">@link</span> com.yonyou.ucf.mdd.ext.bill.dto.BillDataDto&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> paramMap Singleton instance in rule china &#123;<span class="doctag">@link</span> Map&#125; ,the request DTO in paramMap when in rule ,the DTO is instance of &#123;<span class="doctag">@link</span> BizObject&#125; Array</span></span><br><span class="line"><span class="comment">     *      *          when complete this rule  set paramMap for return</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> entity meta entity in metaServer</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> execute result</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object <span class="title function_">executeInsert</span><span class="params">(BillContext billContext, BizObject bill, Map&lt;String, Object&gt; paramMap, Entity entity)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        fillPubts4Insert(bill);</span><br><span class="line">        <span class="comment">//开始递归插入数据</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InsertSqlExecutor</span>(AppContext.getSqlSession()).execute(entity, bill);</span><br><span class="line">        <span class="comment">//check project is open config of timeline and this bill is opened in timeline server</span></span><br><span class="line">        <span class="comment">//sendTimeLineSnapshot(billContext, bill, paramMap);</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BillSaveResult</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### com.yonyou.ucf.mdd.ext.dao.meta.crud.InsertSqlExecutor</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 元数据crud封装的insert实现</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Bob</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;DuplicatedCode&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InsertSqlExecutor</span> <span class="keyword">extends</span> <span class="title class_">MetaDaoSupport</span> &#123;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">public</span> &lt;T <span class="keyword">extends</span> <span class="title class_">BizObject</span>&gt; <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Entity entity, T data)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        List&lt;T&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;T&gt;(<span class="number">1</span>);</span><br><span class="line">        list.add(data);</span><br><span class="line">        execute(entity, list, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> &lt;T <span class="keyword">extends</span> <span class="title class_">BizObject</span>&gt; <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Entity entity, List&lt;T&gt; list, <span class="type">boolean</span> isPartition)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">true</span>) &#123;<span class="comment">//强制切换到InsertSqlExecutorNew</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InsertSqlExecutorNew</span>(getSqlSession()).execute(entity, list);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        printLogWHenEntityNull(entity, list);</span><br><span class="line">        <span class="comment">//传递多语开关配置到元数据上下文</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">fullname</span> <span class="operator">=</span> entity.fullname();</span><br><span class="line">        MddMultilingualUtil.setEnableI18n2Imeta();</span><br><span class="line">        <span class="comment">//提前将insert插入，为yTenant 判断做准备</span></span><br><span class="line">        <span class="type">EntityStatusWalker</span> <span class="variable">statusWalker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EntityStatusWalker</span>();</span><br><span class="line">        <span class="keyword">for</span> (BizObject bill : list) &#123;</span><br><span class="line">            bill.setEntityStatus(EntityStatus.Insert);</span><br><span class="line">            ObjectWalker.walk(statusWalker, bill, fullname);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (isPartition) &#123;</span><br><span class="line">            setTenantandCorpWhenSave(entity, list);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">InsertCheckWalker</span> <span class="variable">insertCheck</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InsertCheckWalker</span>();</span><br><span class="line">        insertCheck.setNext(<span class="keyword">new</span> <span class="title class_">FormatCheckWalker</span>());</span><br><span class="line">        <span class="comment">// 构造SQL语句</span></span><br><span class="line">        SqlBuilder&lt;BizObject&gt; builder = <span class="keyword">new</span> <span class="title class_">InsertSqlBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (BizObject bill : list) &#123;</span><br><span class="line">            ObjectHierarchyBuilder.build(bill, entity);</span><br><span class="line">            ObjectFullWalker.walk(insertCheck, bill, fullname);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                batchSaveExecute(builder.build(entity, bill));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">                logger.error(throwable.getMessage());</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MddOrmErrorException</span>(throwable.getMessage(),throwable);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>





<h5 id="com-yonyou-ucf-mdd-ext-pub-rule-SaveBusinessLogRule"><a href="#com-yonyou-ucf-mdd-ext-pub-rule-SaveBusinessLogRule" class="headerlink" title="com.yonyou.ucf.mdd.ext.pub.rule.SaveBusinessLogRule"></a>com.yonyou.ucf.mdd.ext.pub.rule.SaveBusinessLogRule</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Order(2147483647)</span></span><br><span class="line"><span class="meta">@Service(&quot;saveBusinessLogRule&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SaveBusinessLogRule</span> <span class="keyword">extends</span> <span class="title class_">AbstractCommonRule</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(SaveBusinessLogRule.class);</span><br><span class="line">    <span class="keyword">private</span> ExecutorService taskExecutor;</span><br><span class="line">    <span class="keyword">private</span> AuditLogSender auditLogSender;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SaveBusinessLogRule</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> RuleExecuteResult <span class="title function_">execute</span><span class="params">(<span class="keyword">final</span> BillContext billContext, <span class="keyword">final</span> Map&lt;String, Object&gt; paramMap)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> List&lt;BizObject&gt; bills = <span class="built_in">this</span>.getCloneBills(billContext, paramMap);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> InvocationInfoProxy.getYhtAccessToken();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">clientIp</span> <span class="operator">=</span> (String)InvocationInfoProxy.getExtendAttribute(<span class="string">&quot;clientIp&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">serviceCode</span> <span class="operator">=</span> (String)InvocationInfoProxy.getExtendAttribute(<span class="string">&quot;serviceCode&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(serviceCode)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">BillDataDto</span> <span class="variable">billDataDto</span> <span class="operator">=</span> (BillDataDto)<span class="built_in">this</span>.getParam(paramMap);</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> != billDataDto) &#123;</span><br><span class="line">                    Map&lt;String, Object&gt; externalData = BillUtils.getExternalData(billDataDto);</span><br><span class="line">                    serviceCode = (String)externalData.get(<span class="string">&quot;serviceCode&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception var10) &#123;</span><br><span class="line">                <span class="keyword">if</span> (logger.isErrorEnabled()) &#123;</span><br><span class="line">                    logger.error(<span class="string">&quot;从BillDataDto扩展参数中获取serviceCode失败&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!CollectionUtils.isEmpty(bills)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (TransactionSynchronizationManager.isSynchronizationActive()) &#123;</span><br><span class="line">                TransactionSynchronizationManager.registerSynchronization(<span class="keyword">new</span> <span class="title class_">TransactionSynchronizationAdapter</span>() &#123;</span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(<span class="type">int</span> status)</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="number">0</span> == status) &#123;</span><br><span class="line">                            SaveBusinessLogRule.<span class="built_in">this</span>.getTaskExecutor().execute(() -&gt; &#123;</span><br><span class="line">                                SaveBusinessLogRule.<span class="built_in">this</span>.executeAsync(billContext, paramMap, token, clientIp, bills, serviceCode);</span><br><span class="line">                            &#125;);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                logger.warn(<span class="string">&quot;业务日志异步执行，未开启事务。&quot;</span>);</span><br><span class="line">                <span class="built_in">this</span>.getTaskExecutor().execute(() -&gt; &#123;</span><br><span class="line">                    <span class="built_in">this</span>.executeAsync(billContext, paramMap, token, clientIp, bills, serviceCode);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">JsonFormatter</span> <span class="variable">formatter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JsonFormatter</span>(BizContext.getMetaRepository());</span><br><span class="line">            <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> formatter.toJson(bills, billContext.getFullname(), <span class="literal">false</span>, <span class="number">32</span>).toString();</span><br><span class="line">            logger.error(<span class="string">&quot;业务日志getCloneBills为空: 参数---billContext:&#123;&#125;,bills:&#123;&#125;&quot;</span>, JSONObject.toJSONString(billContext), json);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RuleExecuteResult</span>();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h5 id="com-yonyou-ucf-mdd-ext-bill-rule-biz-RefreshTsRule"><a href="#com-yonyou-ucf-mdd-ext-bill-rule-biz-RefreshTsRule" class="headerlink" title="com.yonyou.ucf.mdd.ext.bill.rule.biz.RefreshTsRule"></a>com.yonyou.ucf.mdd.ext.bill.rule.biz.RefreshTsRule</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service(&quot;refreshTsRule&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RefreshTsRule</span> <span class="keyword">extends</span> <span class="title class_">AbstractCommonRule</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RefreshTsRule</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> RuleExecuteResult <span class="title function_">execute</span><span class="params">(BillContext billContext, Map&lt;String, Object&gt; paramMap)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">fullname</span> <span class="operator">=</span> billContext.getFullname();</span><br><span class="line">        List&lt;BizObject&gt; bills = <span class="built_in">this</span>.getBills(billContext, paramMap);</span><br><span class="line">        <span class="type">String</span> <span class="variable">refreshField</span> <span class="operator">=</span> (String)<span class="built_in">this</span>.getParam(paramMap, <span class="string">&quot;refreshField&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != bills &amp;&amp; bills.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">Iterator</span> <span class="variable">var6</span> <span class="operator">=</span> bills.iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(var6.hasNext()) &#123;</span><br><span class="line">                <span class="type">BizObject</span> <span class="variable">bill</span> <span class="operator">=</span> (BizObject)var6.next();</span><br><span class="line">                BillInfoUtils.refreshTs(fullname, bill, refreshField, AppContext.getTenantId());</span><br><span class="line">                <span class="type">DataCleanWalker</span> <span class="variable">dataCleanWalker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataCleanWalker</span>();</span><br><span class="line">                dataCleanWalker.setNext(<span class="keyword">new</span> <span class="title class_">ParallelTableWalker</span>());</span><br><span class="line">                ObjectFullWalker.walk(dataCleanWalker, bill, fullname);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            LogicDeleteHelper.removeLogicDelete(fullname, bills);</span><br><span class="line">            <span class="keyword">if</span> (bills.size() == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.putParam(paramMap, <span class="string">&quot;return&quot;</span>, bills.get(<span class="number">0</span>));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.putParam(paramMap, <span class="string">&quot;return&quot;</span>, bills);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RuleExecuteResult</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h5 id="com-yonyou-common-bizflow-rule-BizFlowWriteBackRule低代码回写规则"><a href="#com-yonyou-common-bizflow-rule-BizFlowWriteBackRule低代码回写规则" class="headerlink" title="com.yonyou.common.bizflow.rule.BizFlowWriteBackRule低代码回写规则"></a>com.yonyou.common.bizflow.rule.BizFlowWriteBackRule低代码回写规则</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> RuleExecuteResult <span class="title function_">execute</span><span class="params">(BillContext billContext, Map&lt;String, Object&gt; paramMap)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">RuleExecuteResult</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RuleExecuteResult</span>();</span><br><span class="line">    LogUtil.log(<span class="string">&quot;业务流：BizFlowWriteBackRule start! &quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.doWriteBack(billContext, paramMap);</span><br><span class="line">        LogUtil.log(<span class="string">&quot;业务流：BizFlowWriteBackRule end! &quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var5) &#123;</span><br><span class="line">        LogUtil.log(<span class="string">&quot;业务流：BizFlowWriteBackRule error!&quot;</span>, var5);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doWriteBack</span><span class="params">(BillContext billContext, Map&lt;String, Object&gt; paramMap)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">BillDataDto</span> <span class="variable">reqDto</span> <span class="operator">=</span> (BillDataDto)paramMap.get(<span class="string">&quot;param&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">domain</span> <span class="operator">=</span> BizFlowUtil.getDomain(billContext);</span><br><span class="line">    <span class="type">String</span> <span class="variable">billNum</span> <span class="operator">=</span> BizFlowUtil.getBillNum(reqDto);</span><br><span class="line">    <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> BizFlowUtil.getTenantId();</span><br><span class="line">    <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> InvocationInfoProxy.getYhtAccessToken();</span><br><span class="line">    <span class="type">String</span> <span class="variable">operate</span> <span class="operator">=</span> billContext.getAction();</span><br><span class="line">    <span class="type">String</span> <span class="variable">subId</span> <span class="operator">=</span> billContext.getSubid();</span><br><span class="line">    List&lt;JSONObject&gt; bills = BizFlowUtil.getBills(reqDto);</span><br><span class="line">    <span class="type">Iterator</span> <span class="variable">var11</span> <span class="operator">=</span> bills.iterator();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(var11.hasNext()) &#123;</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">bill</span> <span class="operator">=</span> (JSONObject)var11.next();</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.noNeedWriteBackConvert(bill, domain, operate)) &#123;</span><br><span class="line">            LogUtil.log(<span class="string">&quot;业务流：BizFlowWriteBackRule skip bill: &quot;</span> + bill);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LogUtil.log(<span class="string">&quot;业务流：BizFlowWriteBackRule bill: &quot;</span> + bill);</span><br><span class="line">            <span class="type">ConvertParam</span> <span class="variable">convertParam</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConvertParam</span>();</span><br><span class="line">            convertParam.setTenantId(tenantId);</span><br><span class="line">            convertParam.setBillNum(billNum);</span><br><span class="line">            convertParam.setBillId(bill.getString(<span class="string">&quot;id&quot;</span>));</span><br><span class="line">            convertParam.addBill(bill);</span><br><span class="line">            convertParam.setToken(token);</span><br><span class="line">            convertParam.setOperate(operate);</span><br><span class="line">            convertParam.setSubId(subId);</span><br><span class="line">            convertParam.setDomain(domain);</span><br><span class="line">            LogUtil.log(<span class="string">&quot;业务流：BizFlowWriteBackRule convert PARAM: &quot;</span> + JSON.toJSONString(convertParam));</span><br><span class="line">            <span class="type">ConvertResult</span> <span class="variable">convertResult</span> <span class="operator">=</span> BizFlowUtil.doWriteBackConvert(convertParam);</span><br><span class="line">            LogUtil.log(<span class="string">&quot;业务流：BizFlowWriteBackRule convert result: &quot;</span> + JSON.toJSONString(convertResult));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">noNeedWriteBackConvert</span><span class="params">(JSONObject bill, String domain, String action)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="string">&quot;audit&quot;</span>.equalsIgnoreCase(action) &amp;&amp; !<span class="string">&quot;unaudit&quot;</span>.equalsIgnoreCase(action)) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">flowId</span> <span class="operator">=</span> ObjectUtil.getString(bill, <span class="string">&quot;bizFlowId&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;developplatform&quot;</span>.equalsIgnoreCase(domain) &amp;&amp; ObjectUtil.isEmpty(flowId)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">writeBackSign</span> <span class="operator">=</span> ObjectUtil.getString(bill, <span class="string">&quot;bizFlowWriteBackSign&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;bizFlowWriteBackSign&quot;</span>.equals(writeBackSign);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="com-yonyou-common-bizflow-rule-BizFlowPushRule"><a href="#com-yonyou-common-bizflow-rule-BizFlowPushRule" class="headerlink" title="com.yonyou.common.bizflow.rule.BizFlowPushRule"></a>com.yonyou.common.bizflow.rule.BizFlowPushRule</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(BizFlowPushRule.class);</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">IYpdBillDataService iYpdBillDataService;</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">MdfTemplateRunTimeServiceImpl mdfTemplateRunTimeService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">BizFlowPushRule</span><span class="params">()</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> RuleExecuteResult <span class="title function_">execute</span><span class="params">(BillContext billContext, Map&lt;String, Object&gt; paramMap)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">BizFlowRuleResult</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BizFlowRuleResult</span>();</span><br><span class="line">    LogUtil.log(<span class="string">&quot;业务流：bizFlowPush start! &quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">BillDataDto</span> <span class="variable">reqDto</span> <span class="operator">=</span> (BillDataDto)paramMap.get(<span class="string">&quot;param&quot;</span>);</span><br><span class="line">        Map&lt;String, Object&gt; cusMap = reqDto.getCustMap();</span><br><span class="line">        <span class="type">String</span> <span class="variable">billNum</span> <span class="operator">=</span> BizFlowUtil.removeSuffix(reqDto.getBillnum());</span><br><span class="line">        List&lt;JSONObject&gt; bills = BizFlowUtil.getBills(reqDto);</span><br><span class="line">        <span class="type">String</span> <span class="variable">domain</span> <span class="operator">=</span> BizFlowUtil.getDomain(billContext);</span><br><span class="line">        <span class="type">ConvertResult</span> <span class="variable">convertResult</span> <span class="operator">=</span> BizFlowUtil.doPush(billNum, bills, cusMap, billContext.getSubid(), domain, billContext.getAction());</span><br><span class="line">        <span class="keyword">if</span> (Boolean.TRUE.equals(AppContext.getCurrentUser().getNewArch())) &#123;</span><br><span class="line">            <span class="built_in">this</span>.busObjToUIData(billContext, paramMap, convertResult);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        paramMap.put(<span class="string">&quot;bizFlowReturn&quot;</span>, convertResult);</span><br><span class="line">        result.setConvertResult(convertResult);</span><br><span class="line">        LogUtil.log(<span class="string">&quot;业务流：bizFlowPush end! &quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var10) &#123;</span><br><span class="line">        LogUtil.log(<span class="string">&quot;业务流：bizFlowPush error!&quot;</span>, var10);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230203141336848.png" alt="image-20230203141336848"></p>
<h5 id="com-yonyou-business-StockServiceTccRule"><a href="#com-yonyou-business-StockServiceTccRule" class="headerlink" title="com.yonyou.business.StockServiceTccRule"></a>com.yonyou.business.StockServiceTccRule</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component(&quot;stockServiceTccRule&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StockSer</span>  viceTccRule <span class="keyword">extends</span> <span class="title class_">AbstractCommonRule</span> <span class="keyword">implements</span> <span class="title class_">ITccRule</span> &#123;</span><br><span class="line"><span class="comment">// private static final String URI = &quot;XMFYGJ102.XMFYGJ102.bookstock_yts&quot;;</span></span><br><span class="line">   <span class="comment">//日常</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">URI</span> <span class="operator">=</span> <span class="string">&quot;GT52146AT26.GT52146AT26.bookstock_yts&quot;</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PRODUCTID</span> <span class="operator">=</span> <span class="string">&quot;sproductid&quot;</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ITOTAL</span> <span class="operator">=</span> <span class="string">&quot;itotal&quot;</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">INUMBER</span> <span class="operator">=</span> <span class="string">&quot;inumber&quot;</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">IONWAY</span> <span class="operator">=</span> <span class="string">&quot;ionway&quot;</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SNAME</span> <span class="operator">=</span> <span class="string">&quot;sname&quot;</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(StockServiceTccRule.class);</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">    IOrderService orderService;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> RuleExecuteResult <span class="title function_">execute</span><span class="params">(BillContext billContext, Map&lt;String, Object&gt; map)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      logger.info(<span class="string">&quot;StockServiceRule running!&quot;</span>);</span><br><span class="line">      List&lt;BizObject&gt; bills = <span class="built_in">this</span>.getBills(billContext, map);</span><br><span class="line">      <span class="type">boolean</span> <span class="variable">hasTccFlag</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">for</span> (BizObject bizObject : bills) &#123;</span><br><span class="line">         <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> bizObject.get(SNAME);</span><br><span class="line">         <span class="keyword">if</span> (!StringUtils.isEmpty(name) &amp;&amp; name.toLowerCase(Locale.ENGLISH).indexOf(<span class="string">&quot;iris&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">            hasTccFlag = <span class="literal">true</span>;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span> (BizObject bizObject : bills) &#123;</span><br><span class="line">         <span class="type">String</span> <span class="variable">ProductId</span> <span class="operator">=</span> bizObject.get(PRODUCTID);</span><br><span class="line">         <span class="keyword">if</span> (<span class="literal">null</span> == ProductId) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;商品ID不能为空&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">// 下单数量</span></span><br><span class="line">         <span class="type">Integer</span> <span class="variable">num</span> <span class="operator">=</span> bizObject.get(INUMBER);</span><br><span class="line">         <span class="keyword">if</span> (<span class="literal">null</span> == num || num &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;数量不能为空或小于0&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="type">BizObject</span> <span class="variable">stock</span> <span class="operator">=</span> MetaDaoHelper.findById(URI, ProductId);</span><br><span class="line">         stock.put(<span class="string">&quot;_status&quot;</span>, EntityStatus.Update);</span><br><span class="line">         <span class="comment">// tcc模式，正向先扣库存</span></span><br><span class="line">         <span class="type">Integer</span> <span class="variable">oldItotal</span> <span class="operator">=</span> (Integer)stock.get(ITOTAL);</span><br><span class="line">         <span class="keyword">if</span> (num &gt; oldItotal) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;库存不足&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         stock.put(ITOTAL, oldItotal - num);</span><br><span class="line">         <span class="comment">// 增加在途库存</span></span><br><span class="line">         <span class="type">Integer</span> <span class="variable">oldIonway</span> <span class="operator">=</span> (Integer)stock.get(IONWAY);</span><br><span class="line">         stock.put(IONWAY, oldIonway + num);</span><br><span class="line">         </span><br><span class="line">         <span class="type">Transaction</span> <span class="variable">yts</span> <span class="operator">=</span> YtsContext.currentTransaction();</span><br><span class="line">         <span class="keyword">if</span> (<span class="literal">null</span> != yts) &#123;</span><br><span class="line">            stock.put(<span class="string">&quot;gtxid&quot;</span>, yts.getGtxId());</span><br><span class="line">            stock.put(<span class="string">&quot;ptxid&quot;</span>, yts.getPtxId());</span><br><span class="line">            stock.put(<span class="string">&quot;txid&quot;</span>, yts.getTxId());</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="comment">//将sorderid存入redis</span></span><br><span class="line">         <span class="type">String</span> <span class="variable">sorderid</span> <span class="operator">=</span> bizObject.get(<span class="string">&quot;sorderid&quot;</span>);</span><br><span class="line">         redisTemplate.opsForValue().set(sorderid,yts.getGtxId(),<span class="number">30l</span>, TimeUnit.MINUTES);</span><br><span class="line">         </span><br><span class="line">         MetaDaoHelper.update(URI, stock);</span><br><span class="line">         </span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (hasTccFlag) &#123;</span><br><span class="line">         <span class="type">TourOrder</span> <span class="variable">order</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TourOrder</span>();</span><br><span class="line">         order.setUserId(UUID.randomUUID().toString());</span><br><span class="line">         order.setTourOrderId(UUID.randomUUID().toString());</span><br><span class="line">         order.setOrderName(<span class="string">&quot;订单号:&quot;</span> + order.getOrderName());</span><br><span class="line">         order.setUserName(<span class="string">&quot;yongyou&quot;</span>);</span><br><span class="line"></span><br><span class="line">         <span class="type">TourOrder</span> <span class="variable">norder</span> <span class="operator">=</span> orderService.sagas(order);</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;order: &#123;&#125;&quot;</span>, JSON.toJSONString(norder));</span><br><span class="line">         &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            logger.warn(<span class="string">&quot;toJSONString error &quot;</span>, e);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>  <span class="keyword">new</span> <span class="title class_">RuleExecuteResult</span>();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> RuleExecuteResult <span class="title function_">confirm</span><span class="params">(BillContext billContext, Map&lt;String, Object&gt; paramMap)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      logger.info(<span class="string">&quot;StockServiceRule rollback!&quot;</span>);</span><br><span class="line">      List&lt;BizObject&gt; bills = <span class="built_in">this</span>.getBills(billContext, paramMap);</span><br><span class="line">      <span class="keyword">for</span> (BizObject bizObject : bills) &#123;</span><br><span class="line">         <span class="type">String</span> <span class="variable">ProductId</span> <span class="operator">=</span> bizObject.get(PRODUCTID);</span><br><span class="line">         <span class="keyword">if</span> (<span class="literal">null</span> == ProductId) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;商品ID不能为空&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">// 下单数量</span></span><br><span class="line">         <span class="type">Integer</span> <span class="variable">num</span> <span class="operator">=</span> bizObject.get(INUMBER);</span><br><span class="line">         <span class="keyword">if</span> (<span class="literal">null</span> == num || num &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;数量不能为空或小于0&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">// tcc模式成功，减去在途库存,交易完成</span></span><br><span class="line">         <span class="type">BizObject</span> <span class="variable">stock</span> <span class="operator">=</span> MetaDaoHelper.findById(URI, ProductId);</span><br><span class="line">         stock.put(<span class="string">&quot;_status&quot;</span>, EntityStatus.Update);</span><br><span class="line">         <span class="type">Integer</span> <span class="variable">oldIonway</span> <span class="operator">=</span> (Integer)stock.get(IONWAY);</span><br><span class="line">         stock.put(IONWAY, oldIonway - num);</span><br><span class="line">         </span><br><span class="line">         MetaDaoHelper.update(URI, stock);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RuleExecuteResult</span>();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> RuleExecuteResult <span class="title function_">cancel</span><span class="params">(BillContext billContext, Map&lt;String, Object&gt; map)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      logger.info(<span class="string">&quot;StockServiceRule rollback!&quot;</span>);</span><br><span class="line">      List&lt;BizObject&gt; bills = <span class="built_in">this</span>.getBills(billContext, map);</span><br><span class="line">      <span class="keyword">for</span> (BizObject bizObject : bills) &#123;</span><br><span class="line">         <span class="type">String</span> <span class="variable">ProductId</span> <span class="operator">=</span> bizObject.get(PRODUCTID);</span><br><span class="line">         <span class="keyword">if</span> (<span class="literal">null</span> == ProductId) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;商品ID不能为空&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">// 下单数量</span></span><br><span class="line">         <span class="type">Integer</span> <span class="variable">num</span> <span class="operator">=</span> bizObject.get(INUMBER);</span><br><span class="line">         <span class="keyword">if</span> (<span class="literal">null</span> == num || num &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;数量不能为空或小于0&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">// tcc模式失败，将在途库存加回可用库存</span></span><br><span class="line">         <span class="type">BizObject</span> <span class="variable">stock</span> <span class="operator">=</span> MetaDaoHelper.findById(URI, ProductId);</span><br><span class="line">         stock.put(<span class="string">&quot;_status&quot;</span>, EntityStatus.Update);</span><br><span class="line">         <span class="type">Integer</span> <span class="variable">oldItotal</span> <span class="operator">=</span> (Integer)stock.get(ITOTAL);</span><br><span class="line">         stock.put(ITOTAL, oldItotal + num);</span><br><span class="line">         </span><br><span class="line">         <span class="type">Integer</span> <span class="variable">oldIonway</span> <span class="operator">=</span> (Integer)stock.get(IONWAY);</span><br><span class="line">         stock.put(IONWAY, oldIonway - num);</span><br><span class="line">         </span><br><span class="line">         MetaDaoHelper.update(URI, stock);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RuleExecuteResult</span>();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="com-yonyou-business-PayServiceTccRule"><a href="#com-yonyou-business-PayServiceTccRule" class="headerlink" title="com.yonyou.business.PayServiceTccRule"></a>com.yonyou.business.PayServiceTccRule</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component(&quot;payServiceTccRule&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayServiceTccRule</span> <span class="keyword">extends</span> <span class="title class_">AbstractCommonRule</span> <span class="keyword">implements</span> <span class="title class_">ITccRule</span> &#123;</span><br><span class="line"><span class="comment">// private static final String URI = &quot;XMFYGJ103.XMFYGJ103.bookpay_yts&quot;;</span></span><br><span class="line">   <span class="comment">//日常</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">URI</span> <span class="operator">=</span> <span class="string">&quot;GT52131AT25.GT52131AT25.bookpay_yts&quot;</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SUSERID</span> <span class="operator">=</span> <span class="string">&quot;sbuyer&quot;</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FTOTAL</span> <span class="operator">=</span> <span class="string">&quot;ftotal&quot;</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FAVAILABLE</span> <span class="operator">=</span> <span class="string">&quot;favailable&quot;</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FONWAY</span> <span class="operator">=</span> <span class="string">&quot;fonway&quot;</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SNAME</span> <span class="operator">=</span> <span class="string">&quot;sname&quot;</span>;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   IOrderService orderService;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(PayServiceTccRule.class);</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> RuleExecuteResult <span class="title function_">execute</span><span class="params">(BillContext billContext, Map&lt;String, Object&gt; map)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      logger.info(<span class="string">&quot;PayServiceRule running!&quot;</span>);</span><br><span class="line">      List&lt;BizObject&gt; bills = <span class="built_in">this</span>.getBills(billContext, map);</span><br><span class="line">      <span class="type">boolean</span> <span class="variable">hasTccFlag</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">for</span> (BizObject bizObject : bills) &#123;</span><br><span class="line">         <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> bizObject.get(SNAME);</span><br><span class="line">         <span class="keyword">if</span> (!StringUtils.isEmpty(name) &amp;&amp; name.toLowerCase(Locale.ENGLISH).indexOf(<span class="string">&quot;tcc&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">            hasTccFlag = <span class="literal">true</span>;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/*if(hasTccFlag) &#123;</span></span><br><span class="line"><span class="comment">         TourOrder order = new TourOrder();</span></span><br><span class="line"><span class="comment">         order.setUserId(UUID.randomUUID().toString());</span></span><br><span class="line"><span class="comment">         order.setTourOrderId(UUID.randomUUID().toString());</span></span><br><span class="line"><span class="comment">         order.setOrderName(&quot;订单号:&quot; + order.getOrderName());</span></span><br><span class="line"><span class="comment">         order.setUserName(&quot;yongyou&quot;);</span></span><br><span class="line"><span class="comment">         orderService.tcc(order);</span></span><br><span class="line"><span class="comment">      &#125;*/</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (BizObject bizObject : bills) &#123;</span><br><span class="line">         <span class="comment">// 账户</span></span><br><span class="line">         <span class="type">String</span> <span class="variable">UserId</span> <span class="operator">=</span> bizObject.get(SUSERID);</span><br><span class="line">         <span class="keyword">if</span> (<span class="literal">null</span> == UserId) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;账户ID不能为空&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">// 待支付金额</span></span><br><span class="line">         <span class="type">BigDecimal</span> <span class="variable">total</span> <span class="operator">=</span> bizObject.get(FTOTAL);</span><br><span class="line">         <span class="keyword">if</span> (<span class="literal">null</span> == total || total.floatValue() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;支付金额不能为空或小于0&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="type">BizObject</span> <span class="variable">pay</span> <span class="operator">=</span> MetaDaoHelper.findById(URI, UserId);</span><br><span class="line">         pay.put(<span class="string">&quot;_status&quot;</span>, EntityStatus.Update);</span><br><span class="line">         <span class="comment">// 账户可用金额</span></span><br><span class="line">         <span class="type">BigDecimal</span> <span class="variable">oldFavailable</span> <span class="operator">=</span>  pay.get(FAVAILABLE);</span><br><span class="line">         <span class="keyword">if</span> (total.floatValue() &gt; oldFavailable.floatValue()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;当前账户余额不足&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">          </span><br><span class="line">         pay.put(FAVAILABLE, oldFavailable.subtract(total));</span><br><span class="line">         <span class="comment">// 账户在途金额，增加待付金额</span></span><br><span class="line">         <span class="type">BigDecimal</span> <span class="variable">oldOnway</span> <span class="operator">=</span>  pay.get(FONWAY);</span><br><span class="line">         pay.put(FONWAY, oldOnway.add(total));</span><br><span class="line">         </span><br><span class="line">         <span class="type">Transaction</span> <span class="variable">yts</span> <span class="operator">=</span> YtsContext.currentTransaction();</span><br><span class="line">         <span class="keyword">if</span> (<span class="literal">null</span> != yts) &#123;</span><br><span class="line">            pay.put(<span class="string">&quot;gtxid&quot;</span>, yts.getGtxId());</span><br><span class="line">            pay.put(<span class="string">&quot;ptxid&quot;</span>, yts.getPtxId());</span><br><span class="line">            pay.put(<span class="string">&quot;txid&quot;</span>, yts.getTxId());</span><br><span class="line">         &#125;</span><br><span class="line">         MetaDaoHelper.update(URI, pay);    </span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span>  <span class="keyword">new</span> <span class="title class_">RuleExecuteResult</span>();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> RuleExecuteResult <span class="title function_">confirm</span><span class="params">(BillContext billContext, Map&lt;String, Object&gt; map)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      logger.info(<span class="string">&quot;PayServiceRule rollback!&quot;</span>);</span><br><span class="line">      List&lt;BizObject&gt; bills = <span class="built_in">this</span>.getBills(billContext, map);</span><br><span class="line">      <span class="keyword">for</span> (BizObject bizObject : bills) &#123;</span><br><span class="line">         <span class="comment">// 账户</span></span><br><span class="line">         <span class="type">String</span> <span class="variable">UserId</span> <span class="operator">=</span> bizObject.get(SUSERID);</span><br><span class="line">         <span class="keyword">if</span> (<span class="literal">null</span> == UserId) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;账户ID不能为空&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">// 待支付金额</span></span><br><span class="line">         <span class="type">BigDecimal</span> <span class="variable">total</span> <span class="operator">=</span> bizObject.get(FTOTAL);</span><br><span class="line">         <span class="keyword">if</span> (<span class="literal">null</span> == total || total.floatValue() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;支付金额不能为空或小于0&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="type">BizObject</span> <span class="variable">pay</span> <span class="operator">=</span> MetaDaoHelper.findById(URI, UserId);</span><br><span class="line">         pay.put(<span class="string">&quot;_status&quot;</span>, EntityStatus.Update);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// 成功则把在途金额减掉，交易完成    </span></span><br><span class="line">         <span class="type">BigDecimal</span> <span class="variable">oldOnway</span> <span class="operator">=</span>  pay.get(FONWAY);</span><br><span class="line">         pay.put(FONWAY, oldOnway.subtract(total));</span><br><span class="line">         </span><br><span class="line">         MetaDaoHelper.update(URI, pay);    </span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RuleExecuteResult</span>();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> RuleExecuteResult <span class="title function_">cancel</span><span class="params">(BillContext billContext, Map&lt;String, Object&gt; map)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      logger.info(<span class="string">&quot;PayServiceRule rollback!&quot;</span>);</span><br><span class="line">      List&lt;BizObject&gt; bills = <span class="built_in">this</span>.getBills(billContext, map);</span><br><span class="line">      <span class="keyword">for</span> (BizObject bizObject : bills) &#123;</span><br><span class="line">         <span class="comment">// 账户</span></span><br><span class="line">         <span class="type">String</span> <span class="variable">UserId</span> <span class="operator">=</span> bizObject.get(SUSERID);</span><br><span class="line">         <span class="keyword">if</span> (<span class="literal">null</span> == UserId) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;账户ID不能为空&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">// 待支付金额</span></span><br><span class="line">         <span class="type">BigDecimal</span> <span class="variable">total</span> <span class="operator">=</span> bizObject.get(FTOTAL);</span><br><span class="line">         <span class="keyword">if</span> (<span class="literal">null</span> == total || total.floatValue() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;支付金额不能为空或小于0&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="type">BizObject</span> <span class="variable">pay</span> <span class="operator">=</span> MetaDaoHelper.findById(URI, UserId);</span><br><span class="line">         pay.put(<span class="string">&quot;_status&quot;</span>, EntityStatus.Update);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// 失败则把在途金额加回可用金额</span></span><br><span class="line">         <span class="type">BigDecimal</span> <span class="variable">old</span> <span class="operator">=</span> pay.get(FAVAILABLE);</span><br><span class="line">         pay.put(FAVAILABLE, old.add(total));</span><br><span class="line">      </span><br><span class="line">         <span class="type">BigDecimal</span> <span class="variable">oldOnway</span> <span class="operator">=</span>  pay.get(FONWAY);</span><br><span class="line">         pay.put(FONWAY, oldOnway.subtract(total));</span><br><span class="line">         </span><br><span class="line">         MetaDaoHelper.update(URI, pay);    </span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RuleExecuteResult</span>();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="MDD框架com-yonyou-ucf-mdf-app-service-impl-BillServiceImp-add方法梳理（部分内容）-md"><a href="#MDD框架com-yonyou-ucf-mdf-app-service-impl-BillServiceImp-add方法梳理（部分内容）-md" class="headerlink" title="MDD框架com.yonyou.ucf.mdf.app.service.impl.BillServiceImp add方法梳理（部分内容）.md"></a>MDD框架com.yonyou.ucf.mdf.app.service.impl.BillServiceImp add方法梳理（部分内容）.md</h3><p>com.yonyou.ucf.mdf.app.service.impl.<strong>BillServiceImp</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">add</span><span class="params">(BaseReqDto addDto)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="type">RuleContext</span> <span class="variable">ruleContext</span> <span class="operator">=</span> RuleEngineUtils.prepareRuleContext(addDto, OperationTypeEnum.ADD);</span><br><span class="line">        <span class="type">RuleExecuteResult</span> <span class="variable">result</span> <span class="operator">=</span> RuleEngine.getInstance().execute(ruleContext);</span><br><span class="line">        <span class="keyword">if</span> (result.getMsgCode() != <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(result.getMessage());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> result.getData() == <span class="literal">null</span> ? <span class="string">&quot;&quot;</span> : GsonHelper.ToJSon(result.getData());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;bill add 异常&quot;</span>,e);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>com&#x2F;yonyou&#x2F;ucf&#x2F;mdd&#x2F;rule&#x2F;api&#x2F;<strong>RuleEngine</strong>.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 规则引擎执行入口</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ruleContext 规则执行所需数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> RuleExecuteResult <span class="title function_">execute</span><span class="params">(RuleContext ruleContext)</span> <span class="keyword">throws</span> MddBaseException &#123;</span><br><span class="line">    Queue&lt;? <span class="keyword">extends</span> <span class="title class_">RuleRegister</span>&gt; ruleList ;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ruleList = doGetRules(ruleContext);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;获取规则列表异常!&quot;</span>, e);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> doExecRules(ruleContext, ruleList);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;执行rule异常!&quot;</span>, e);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 调用handleRuleList 方法返回 规则列表</span></span><br><span class="line"><span class="comment">     * 可适配自定义获取规则列表的 处理器。</span></span><br><span class="line"><span class="comment">     * 自定义RuleListHandler 需实现 IRuleListHandler</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ruleContext</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">public</span> Queue&lt;? <span class="keyword">extends</span> <span class="title class_">RuleRegister</span>&gt; doGetRules(RuleContext ruleContext) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">IRuleListHandler</span> <span class="variable">ruleListHandler</span> <span class="operator">=</span> ruleContext.getRuleListHandler();</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == ruleListHandler) &#123;</span><br><span class="line">        ruleListHandler = <span class="keyword">new</span> <span class="title class_">DefaultRuleListHandler</span>();</span><br><span class="line">        log.debug(<span class="string">&quot;##RuleEngine:doGetRules # 使用 DefaultRuleListHandler&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;##RuleEngine:doGetRules # 使用自定义 RuleListHandler&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Queue</span> <span class="variable">ruleList</span> <span class="operator">=</span>  ruleListHandler.handleRuleList(ruleContext);</span><br><span class="line">    ExtListUtil.checkRuleList(ruleList);</span><br><span class="line">    <span class="keyword">return</span> ruleList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>com&#x2F;yonyou&#x2F;ucf&#x2F;mdd&#x2F;rule&#x2F;handler&#x2F;<strong>DefaultRuleListHandler</strong>.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Queue&lt;RuleRegister&gt; <span class="title function_">handleRuleList</span><span class="params">(RuleContext ruleContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">Object</span> <span class="variable">bill</span> <span class="operator">=</span> ruleContext.getCustomMap().get(<span class="string">&quot;param&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">action</span> <span class="operator">=</span> ruleContext.getOperateType() == <span class="literal">null</span> ? ruleContext.getOperationTypeEx() : ruleContext.getOperateType().getValue();</span><br><span class="line">    String[] ruleLvs = ruleContext.getRuleLvs();</span><br><span class="line">    <span class="keyword">if</span> (ruleContext.isMakeup()) &#123;<span class="comment">//如果是异步规则，是否支持失败后规则补偿</span></span><br><span class="line">        <span class="keyword">return</span> getMakeupRuleList(action, ruleContext.getTenantId());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">uiTenantId</span> <span class="operator">=</span> ruleContext.getTenantId();</span><br><span class="line">    <span class="keyword">if</span> (ruleContext.getTenantId() == <span class="literal">null</span> || StringUtils.isEmpty(ruleContext.getTenantId() + <span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">        uiTenantId = AppContext.getTenantIdNoCallBack();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> getRuleList(ruleContext.getBillnum(), ruleLvs, action, bill, uiTenantId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * important : action eq check and key is not null in billObject action set value check_key&lt;code&gt;null&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     * getList should merge check with check_key</span></span><br><span class="line"><span class="comment">     * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ruleLvs  Rule Level :ruleLvs[0] = &quot;common&quot;; ruleLvs[1] = uiMetaBaseInfo.getSubid(); ruleLvs[2] = uiMetaBaseInfo.getBillnum();</span></span><br><span class="line"><span class="comment">     *                 over rule : from high to low</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> action   the action for request exp: save,delete,update,list and so on</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bill     object &#123;<span class="doctag">@link</span> BaseDto&#125; if type of &#123;<span class="doctag">@link</span> BaseDto&#125; return this else come from param others is &lt;code&gt;null&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tenantId tenantId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&#123;&quot;rawtypes&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">private</span> Queue&lt;RuleRegister&gt; <span class="title function_">getRuleList</span><span class="params">(String billnum, String[] ruleLvs, String action, Object bill, Object tenantId)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">BaseDto</span> <span class="variable">billDto</span> <span class="operator">=</span> getBaseDto(bill);</span><br><span class="line">        <span class="keyword">if</span> (isCheck(action)) &#123;</span><br><span class="line">            <span class="type">Map</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Gson</span>().fromJson(billDto.getItem(), Map.class);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != obj &amp;&amp; obj.get(<span class="string">&quot;key&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">                action = <span class="string">&quot;check_&quot;</span> + obj.get(<span class="string">&quot;key&quot;</span>).toString();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">ruleKey</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != billDto) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != billDto.getRuleKey()) &#123;</span><br><span class="line">                ruleKey = billDto.getRuleKey();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.equalsIgnoreCase(OperationTypeEnum.REFER.getValue(), action) || StringUtils.equalsIgnoreCase(action, OperationTypeEnum.REFERREFRESH.getValue())) &#123;</span><br><span class="line">                    ruleKey = billDto.getrefCode();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取可执行的redis队列</span></span><br><span class="line">        Queue&lt;RuleRegister&gt; ruleList = getAndFilterRules(billnum, action, ruleKey, tenantId, ruleLvs);</span><br><span class="line">        <span class="comment">/* 设置依赖关系 */</span></span><br><span class="line">        dependOnRule(ruleList);</span><br><span class="line">        <span class="keyword">return</span> ruleList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取规则列表</span></span><br><span class="line"><span class="comment">     * 根据ruleKey 规则关键字过滤</span></span><br><span class="line"><span class="comment">     * 高级别规则对低级别规则的覆盖</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 通过lvs循环查找规则</span></span><br><span class="line"><span class="comment">     * 1)ruleLvs[2] = &quot;common&quot;;</span></span><br><span class="line"><span class="comment">     * 2)ruleLvs[1] = uiMetaBaseInfo.getSubid();</span></span><br><span class="line"><span class="comment">     * 3)ruleLvs[0] = uiMetaBaseInfo.getBillnum();</span></span><br><span class="line"><span class="comment">     * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> action   动作</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ruleKey  规则关键字</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tenantId 租户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Queue&lt;RuleRegister&gt; <span class="title function_">getAndFilterRules</span><span class="params">(String billnum, String action, String ruleKey, Object tenantId, String[] ruleLvsOri)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取缓存， foreach 外，减少调用次数</span></span><br><span class="line">        List&lt;RuleRegister&gt; ruleRegisters;</span><br><span class="line">        <span class="keyword">if</span> (RuleUtil.isOpenCache()) &#123;<span class="comment">//是否开启规则缓存，建议都开启，默认开启</span></span><br><span class="line">            ruleRegisters = RuleUtil.getBillNumRuleFromCache(tenantId, billnum, ruleLvsOri, action);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ruleRegisters = RuleUtil.initBillNumRuleRegister(tenantId, ruleLvsOri,action);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(Tracker.switchEnable())&#123;</span><br><span class="line">            Map&lt;String, Object&gt; inparam = <span class="keyword">new</span> <span class="title class_">HashMap</span> &lt;&gt;();</span><br><span class="line">            inparam.put(<span class="string">&quot;billnum&quot;</span>, billnum);</span><br><span class="line">            inparam.put(<span class="string">&quot;action&quot;</span>, action);</span><br><span class="line">            inparam.put(<span class="string">&quot;ruleKey&quot;</span>, ruleKey);</span><br><span class="line">            inparam.put(<span class="string">&quot;tenantId&quot;</span>, tenantId);</span><br><span class="line">            inparam.put(<span class="string">&quot;ruleLvsOri&quot;</span>, ruleLvsOri);</span><br><span class="line">            Tracker.recordLogClues(<span class="built_in">this</span>.getClass().getName(), <span class="string">&quot;getAndFilterRules&quot;</span>, inparam, ruleRegisters, <span class="string">&quot;获取规则列表, 通过RuleUtil 获取的结果&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Queue&lt;RuleRegister&gt; ruleRegisterQueue = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        <span class="type">RuleStatus</span> <span class="variable">ruleStatus</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RuleStatus</span>();</span><br><span class="line">        String[] ruleLvs = ruleLvsOri.clone();</span><br><span class="line">        <span class="comment">//数组反转</span></span><br><span class="line">        ArrayUtils.reverse(ruleLvs);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; ruleLvs.length; i++) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">ruleLv</span> <span class="operator">=</span> ruleLvs[i];</span><br><span class="line">            List&lt;RuleRegister&gt; tmpList = filterRules(ruleLv, ruleKey, ruleRegisters);</span><br><span class="line">            <span class="comment">//增加同级别覆盖逻辑, 通过配置指定</span></span><br><span class="line">            overrideRule(tmpList, ruleRegisterQueue, ruleStatus, ruleLvs.length - i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//队列排序</span></span><br><span class="line">        List&lt;RuleRegister&gt; list = <span class="keyword">new</span> <span class="title class_">LinkedList</span>(ruleRegisterQueue);</span><br><span class="line">        Collections.sort(list, RuleComparatorUtil.getInstance().getCmp());</span><br><span class="line">        ruleRegisterQueue.clear();</span><br><span class="line">        ruleRegisterQueue.addAll(list);</span><br><span class="line">        <span class="keyword">return</span> ruleRegisterQueue;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>





<p>com&#x2F;yonyou&#x2F;ucf&#x2F;mdd&#x2F;rule&#x2F;utils&#x2F;<strong>RuleUtil</strong>.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化表单基本的规则列表,如果是check_action，同步查询出check的规则列表</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> tenantId   租户ID</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ruleLvsOri</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;RuleRegister&gt; <span class="title function_">initBillNumRuleRegister</span><span class="params">(Object tenantId, String[] ruleLvsOri,String ruleaction)</span> &#123;</span><br><span class="line">    Map&lt;String, Object&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    params.put(<span class="string">&quot;tenantId&quot;</span>, tenantId);</span><br><span class="line">    List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String rule :ruleLvsOri)&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(rule))&#123;</span><br><span class="line">            list.add(rule);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;String&gt; actionList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    actionList.add(ruleaction);</span><br><span class="line">    <span class="keyword">if</span> (ruleaction.startsWith(<span class="string">&quot;check_&quot;</span>))&#123;</span><br><span class="line">        list.add(<span class="string">&quot;check&quot;</span>);</span><br><span class="line">        actionList.add(<span class="string">&quot;check&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    params.put(<span class="string">&quot;list&quot;</span>, list);</span><br><span class="line">    params.put(<span class="string">&quot;actionList&quot;</span>, actionList);</span><br><span class="line">    List&lt;RuleRegister&gt; ruleRegisterList = findAllBillRuleRegister(params);</span><br><span class="line">    <span class="keyword">return</span> ruleRegisterList;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取表单列表，可按照billnum进行过滤</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> params</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;RuleRegister&gt; <span class="title function_">findAllBillRuleRegister</span><span class="params">(Map&lt;String, Object&gt; params)</span> &#123;</span><br><span class="line">        List&lt;RuleRegister&gt; ruleRegisterList = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">IRuleRegisterMapperDao</span> <span class="variable">iruledao</span> <span class="operator">=</span> UBaseContext.getBean(IRuleRegisterMapperDao.class);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == iruledao) &#123;</span><br><span class="line">                iruledao = <span class="keyword">new</span> <span class="title class_">RuleRegisterMapperDaoImpl</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            ruleRegisterList = iruledao.findAllBillRuleRegister(params);</span><br><span class="line">            <span class="comment">// 增加逻辑如果初始化当前租户没有规则，则使用公共规则 使用租户ID为0的</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == ruleRegisterList || ruleRegisterList.isEmpty()) &#123;</span><br><span class="line">                params.put(MddConstants.PARAM_TENANT_ID, ExtCommonUtil.getZeroTenant());</span><br><span class="line">                ruleRegisterList = AppContext.getBean(IRuleRegisterMapperDao.class).findAllBillRuleRegister(params);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ruleRegisterList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://liketostudy.com/2023/01/13/%E5%AE%9E%E4%B9%A0-02-YMS%E7%A4%BA%E4%BE%8B%E5%B7%A5%E7%A8%8B%E6%90%AD%E5%BB%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="文晨">
      <meta itemprop="description" content="百学须先立志">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="琛的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/13/%E5%AE%9E%E4%B9%A0-02-YMS%E7%A4%BA%E4%BE%8B%E5%B7%A5%E7%A8%8B%E6%90%AD%E5%BB%BA/" class="post-title-link" itemprop="url">实习-02-YMS示例工程搭建</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-01-13 16:40:57" itemprop="dateCreated datePublished" datetime="2023-01-13T16:40:57+08:00">2023-01-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-02-14 15:58:12" itemprop="dateModified" datetime="2023-02-14T15:58:12+08:00">2023-02-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AE%9E%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">实习</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="SpringBoot项目创建"><a href="#SpringBoot项目创建" class="headerlink" title="SpringBoot项目创建"></a>SpringBoot项目创建</h1><h2 id="SpringBoot工程创建"><a href="#SpringBoot工程创建" class="headerlink" title="SpringBoot工程创建"></a>SpringBoot工程创建</h2><p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230115184814451.png" alt="image-20230115184814451"></p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230115185245172.png" alt="image-20230115185245172"></p>
<h2 id="pom-xml文件配置"><a href="#pom-xml文件配置" class="headerlink" title="pom.xml文件配置"></a>pom.xml文件配置</h2><h3 id="持久化框架选择"><a href="#持久化框架选择" class="headerlink" title="持久化框架选择"></a>持久化框架选择</h3><blockquote>
<p>个人使用mybatis plus框架</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--    mybatis-plus   --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="配置扫描"><a href="#配置扫描" class="headerlink" title="配置扫描"></a>配置扫描</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--根据文档添加配置扫描--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/java<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.xml<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">	<span class="comment">&lt;!--plugins标签内容见下文--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins...</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="application-properties文件配置"><a href="#application-properties文件配置" class="headerlink" title="application.properties文件配置"></a>application.properties文件配置</h2><blockquote>
<p>配置数据源（即数据库相关配置）</p>
</blockquote>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.datasource.url</span>: <span class="string">jdbc:mysql://localhost:3306/test?serverTimezone=UTC</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>: <span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>: <span class="string">root </span></span><br><span class="line"><span class="attr">spring.datasource.driver-class-name</span>: <span class="string">com.mysql.cj.jdbc.Driver</span></span><br></pre></td></tr></table></figure>



<h2 id="添加增删改查代码内容"><a href="#添加增删改查代码内容" class="headerlink" title="添加增删改查代码内容"></a>添加增删改查代码内容</h2><blockquote>
<p>以下内容作为参考</p>
</blockquote>
<ul>
<li><p>项目结构</p>
<blockquote>
<p>user2结构及内容同user1</p>
</blockquote>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230115190137058.png" alt="image-20230115190137058"></p>
</li>
<li><p>代码示例</p>
<blockquote>
<p>添加一套简单的对数据库表增删改查逻辑</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">## User1Controller.java</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 实现一套简单的增删改查逻辑代码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user1&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User1Controller</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> User1Service user1Service;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//新增用户1</span></span><br><span class="line">    <span class="comment">//增</span></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> User1 user1)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;新增用户1，信息：&#123;&#125;&quot;</span>, user1.toString());</span><br><span class="line">        user1Service.save(user1);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据id查询用户</span></span><br><span class="line">    <span class="comment">//查</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> User1 <span class="title function_">get</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span>&#123;</span><br><span class="line">        <span class="type">User1</span> <span class="variable">user1</span> <span class="operator">=</span> user1Service.getById(id);</span><br><span class="line">        <span class="keyword">if</span>(user1 != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> user1;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            log.info(<span class="string">&quot;查询失败&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据id更改用户信息</span></span><br><span class="line">    <span class="comment">//改</span></span><br><span class="line">    <span class="meta">@PutMapping</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">update</span><span class="params">(<span class="meta">@RequestBody</span> User1 user1)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;更改用户信息：&#123;&#125;&quot;</span>, user1.toString());</span><br><span class="line">        user1Service.updateById(user1);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据id删除用户信息</span></span><br><span class="line">    <span class="comment">//删</span></span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">delete</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span>&#123;</span><br><span class="line">        user1Service.removeById(id);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">## User1.java</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户1信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User1</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//姓名</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//手机号</span></span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//性别 0 女 1 男</span></span><br><span class="line">    <span class="keyword">private</span> String sex;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//身份证号</span></span><br><span class="line">    <span class="keyword">private</span> String idNumber;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//头像</span></span><br><span class="line">    <span class="keyword">private</span> String avatar;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//状态 0:禁用，1:正常</span></span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">## User1Mapper.java</span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">User1Mapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;User1&gt; &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">## User1ServiceImpl.java</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User1ServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;User1Mapper, User1&gt; <span class="keyword">implements</span> <span class="title class_">User1Service</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">## User1Service.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">User1Service</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;User1&gt; &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="项目总体结构"><a href="#项目总体结构" class="headerlink" title="项目总体结构"></a>项目总体结构</h2><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230115191613761.png" alt="image-20230115191613761" style="zoom:80%;">



<h2 id="数据库建表sql"><a href="#数据库建表sql" class="headerlink" title="数据库建表sql"></a>数据库建表sql</h2><blockquote>
<p>可使用Mysql可视化工具操作，选中本地test数据库</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `user1` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">50</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">  `phone` <span class="type">varchar</span>(<span class="number">100</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;手机号&#x27;</span>,</span><br><span class="line">  `sex` <span class="type">varchar</span>(<span class="number">2</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;性别&#x27;</span>,</span><br><span class="line">  `id_number` <span class="type">varchar</span>(<span class="number">18</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;身份证号&#x27;</span>,</span><br><span class="line">  `avatar` <span class="type">varchar</span>(<span class="number">500</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;头像&#x27;</span>,</span><br><span class="line">  `status` <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;状态 0:禁用，1:正常&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb3 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;用户1信息&#x27;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `user2` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">50</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">  `phone` <span class="type">varchar</span>(<span class="number">100</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;手机号&#x27;</span>,</span><br><span class="line">  `sex` <span class="type">varchar</span>(<span class="number">2</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;性别&#x27;</span>,</span><br><span class="line">  `id_number` <span class="type">varchar</span>(<span class="number">18</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;身份证号&#x27;</span>,</span><br><span class="line">  `avatar` <span class="type">varchar</span>(<span class="number">500</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;头像&#x27;</span>,</span><br><span class="line">  `status` <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;状态 0:禁用，1:正常&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb3 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">&#x27;用户2信息&#x27;</span></span><br></pre></td></tr></table></figure>



<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>此时可以使用Postman测试SpringBoot项目的增删改查功能，如下</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230115192530152.png" alt="image-20230115192530152"></p>
<h1 id="SpringBoot项目改为YMS项目"><a href="#SpringBoot项目改为YMS项目" class="headerlink" title="SpringBoot项目改为YMS项目"></a>SpringBoot项目改为YMS项目</h1><h2 id="改造启动类"><a href="#改造启动类" class="headerlink" title="改造启动类"></a>改造启动类</h2><blockquote>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication(exclude = &#123;DataSourceAutoConfiguration.class&#125;)</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement(proxyTargetClass = true)</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.example.demoyms.*.mapper&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoYmsApplication</span> <span class="keyword">extends</span> <span class="title class_">SpringBootServletInitializer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"><span class="comment">//        SpringApplication.run(DemoYmsApplication.class, args);</span></span><br><span class="line">        <span class="type">SpringApplication</span> <span class="variable">springApplication</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringApplicationBuilder</span>(DemoYmsApplication.class).build();</span><br><span class="line">        springApplication.setAllowBeanDefinitionOverriding(<span class="literal">true</span>);</span><br><span class="line">        springApplication.run(args);</span><br><span class="line">        System.out.println(<span class="string">&quot;DemoYmsApplication启动完成...........&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="改造pom-xml文件"><a href="#改造pom-xml文件" class="headerlink" title="改造pom.xml文件"></a>改造pom.xml文件</h2><h3 id="配置统一依赖管理iuap-pom-with-ucf-parent"><a href="#配置统一依赖管理iuap-pom-with-ucf-parent" class="headerlink" title="配置统一依赖管理iuap-pom-with-ucf-parent"></a>配置统一依赖管理iuap-pom-with-ucf-parent</h3><blockquote>
<p>请参照<a target="_blank" rel="noopener" href="https://uap-wiki.yyrd.com/pages/viewpage.action?pageId=123503058">YMS用户使用指南V0.2</a></p>
</blockquote>
<p>根据我们的环境和需要选择一个iuap-pom-with-ucf-parent的版本，以下是iuap-pom-with-ucf-parent的版本以及对应的iuap-boot-starter、yms版本、流水线镜像对应版本如下：</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230115193703159.png" alt="image-20230115193703159"></p>
<p>具体内容参照用户指南2.2.1</p>
<p>本示例工程使用版本如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.yonyou.iuap<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>iuap-2nd-party<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="业务工程配置iuap-boot-starter组件依赖"><a href="#业务工程配置iuap-boot-starter组件依赖" class="headerlink" title="业务工程配置iuap-boot-starter组件依赖"></a>业务工程配置iuap-boot-starter组件依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.yonyou.iuap.yms<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>iuap-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="其他依赖"><a href="#其他依赖" class="headerlink" title="其他依赖"></a>其他依赖</h3><blockquote>
<p>示例工程采用其他依赖</p>
<p>均为参考其他工程所得，可忽略</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>TwoCoordnate<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.yonyou.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.yonyou.cloud.middleware<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mwclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.yonyou.cloud.middleware<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>iris-spring-support<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/mysql/mysql-connector-java --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.21<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="打包插件"><a href="#打包插件" class="headerlink" title="打包插件"></a>打包插件</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.yonyou.iuap.yms<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>yms-module-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--  填写iuap-pom-with-ucf-parent里iuap-boot-starter对应的版本--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goal</span>&gt;</span>repackage<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 模块信息必须和spring.application.name的值一致--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">moduleName</span>&gt;</span>datasourceDemoWjc<span class="tag">&lt;/<span class="name">moduleName</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 配置http/https访问该模块的根路径--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">contextPath</span>&gt;</span>/datasourceDemoWjc<span class="tag">&lt;/<span class="name">contextPath</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exteranlDependencies</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>yms-external<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.yonyou.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!-- 与插件版本保持一致--&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exteranlDependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">middleDependencies</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>yms-middleware<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.yonyou.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!-- 与插件版本保持一致--&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">middleDependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="application-properties文件配置-1"><a href="#application-properties文件配置-1" class="headerlink" title="application.properties文件配置"></a>application.properties文件配置</h2><h3 id="微服务配置-ak"><a href="#微服务配置-ak" class="headerlink" title="微服务配置 ak"></a>微服务配置 ak</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">access.key</span>= <span class="string">IlJ0b5Di4xZuWnoX</span></span><br><span class="line"><span class="attr">access.secret</span>= <span class="string">JqWjqpkSmManqVv53WIGDGo4kOggVn</span></span><br><span class="line"><span class="attr">app.domain</span>=<span class="string">https://developer.yonyoucloud.com</span></span><br><span class="line"><span class="attr">portal.auth.url</span>=<span class="string">$&#123;app.domain&#125;/portal/api/v1/res/checkUserAuth</span></span><br></pre></td></tr></table></figure>



<h3 id="spring-application-name"><a href="#spring-application-name" class="headerlink" title="spring.application.name"></a>spring.application.name</h3><p>微服务名称，<strong>后面配置YMS控制台会用到</strong></p>
<h3 id="环境标识"><a href="#环境标识" class="headerlink" title="环境标识"></a>环境标识</h3><p>YMS是测试环境的话写test 开发环境写dev</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spring.profiles.active=test</span><br></pre></td></tr></table></figure>



<h3 id="文件截图及注意事项"><a href="#文件截图及注意事项" class="headerlink" title="文件截图及注意事项"></a>文件截图及注意事项</h3><p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230115194919568.png" alt="image-20230115194919568"></p>
<blockquote>
<p>注意：文件尽量使用.properties，不要使用.yml</p>
</blockquote>
<h2 id="代码上传至git"><a href="#代码上传至git" class="headerlink" title="代码上传至git"></a>代码上传至git</h2><blockquote>
<p>暂未操作</p>
</blockquote>
<p>​    Git地址：<a target="_blank" rel="noopener" href="http://git.yonyou.com/">http://git.yonyou.com</a></p>
<p>​    用户名：用友域账号</p>
<p>​    密码：用友域账号的密码</p>
<h2 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h2><p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230115195217049.png" alt="image-20230115195217049"></p>
<blockquote>
<p>此后项目启动成功即可，成功截图未放</p>
</blockquote>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="parent引入失败"><a href="#parent引入失败" class="headerlink" title="parent引入失败"></a>parent引入失败</h3><ul>
<li><p>开发前，请先根据相关文档配置maven–settings.xml文件</p>
<blockquote>
<p>参考文档，Jfrog私服开发配置流程，<a target="_blank" rel="noopener" href="https://yundoc.yonyou.com/view/l/tjrxb14">https://yundoc.yonyou.com/view/l/tjrxb14</a></p>
</blockquote>
</li>
<li><p>生成自己的settings.xml文件后，替换下图3中的路径文件</p>
</li>
</ul>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230115195728465.png" alt="image-20230115195728465"></p>
<h3 id="parent和插件版本匹配问题"><a href="#parent和插件版本匹配问题" class="headerlink" title="parent和插件版本匹配问题"></a>parent和插件版本匹配问题</h3><p>经过个人的尝试选择上述版本，过程中项目启动过程报错需要yms什么manager，回退了版本后不报错</p>
<h3 id="项目启动过程遇到报错没有找到User1Mapper-bean"><a href="#项目启动过程遇到报错没有找到User1Mapper-bean" class="headerlink" title="项目启动过程遇到报错没有找到User1Mapper bean"></a>项目启动过程遇到报错没有找到User1Mapper bean</h3><p>经查找问题发现是包扫描路径出错</p>
<h1 id="数据源组件创建"><a href="#数据源组件创建" class="headerlink" title="数据源组件创建"></a>数据源组件创建</h1><h2 id="本地代码改造"><a href="#本地代码改造" class="headerlink" title="本地代码改造"></a>本地代码改造</h2><h3 id="创建配置类"><a href="#创建配置类" class="headerlink" title="创建配置类"></a>创建配置类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomDSConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;master&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">masterDataSource</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HikariDataSource</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="关闭SpringBoot自动加载"><a href="#关闭SpringBoot自动加载" class="headerlink" title="关闭SpringBoot自动加载"></a>关闭SpringBoot自动加载</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication(exclude = &#123;DataSourceAutoConfiguration.class&#125;)</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>此注解禁止 <strong>SpringBoot</strong> 自动注入数据源配置，关闭自动查找 <strong>application.yml</strong> 或者 <strong>properties</strong> 文件里的 <strong>spring.datasource.*</strong> 相关属性并自动配置<strong>单数据源</strong></p>
</blockquote>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><h3 id="准备YMS控制台账号"><a href="#准备YMS控制台账号" class="headerlink" title="准备YMS控制台账号"></a>准备YMS控制台账号</h3><p>访问<a target="_blank" rel="noopener" href="http://dc.yms.app.yyuap.com/confcenter/">http://dc.yms.app.yyuap.com/confcenter/</a></p>
<p>账号密码请自行联系获得即可登录</p>
<h3 id="获得YonBIP开发者平台使用权限"><a href="#获得YonBIP开发者平台使用权限" class="headerlink" title="获得YonBIP开发者平台使用权限"></a>获得YonBIP开发者平台使用权限</h3><p>获取流程请参考以下操作：</p>
<ul>
<li><p>打开Windows端下的友空间平台</p>
</li>
<li><p>进入工作台</p>
</li>
<li><p>点击左上角图标</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230115201002627.png" alt="image-20230115201002627"></p>
</li>
<li><p>搜索“审批”</p>
</li>
<li><p>点击发起流程</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230115201044626.png" alt="image-20230115201044626"></p>
</li>
<li><p>点击云平台开发者中心—&gt;开发者中心使用权限—&gt;发起审批即可</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230115201335671.png" alt="image-20230115201335671"></p>
</li>
</ul>
<h2 id="连接池创建"><a href="#连接池创建" class="headerlink" title="连接池创建"></a>连接池创建</h2><p>访问<a target="_blank" rel="noopener" href="http://dc.yms.app.yyuap.com/confcenter/">http://dc.yms.app.yyuap.com/confcenter/</a></p>
<h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><ul>
<li><p>根据2.2.3配置内容选择开发环境或测试环境</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230115201703079.png" alt="image-20230115201703079"></p>
</li>
</ul>
<p>​        其他环境请一定不要操作</p>
<ul>
<li><img src="/.com//Users\温家琛\AppData\Roaming\Typora\typora-user-images\image-20230115201832290.png" alt="image-20230115201832290"></li>
</ul>
<p>​        点击添加连接池</p>
<ul>
<li><p>填写配置信息</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230115202137342.png" alt="image-20230115202137342"></p>
<blockquote>
<p>注意：连接池名称为自定义的可识别名称，连接池编码自定义可识别的名称，命名规范同java变量（参照YMS操作文档），用户名，密码，地址等请联系人员获得，YMS控制台与本地不通，请不要使用本地127.0.0.1数据库 </p>
</blockquote>
<p>点击测试连接，通过后点击提交</p>
</li>
<li><p>数据源配置成功</p>
</li>
</ul>
<h2 id="逻辑数据源创建及发布"><a href="#逻辑数据源创建及发布" class="headerlink" title="逻辑数据源创建及发布"></a>逻辑数据源创建及发布</h2><h3 id="创建流程"><a href="#创建流程" class="headerlink" title="创建流程"></a>创建流程</h3><ul>
<li><p>选择测试环境—-点击配置管理—-点击任意产品名称—-点击逻辑数据源—-点击添加逻辑数据源</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230115202743466.png"></p>
</li>
<li><p>配置逻辑数据源信息</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230115203020550.png" alt="image-20230115203020550"></p>
<blockquote>
<p>部分内容参照了YMS文档</p>
</blockquote>
</li>
</ul>
<p>​        1.逻辑数据源名称，自定义的可识别名称</p>
<p>​        2.逻辑数据源编码，逻辑数据源编码为规则为：spring.application.name+ “_” + 数据源的beanName，比如我的spring.application.name为datasourceDemoWjc，CustomDSConfiguration中注入的bean名称为master，则逻辑数据源编码为datasourceDemoWjc_master</p>
<p>​        3.默认Schema，mysql为数据库的名称，其他有Schema分层的数据库为Schema。</p>
<p>​        4.其他表单内容暂不确定</p>
<p>​        5.点击提交</p>
<h3 id="关联数据源连接池"><a href="#关联数据源连接池" class="headerlink" title="关联数据源连接池"></a>关联数据源连接池</h3><ul>
<li>点击关联数据源连接池</li>
</ul>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230115204110013.png" alt="image-20230115204110013"></p>
<ul>
<li>选中3.3创建的连接池</li>
</ul>
<p>​        <img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230115204214894.png" alt="image-20230115204214894"></p>
<h2 id="调试及常见问题"><a href="#调试及常见问题" class="headerlink" title="调试及常见问题"></a>调试及常见问题</h2><h3 id="调试过程"><a href="#调试过程" class="headerlink" title="调试过程"></a>调试过程</h3><ul>
<li><p>点击配置文件预览及发布</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230115204603445.png" alt="image-20230115204603445"></p>
</li>
<li><p>将左侧的新值展开复制保存为yms_dynds_preload.json文件</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230115204724362.png" alt="image-20230115204724362"></p>
</li>
<li><p>将该json文件内容删除最外侧的”datasource”层，如下图，否则启动时报错无法解析json</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230115204914664.png" alt="image-20230115204914664"></p>
</li>
<li><p>使用postman进行测试，成功进行表数据增删改查</p>
</li>
</ul>
<h3 id="常见问题-1"><a href="#常见问题-1" class="headerlink" title="常见问题"></a>常见问题</h3><h4 id="数据源为空"><a href="#数据源为空" class="headerlink" title="数据源为空"></a>数据源为空</h4><p>通过代码设断点分析，得为json文件格式问题，最外层应该直接以logicDataSouceList等开始，而不能包一层datasouce，否则解析不到，分析过程如下：</p>
<ul>
<li><p>com.yonyou.iuap.yms.datasource.YmsDataSourceConfiguration</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230115205803701.png" alt="image-20230115205803701"></p>
</li>
<li><p>com.yonyou.iuap.yms.datasource.ds.provider.impl.YMSDataSourceProvider</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230115205840692.png" alt="image-20230115205840692"></p>
</li>
<li><p>com.yonyou.iuap.yms.datasource.ds.provider.impl.YMSGlobalDataSourceProvider</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230115205939666.png" alt="image-20230115205939666"></p>
</li>
<li><p>com.yonyou.iuap.yms.datasource.service.DynamicDataSourceQryService</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230115210010891.png" alt="image-20230115210010891"></p>
</li>
<li><p>com.yonyou.iuap.yms.datasource.service.DisConfigLoadUtils</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230115210048579.png" alt="image-20230115210048579"></p>
</li>
</ul>
<p>​        在这里发现GsonUtils.fromJson传入参数content有yms_dynds.json解码内容，而返回的configDTO内容呢却全为空，那么通过比对YmsConfigDTO类的属性发现json文件不应该包含datasource层，故找到问题所在</p>
<img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230115210256696.png" style="zoom:67%;">

<h4 id="启动报错sql异常，-112-x72-101-109-105-x73-x65-115-64-49-x30-x2e-x38-46-51-x32-46-49-48-49-没有权限"><a href="#启动报错sql异常，-112-x72-101-109-105-x73-x65-115-64-49-x30-x2e-x38-46-51-x32-46-49-48-49-没有权限" class="headerlink" title="启动报错sql异常，&#112;&#x72;&#101;&#109;&#105;&#x73;&#x65;&#115;&#64;&#49;&#x30;&#x2e;&#x38;&#46;&#51;&#x32;&#46;&#49;&#48;&#49;没有权限"></a>启动报错sql异常，<a href="mailto:&#112;&#x72;&#101;&#109;&#105;&#x73;&#x65;&#115;&#64;&#49;&#x30;&#x2e;&#x38;&#46;&#51;&#x32;&#46;&#49;&#48;&#49;">&#112;&#x72;&#101;&#109;&#105;&#x73;&#x65;&#115;&#64;&#49;&#x30;&#x2e;&#x38;&#46;&#51;&#x32;&#46;&#49;&#48;&#49;</a>没有权限</h4><p>由于10.8.32.101是我在家办公开启的vpn地址，我认为是没有权限的缘故</p>
<p><strong>经排查确认其实是密码错误，yms_dynds.json文件中的密码由密文更换为非密文即可。</strong></p>
<p>因此我将yms_dynds.json内容更换为本地环境进行测试，数据可以添加到连接池中配置的数据库，可以成功增删改查！</p>
<h2 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h2><p>本地项目启动后调用接口查看数据是否添加到连接池中配置的数据库</p>
<ul>
<li><p>增</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230116103701245.png" alt="image-20230116103701245"></p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230116103856638.png" alt="image-20230116103856638"></p>
</li>
<li><p>删</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230116104053045.png" alt="image-20230116104053045"></p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230116104124324.png" alt="image-20230116104124324"></p>
</li>
<li><p>改</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230116104701605.png" alt="image-20230116104701605"></p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230116104713323.png" alt="image-20230116104713323"></p>
</li>
<li><p>查</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230116104746104.png" alt="image-20230116104746104"></p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://liketostudy.com/2023/01/06/%E5%AE%9E%E4%B9%A0-01-%E5%88%9D%E6%AD%A5%E6%8E%A5%E8%A7%A6YTS%E3%80%81YMS%E3%80%81MDD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="文晨">
      <meta itemprop="description" content="百学须先立志">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="琛的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/06/%E5%AE%9E%E4%B9%A0-01-%E5%88%9D%E6%AD%A5%E6%8E%A5%E8%A7%A6YTS%E3%80%81YMS%E3%80%81MDD/" class="post-title-link" itemprop="url">实习-01-初步接触YTS、YMS、MDD</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-01-06 14:40:57" itemprop="dateCreated datePublished" datetime="2023-01-06T14:40:57+08:00">2023-01-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-02-14 15:59:17" itemprop="dateModified" datetime="2023-02-14T15:59:17+08:00">2023-02-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AE%9E%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">实习</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="YTS文档"><a href="#YTS文档" class="headerlink" title="YTS文档"></a>YTS文档</h1><blockquote>
<p>一致性框架(YTS)设计文档-评审-new</p>
</blockquote>
<h2 id="技术了解"><a href="#技术了解" class="headerlink" title="技术了解"></a>技术了解</h2><h3 id="分布式事务"><a href="#分布式事务" class="headerlink" title="分布式事务"></a>分布式事务</h3><p>本质上来说，分布式事务就是为了保证不同数据库的数据一致性。</p>
<blockquote>
<ul>
<li><input disabled type="checkbox"> <strong>继续阅读</strong>：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/Daniel-Leung/p/fenbushishiwu20210825230930.html">https://www.cnblogs.com/Daniel-Leung/p/fenbushishiwu20210825230930.html</a></li>
</ul>
</blockquote>
<h3 id="认识打桩"><a href="#认识打桩" class="headerlink" title="认识打桩"></a>认识打桩</h3><blockquote>
<p>什么是桩</p>
</blockquote>
<p>桩，或称桩代码，是指用来代替关联代码或者未实现代码的代码。如果函数B用B1来代替，那么，B称为原函数，B1称为桩函数。打桩就是编写或生成桩代码。</p>
<blockquote>
<p>打桩的目的主要有：<strong>隔离</strong>、<strong>补齐</strong>、<strong>控制</strong>。</p>
</blockquote>
<p>隔离是指将测试任务从产品项目中分离出来，使之能够独立编译、链接，并独立运行。隔离的基本方法就是打桩，将测试任务之外的，并且与测试任务相关的代码，用桩来代替，从而实现分离测试任务。例如函数A调用了函数B，函数B又调用了函数C和D，如果函数B用桩来代替，函数A就可以完全割断与函数C和D的关系。</p>
<p>补齐是指用桩来代替未实现的代码，例如，函数A调用了函数B，而函数B由其他程序员编写，且未实现，那么，可以用桩来代替函数B，使函数A能够运行并测试。补齐在并行开发中很常用。</p>
<p>控制是指在测试时，人为设定相关代码的行为，使之符合测试需求。例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">externint <span class="title function_">B</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">A</span><span class="params">()</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="variable">ret</span> <span class="operator">=</span> B();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(ret == <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">;<span class="comment">//do something</span></span><br><span class="line"></span><br><span class="line">elseif(ret == <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">;<span class="comment">//do something</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">;<span class="comment">//do something</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果函数B返回随机数，或者返回网络状态，或者返回环境温度，等等，则当调用其实际代码时，函数A很难测试，这时可以用桩函数B1来代替B，使其返回测试所需要的数据。</p>
<h3 id="Spring事务了解"><a href="#Spring事务了解" class="headerlink" title="Spring事务了解"></a>Spring事务了解</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/java123456111/article/details/124946361">https://blog.csdn.net/java123456111/article/details/124946361</a></p>
</blockquote>
<p>事务、事务特性、</p>
<ul>
<li><p>编程式事务管理TransactionTemplate、TransactionManager</p>
</li>
<li><p>声明式事务管理</p>
<ul>
<li><p>通过 AOP 实现（基于@Transactional 的全注解方式使用最多）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(propagation=propagation.PROPAGATION_REQUIRED)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> aMethod &#123;</span><br><span class="line">  <span class="comment">//do something</span></span><br><span class="line">  <span class="type">B</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">B</span>();</span><br><span class="line">  <span class="type">C</span> <span class="variable">c</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">C</span>();</span><br><span class="line">  b.bMethod();</span><br><span class="line">  c.cMethod();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li><input disabled type="checkbox"> 2023&#x2F;1&#x2F;4，阅读未完成，1&#x2F;5继续阅读</li>
</ul>
</blockquote>
<h3 id="消息队列"><a href="#消息队列" class="headerlink" title="消息队列"></a>消息队列</h3><p>消息队列中间件是<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F&spm=1001.2101.3001.7020">分布式系统</a>中重要的组件，主要解决应用解耦，异步消息，流量削锋等问题，实现高性能，高可用，可伸缩和最终一致性架构。目前使用较多的消息队列有ActiveMQ，RabbitMQ，ZeroMQ，Kafka，MetaMQ，RocketMQ</p>
<h4 id="异步处理"><a href="#异步处理" class="headerlink" title="异步处理"></a>异步处理</h4><blockquote>
<p>引入消息队列，将不是必须的业务逻辑，异步处理。</p>
</blockquote>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230104163020893.png" alt="image-20230104163020893"></p>
<h4 id="应用解耦"><a href="#应用解耦" class="headerlink" title="应用解耦"></a>应用解耦</h4><p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230104163240498.png" alt="image-20230104163240498"></p>
<h4 id="流量削峰"><a href="#流量削峰" class="headerlink" title="流量削峰"></a>流量削峰</h4><p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230104163357668.png" alt="image-20230104163357668"></p>
<blockquote>
<ul>
<li><input disabled type="checkbox"> 可以继续阅读<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_52622200/article/details/119765008">https://blog.csdn.net/weixin_52622200/article/details/119765008</a></li>
</ul>
</blockquote>
<h3 id="Iris"><a href="#Iris" class="headerlink" title="Iris"></a>Iris</h3><p>Iris是一款Go语言中用来开发web应用的框架，该框架支持编写一次并在任何地方以最小的机器功率运行，如Android、ios、Linux和Windows等。该框架只需要一个可执行的服务就可以在平台上运行了。</p>
<p>Iris框架以简单而强大的api而被开发者所熟悉。iris除了为开发者提供非常简单的访问方式外，还同样支持MVC。另外，用iris构建微服务也很容易。</p>
<p>在iris框架的官方网站上，被称为速度最快的Go后端开发框架。在Iris的网站文档上，列出了该框架具备的一些特点和框架特性，列举如下：</p>
<p>1）聚焦高性能</p>
<p>2）健壮的静态路由支持和通配符子域名支持</p>
<p>3）视图系统支持超过5以上模板</p>
<p>4）支持定制事件的高可扩展性Websocket API</p>
<p>5）带有GC, 内存 &amp; redis 提供支持的会话</p>
<p>6）方便的中间件和插件</p>
<p>7）完整 REST API</p>
<p>8）能定制 HTTP 错误</p>
<p>9）源码改变后自动加载</p>
<h3 id="Dubbo"><a href="#Dubbo" class="headerlink" title="Dubbo"></a>Dubbo</h3><p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230104163812693.png" alt="image-20230104163812693"></p>
<blockquote>
<ul>
<li><input disabled type="checkbox"> <a target="_blank" rel="noopener" href="https://cn.dubbo.apache.org/zh/overview/what/overview/">https://cn.dubbo.apache.org/zh/overview/what/overview/</a></li>
</ul>
</blockquote>
<h3 id="了解iuap"><a href="#了解iuap" class="headerlink" title="了解iuap"></a>了解iuap</h3><p>iuap聚焦PaaS、支撑SaaS、适配多种IaaS，遵循开放、开源、生态的发展原则，为企业提供互联网开发、测试、构造、发布、部署、云运维、云运营、云集成等各种平台技术能力，支撑企业构建高并发、高性能、高可用、安全的C2B、O2O、B2B 或B2B2C 等企业互联网应用或服务。</p>
<h3 id="HttpClient"><a href="#HttpClient" class="headerlink" title="HttpClient"></a>HttpClient</h3><h2 id="文档阅读"><a href="#文档阅读" class="headerlink" title="文档阅读"></a>文档阅读</h2><h3 id="认知"><a href="#认知" class="headerlink" title="认知"></a>认知</h3><p>本框架目前针对YonSuite（后续支持采购、财务、人力、协同等各领域云）如何保障各个微服务之间的数据一致性考虑</p>
<p>框架和iuap平台下的MDD、MDF及RPC结合，结合本地数据库事务提交机制，目前支持Mysql。后续逐步支持单纯RPC方式或者HTTP client方式。</p>
<p>技术中台的云端，提供事务监控中心，监控和查看未及时完成的及未正确结束的长事务，支持云端查看错误堆栈、链路拓扑图、下发重试命令等功能。</p>
<h3 id="名词解释"><a href="#名词解释" class="headerlink" title="名词解释"></a>名词解释</h3><p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230104164808975.png" alt="image-20230104164808975"></p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230104164840000.png" alt="image-20230104164840000"></p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230104164850758.png" alt="image-20230104164850758"></p>
<h3 id="功能架构"><a href="#功能架构" class="headerlink" title="功能架构"></a>功能架构</h3><p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230104164925319.png" alt="image-20230104164925319"></p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230104165106147.png" alt="image-20230104165106147"></p>
<h3 id="技术架构设计"><a href="#技术架构设计" class="headerlink" title="技术架构设计"></a>技术架构设计</h3><ul>
<li><p><input disabled type="checkbox"> 
需要再深入了解下事务协调器、事务管理器、运行时（TCC的try、confirm、cancel</p>
</li>
<li><p><input disabled type="checkbox"> 
核心类和枚举</p>
</li>
</ul>
<h3 id="逻辑架构设计"><a href="#逻辑架构设计" class="headerlink" title="逻辑架构设计"></a>逻辑架构设计</h3><h4 id="核心业务场景"><a href="#核心业务场景" class="headerlink" title="核心业务场景"></a>核心业务场景</h4><ul>
<li>销售出库信息回写（MDD）</li>
</ul>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230104165531849.png" alt="image-20230104165531849"></p>
<ul>
<li>财务支付业务凭证（RPC）</li>
</ul>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230104165559017.png" alt="image-20230104165559017"></p>
<ul>
<li>生态应用调用用友云开放服务（HTTP）</li>
</ul>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230104165644171.png" alt="image-20230104165644171"></p>
<h4 id="领域概念模型"><a href="#领域概念模型" class="headerlink" title="领域概念模型"></a>领域概念模型</h4><ul>
<li>BASE理论模型</li>
</ul>
<p>​        通过牺牲强一致性来获得可用性，并允许数据在一段时间内是不一致的，但最终达到一致状态</p>
<ul>
<li><p><strong>基于此的分布式一致性解决方案</strong></p>
<ul>
<li>Sagas模式</li>
<li>TCC模式</li>
<li>异步Sagas模式</li>
<li>基于MQ的可靠消息模式</li>
</ul>
</li>
<li><p>技术支撑设计</p>
<ul>
<li><p>基于Spring的DB事务回调</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230104170219904.png" alt="image-20230104170219904"></p>
</li>
<li><p>分布式事务LOG及状态转换</p>
<ul>
<li>Sagas正向操作的状态扭转</li>
<li>Tcc模式正向操作(Try)状态扭转</li>
<li>Tcc模式确认(Confirm)操作状态扭转</li>
<li>TCC,Sagas模式事务异常cancel操作的状态扭转</li>
</ul>
</li>
<li><p>序列化机制</p>
<p>RPC调用上下文序列化采用Hession协议的二进制协议，hession在上下文包含java枚举以及泛型操作时能够正确处理。在RPC调用前，YTS的sdk将RPC调用的上下文信息，持久化到TransactionRel的数据表中，在确认(Confirm)，回滚(Cancel)时从TransactionRel表中反序列化为RPC调用上下文进行RPC的调用。</p>
</li>
<li><p>统一监控设计</p>
</li>
<li><p>定时扫描数据任务</p>
</li>
</ul>
</li>
</ul>
<h4 id="核心场景及流程"><a href="#核心场景及流程" class="headerlink" title="核心场景及流程"></a>核心场景及流程</h4><ul>
<li>MDD框架正向业务调用</li>
<li>正向调用报错后的业务回滚</li>
<li>回滚报错后的错误信息上报</li>
<li>云端重试命令的下发及执行</li>
<li><strong>分支事务嵌套链式长事务的协调执行</strong></li>
<li><strong>分支事务嵌套链式长事务的逐级回滚</strong></li>
</ul>
<h1 id="MDD-模型驱动开发"><a href="#MDD-模型驱动开发" class="headerlink" title="MDD(模型驱动开发)"></a>MDD(模型驱动开发)</h1><p>传统的瀑布式开发流程如下图，每一个需求的产生都需要进行需求分析、设计、编码、测试等一系列流程。</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230104161534533.png" alt="image-20230104161534533"></p>
<p>模型驱动框架的开发流程如下图：</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230104161552132.png" alt="image-20230104161552132"></p>
<p>模型驱动的优势在于<strong>不用为每个需求定制化的编码</strong>，而是通过高度抽象化的模型映射到具体的业务元数据上来实现需求功能；这样大大减少了编码的重复工作，同时也提高了软件的可变更性。</p>
<h2 id="模型驱动架构（MDA，Model-Driven-Architecture）"><a href="#模型驱动架构（MDA，Model-Driven-Architecture）" class="headerlink" title="模型驱动架构（MDA，Model Driven Architecture）"></a>模型驱动架构（MDA，Model Driven Architecture）</h2><p>MDA的三大目标：轻便可移植性、互操作性和可重用性，采用了模型和技术分离的架构设计。</p>
<p>使用一定的建模标准（UML、MOF、XMI等）构建描述应用程序或集成系统的业务功能和行为的模型，这些模型独立于具体平台并且和实现具体业务功能和行为的特定技术代码分离，从而实现了业务和应用程序逻辑与底层平台技术的分离，这种分离也带来了应用程序的核心与技术变化周期的隔离。系统的业务部分和技术部分都可以各自进化而互不影响 - 业务逻辑响应业务需求，技术部分按业务需要利用新的技术开发。</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230104162015402.png" alt="image-20230104162015402"></p>
<p>上图为MDA 结构示意图。最左侧为OMG提出的架构理论，其次是 MDA 的核心技术：<strong>MOF</strong> （ Meta Object Facility ，元对象设施）、 <strong>CWM</strong> （Common Warehouse Metamodel ，公共数据仓库元模型）和 <strong>UML</strong> . MDA 的主要工作就是要把基于这些技术建立的PIM 转换到不同的中间件平台上，得到对应的 PSM .PSM中给出的是目前主要针对的实现平台：CORBA 、 XML 、JAVA 、 Web Services 和 .NET .显然，随着技术的发展，这个列表将不断扩充。最后是基于PSM平台相关模型在公共服务及垂直领域等组件或应用中进行模型驱动开发。</p>
<h2 id="领域驱动设计-x2F-模型驱动设计（DDD，Domain-Driven-Design）"><a href="#领域驱动设计-x2F-模型驱动设计（DDD，Domain-Driven-Design）" class="headerlink" title="领域驱动设计&#x2F;模型驱动设计（DDD，Domain-Driven Design）"></a>领域驱动设计&#x2F;模型驱动设计（DDD，Domain-Driven Design）</h2><p>DDD是由Eric Evans最先提出，目的是对软件所涉及到的领域进行建模，以应对系统规模过大时引起的软件复杂性的问题。整个过程大概是这样的，开发团队和领域专家一起通过通用语言（Ubiquitous Language）去理解和消化领域知识，从领域知识中提取和划分为一个一个的子领域（核心子域，通用子域，支撑子域），并在子领域上建立模型，再重复以上步骤，这样周而复始，构建出一套符合当前领域的模型。</p>
<p>建模的过程是由不同阶段的成员来完成，有些模型之间有引用关系，应用软件通过所有人的建模工作而构建起来。</p>
<h2 id="模型驱动开发（MDD，-Model-Driven-Development）"><a href="#模型驱动开发（MDD，-Model-Driven-Development）" class="headerlink" title="模型驱动开发（MDD， Model Driven Development）"></a>模型驱动开发（MDD， Model Driven Development）</h2><p>模型驱动开发框架（MDF， MDD Framework）</p>
<p>MDF 实际上就是一套开发框架，可以是基于spring、spring boot 等技术开发框架搭建的<strong>脚手架</strong>，承载了模型驱动相关的设计、开发方法等的编码框架。</p>
<p>MDA环境下的系统开发方式就是在开发活动中通过创建各种模型精确描述不同的问题域，并利用模型转换来驱动包括分析、设计和实现等在内的整个软件开发过程。</p>
<p>不难看出<strong>MDA说的是整体的软件架构设计使用的是模型驱动；而在软件开发的过程中，对不同领域的业务需求进行分析、抽象建模和技术框架分层所常用的分析方法就是DDD；整个软件的开发活动就称之为MDD</strong>。</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230104162435789.png" alt="image-20230104162435789"></p>
<p>​        MDA架构设计中，MDA需要从需求采集和理解业务需求开始；PIM和PSM可以由不同团队完成，独立工作，但是组合后能产生健壮的业务解决方案；整个流程中模型转化和相关模型的驱动引擎是核心。</p>
<p>　　接下来重点了解一下我们的MDD的脚手架（MDF）都做了什么？</p>
<p>　　在脚手架中主要的是通过元数据SDK、规则SDK、UI元数据SDK和其他相关支持工具包完成对整体的模型驱动开发支持的。其中元数据SDK包含业务元数据的建模、数据查询等相关功能；UI元数据SDK包含了UI模板定义查询相关功能，搭配Node的前端驱动项目进行UI模板的渲染和组件的过滤展示等；而规则SDK包含了对于业务数据CRUD的默认规则、编码规则、唯一性校验规则、参照查询规则以及卡片翻页等默认规则。接下来让通过一个更完整的图来看MDD开发脚手架。</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230104162523785.png" alt="image-20230104162523785"></p>
<p>​        首先，需求输出到开发阶段，根据需求设计抽取定义业务元数据，及页面设计的UI元数据。</p>
<p>　　其次，业务元数据通过XML或统一中央元数据仓库的形式加载到脚手架项目启动中。</p>
<p>　　再次，浏览器访问node前端，node前端路由请求到java后端Controller.</p>
<p>　　最后，后端处理逻辑在规则执行引擎中执行相应的规则，分别查询UI元数据用于页面渲染，以及业务数据的查询。并将结果返回给node前端做渲染展示。</p>
<p>　　目前脚手架功能中部分扩展功能上图没有体现，这些扩展功能包括：</p>
<p>　　a. UI元数据查询逻辑通过规则引擎查询，可通过增加前置或后置规则进行功能扩展；UI元数据支持远程获取；</p>
<p>　　b. Redis 是否使用可通过开关配置。并支持单机模式，哨兵模式，集群模式配置；</p>
<p>　　c. MySQL数据库支持规则、UI元数据和业务数据区分不同的数据源存储；</p>
<p>　　d. 支持Ali OSS 存储；</p>
<p>　　e. 支持基于ES的参照及翻译；</p>
<p>　　f. 接入统一三方包管理和统一异常及日志；</p>
<p>　　g. 支持MySQL、Redis、应用基本信息、环境信息等的健康检查与监控；</p>
<p>　　以上就是MDD的基本实现原理和功能描述，整体看上去还是很简单清晰的。</p>
<p><strong>总结展望</strong></p>
<p>　　下面通过下图表达一下模型驱动开发的优势</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230104162552160.png" alt="image-20230104162552160"></p>
<blockquote>
<p>继续阅读：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43145299/article/details/122623568">https://blog.csdn.net/weixin_43145299/article/details/122623568</a></p>
</blockquote>
<h1 id="YMS文档"><a href="#YMS文档" class="headerlink" title="YMS文档"></a>YMS文档</h1>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://liketostudy.com/2022/08/25/Linux%E5%9F%BA%E7%A1%80-06-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F%E6%8E%A7%E5%88%B6%E4%B8%8E%E7%AE%A1%E9%81%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="文晨">
      <meta itemprop="description" content="百学须先立志">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="琛的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/25/Linux%E5%9F%BA%E7%A1%80-06-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F%E6%8E%A7%E5%88%B6%E4%B8%8E%E7%AE%A1%E9%81%93/" class="post-title-link" itemprop="url">Linux基础-06-命令执行顺序控制与管道</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-08-25 15:18:45" itemprop="dateCreated datePublished" datetime="2022-08-25T15:18:45+08:00">2022-08-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-01-17 10:32:18" itemprop="dateModified" datetime="2023-01-17T10:32:18+08:00">2023-01-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Linux基础-06-命令执行顺序控制与管道"><a href="#Linux基础-06-命令执行顺序控制与管道" class="headerlink" title="Linux基础-06-命令执行顺序控制与管道"></a>Linux基础-06-命令执行顺序控制与管道</h1><h2 id="命令控制顺序"><a href="#命令控制顺序" class="headerlink" title="命令控制顺序"></a>命令控制顺序</h2><p>当我们需要使用 <code>apt-get</code> 安装一个软件，然后安装完成后立即运行安装的软件或命令工具，又恰巧你的主机才更换的软件源还没有更新软件列表（比如之前我们的环境中，每次重新开始实验就得 <code>sudo apt-get update</code>，否则可能会报错提示 404），那么你可能会有如下一系列操作：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line"><span class="comment"># 等待执行完毕，然后输入下面的命令</span></span><br><span class="line">sudo apt-get install some-tool <span class="comment"># 这里 some-tool 需要替换成具体的软件包</span></span><br><span class="line"><span class="comment"># 等待安装完毕，然后输入软件包名称执行</span></span><br><span class="line">some-tool</span><br></pre></td></tr></table></figure>

<p>这时你可能就会想：要是我可以一次性输入完，让它自己去依次执行各命令就好了，这就是我们这一小节要解决的问题。</p>
<p>简单的顺序执行你可以使用 <code>;</code> 来完成，比如上述操作你可以：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update;sudo apt-get install some-tool;some-tool <span class="comment"># 让它自己运行</span></span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">which</span> cowsay&gt;/dev/null &amp;&amp; cowsay -f head-in ohch~</span><br></pre></td></tr></table></figure>

<p>你如果没有安装 <code>cowsay</code>，你可以先执行一次上述命令，你会发现什么也没发生，你再安装好之后你再执行一次上述命令，你也会发现一些惊喜。</p>
<p>上面的 <code>&amp;&amp;</code> 就是用来实现选择性执行的，它表示如果前面的命令执行结果（不是表示终端输出的内容，而是表示命令执行状态的结果）返回 0 则执行后面的，否则不执行，你可以从 <code>$?</code> 环境变量获取上一次命令的返回结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">which</span> cowsay&gt;/dev/null || <span class="built_in">echo</span> <span class="string">&quot;cowsay has not been install, please run &#x27;sudo apt-get install cowsay&#x27; to install&quot;</span></span><br></pre></td></tr></table></figure>

<p>除了上述基本的使用之外，我们还可以结合着 <code>&amp;&amp;</code> 和 <code>||</code> 来实现一些操作，比如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">which</span> cowsay&gt;/dev/null &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;exist&quot;</span> || <span class="built_in">echo</span> <span class="string">&quot;not exist&quot;</span></span><br></pre></td></tr></table></figure>

<p>我画个流程图来解释一下上面的流程：</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20220825163901684.png" alt="image-20220825163901684"></p>
<h2 id="管道"><a href="#管道" class="headerlink" title="管道"></a>管道</h2><p>管道是一种通信机制，通常用于进程间的通信（也可通过 socket 进行网络通信），它表现出来的形式<strong>就是将前面每一个进程的输出（stdout）直接作为下一个进程的输入（stdin）</strong>。</p>
<p>管道又分为匿名管道和具名管道（这里将不会讨论在源程序中使用系统调用创建并使用管道的情况，它与命令行的管道在内核中实际都是采用相同的机制）。我们在使用一些过滤程序时经常会用到的就是匿名管道，在命令行中由 <code>|</code> 分隔符表示，<code>|</code> 在前面的内容中我们已经多次使用到了。具名管道简单的说就是有名字的管道，通常只会在源程序中用到具名管道。下面我们就将通过一些常用的可以使用管道的过滤程序来帮助你熟练管道的使用。</p>
<p>先试用一下管道，比如查看 <code>/etc</code> 目录下有哪些文件和目录，使用 <code>ls</code> 命令来查看：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -al /etc</span><br></pre></td></tr></table></figure>

<p>有太多内容，屏幕不能完全显示，这时候可以使用滚动条或快捷键滚动窗口来查看。不过这时候可以使用管道：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -al /etc | less</span><br></pre></td></tr></table></figure>

<p>通过管道将前一个命令(<code>ls</code>)的输出作为下一个命令(<code>less</code>)的输入，然后就可以一行一行地看。</p>
<h2 id="cut命令"><a href="#cut命令" class="headerlink" title="cut命令"></a>cut命令</h2><p>打印每一行的某一字段</p>
<p>打印 <code>/etc/passwd</code> 文件中以 <code>:</code> 为分隔符的第 1 个字段和第 6 个字段分别表示用户名和其家目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cut</span> /etc/passwd -d <span class="string">&#x27;:&#x27;</span> -f 1,6</span><br></pre></td></tr></table></figure>

<p>打印 <code>/etc/passwd</code> 文件中每一行的前 N 个字符：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 前五个（包含第五个）</span></span><br><span class="line"><span class="built_in">cut</span> /etc/passwd -c -5</span><br><span class="line"><span class="comment"># 前五个之后的（包含第五个）</span></span><br><span class="line"><span class="built_in">cut</span> /etc/passwd -c 5-</span><br><span class="line"><span class="comment"># 第五个</span></span><br><span class="line"><span class="built_in">cut</span> /etc/passwd -c 5</span><br><span class="line"><span class="comment"># 2 到 5 之间的（包含第五个）</span></span><br><span class="line"><span class="built_in">cut</span> /etc/passwd -c 2-5</span><br></pre></td></tr></table></figure>

<h2 id="grep命令"><a href="#grep命令" class="headerlink" title="grep命令"></a>grep命令</h2><p><code>grep</code> 命令是很强大的，也是相当常用的一个命令，它结合正则表达式可以实现很复杂却很高效的匹配和查找，不过在学习正则表达式之前，这里介绍它简单的使用，而关于正则表达式后面将会有单独一小节介绍到时会再继续学习 <code>grep</code> 命令和其他一些命令。</p>
<p><code>grep</code> 命令的一般形式为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep [命令选项]... 用于匹配的表达式 [文件]...</span><br></pre></td></tr></table></figure>

<p>还是先体验一下，我们搜索<code>/home/shiyanlou</code>目录下所有包含”shiyanlou”的文本文件，并显示出现在文本中的行号：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -rnI <span class="string">&quot;shiyanlou&quot;</span> ~</span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20220825164541667.png" alt="image-20220825164541667"></p>
<p><code>-r</code> 参数表示递归搜索子目录中的文件，<code>-n</code> 表示打印匹配项行号，<code>-I</code> 表示忽略二进制文件。这个操作实际没有多大意义，但可以感受到 <code>grep</code> 命令的强大与实用。</p>
<p>当然也可以在匹配字段中使用正则表达式，下面简单的演示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看环境变量中以 &quot;yanlou&quot; 结尾的字符串</span></span><br><span class="line"><span class="built_in">export</span> | grep <span class="string">&quot;.*yanlou$&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20220825164632617.png" alt="image-20220825164632617"></p>
<p>其中<code>$</code>就表示一行的末尾</p>
<h2 id="wc命令"><a href="#wc命令" class="headerlink" title="wc命令"></a>wc命令</h2><p>wc 命令用于统计并输出一个文件中行、单词和字节的数目，比如输出 <code>/etc/passwd</code> 文件的统计信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">wc</span> /etc/passwd</span><br></pre></td></tr></table></figure>

<p>分别只输出行数、单词数、字节数、字符数和输入文本中最长一行的字节数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 行数</span></span><br><span class="line"><span class="built_in">wc</span> -l /etc/passwd</span><br><span class="line"><span class="comment"># 单词数</span></span><br><span class="line"><span class="built_in">wc</span> -w /etc/passwd</span><br><span class="line"><span class="comment"># 字节数</span></span><br><span class="line"><span class="built_in">wc</span> -c /etc/passwd</span><br><span class="line"><span class="comment"># 字符数</span></span><br><span class="line"><span class="built_in">wc</span> -m /etc/passwd</span><br><span class="line"><span class="comment"># 最长行字节数</span></span><br><span class="line"><span class="built_in">wc</span> -L /etc/passwd</span><br></pre></td></tr></table></figure>

<p><strong>注意：对于西文字符来说，一个字符就是一个字节，但对于中文字符一个汉字是大于 2 个字节的，具体数目是由字符编码决定的。</strong></p>
<p>再来结合管道来操作一下，下面统计 &#x2F;etc 下面所有目录数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -dl /etc/*/ | <span class="built_in">wc</span> -l</span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20220825164745848.png" alt="image-20220825164745848"></p>
<h2 id="sort命令"><a href="#sort命令" class="headerlink" title="sort命令"></a>sort命令</h2><p>这个命令前面我们也是用过多次，功能很简单就是将输入按照一定方式排序，然后再输出，它支持的排序有按字典排序，数字排序，按月份排序，随机排序，反转排序，指定特定字段进行排序等等。</p>
<p>默认为字典排序：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/passwd | <span class="built_in">sort</span></span><br></pre></td></tr></table></figure>

<p>反转排序：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/passwd | <span class="built_in">sort</span> -r</span><br></pre></td></tr></table></figure>

<p>按特定字段排序：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/passwd | <span class="built_in">sort</span> -t<span class="string">&#x27;:&#x27;</span> -k 3</span><br></pre></td></tr></table></figure>

<p>上面的<code>-t</code>参数用于指定字段的分隔符，这里是以”:”作为分隔符；<code>-k 字段号</code>用于指定对哪一个字段进行排序。这里<code>/etc/passwd</code>文件的第三个字段为数字，默认情况下是以字典序排序的，如果要按照数字排序就要加上<code>-n</code>参数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/passwd | <span class="built_in">sort</span> -t<span class="string">&#x27;:&#x27;</span> -k 3 -n</span><br></pre></td></tr></table></figure>

<p>注意观察第二个冒号后的数字：</p>
<h2 id="uniq去重命令"><a href="#uniq去重命令" class="headerlink" title="uniq去重命令"></a>uniq去重命令</h2><p><code>uniq</code> 命令可以用于过滤或者输出重复行。</p>
<ul>
<li>过滤重复行</li>
</ul>
<p>我们可以使用 <code>history</code> 命令查看最近执行过的命令（实际为读取 <code>$&#123;SHELL&#125;_history</code> 文件，如我们环境中的 <code>.zsh_history</code> 文件），不过你可能只想查看使用了哪个命令而不需要知道具体干了什么，那么你可能就会要想去掉命令后面的参数然后去掉重复的命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">history</span> | <span class="built_in">cut</span> -c 8- | <span class="built_in">cut</span> -d <span class="string">&#x27; &#x27;</span> -f 1 | <span class="built_in">uniq</span></span><br></pre></td></tr></table></figure>

<p>然后经过层层过滤，你会发现确是只输出了执行的命令那一列，不过去重效果好像不明显，仔细看你会发现它确实去重了，只是不那么明显，之所以不明显是因为 <code>uniq</code> 命令只能去连续重复的行，不是全文去重，所以要达到预期效果，我们先排序：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">history</span> | <span class="built_in">cut</span> -c 8- | <span class="built_in">cut</span> -d <span class="string">&#x27; &#x27;</span> -f 1 | <span class="built_in">sort</span> | <span class="built_in">uniq</span></span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line"><span class="built_in">history</span> | <span class="built_in">cut</span> -c 8- | <span class="built_in">cut</span> -d <span class="string">&#x27; &#x27;</span> -f 1 | <span class="built_in">sort</span> -u</span><br></pre></td></tr></table></figure>

<p>这就是 Linux&#x2F;UNIX 哲学吸引人的地方，大繁至简，一个命令只干一件事却能干到最好。</p>
<ul>
<li>输出重复行</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 输出重复过的行（重复的只输出一个）及重复次数</span></span><br><span class="line"><span class="built_in">history</span> | <span class="built_in">cut</span> -c 8- | <span class="built_in">cut</span> -d <span class="string">&#x27; &#x27;</span> -f 1 | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -dc</span><br><span class="line"><span class="comment"># 输出所有重复的行</span></span><br><span class="line"><span class="built_in">history</span> | <span class="built_in">cut</span> -c 8- | <span class="built_in">cut</span> -d <span class="string">&#x27; &#x27;</span> -f 1 | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -D</span><br></pre></td></tr></table></figure>

<p>文本处理命令还有很多，下一节将继续介绍一些常用的文本处理的命令。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://liketostudy.com/2022/08/25/Linux%E5%9F%BA%E7%A1%80-05-%E5%B8%AE%E5%8A%A9%E5%91%BD%E4%BB%A4%E5%8F%8A%E5%AE%9A%E6%9C%9F%E4%BB%BB%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="文晨">
      <meta itemprop="description" content="百学须先立志">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="琛的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/25/Linux%E5%9F%BA%E7%A1%80-05-%E5%B8%AE%E5%8A%A9%E5%91%BD%E4%BB%A4%E5%8F%8A%E5%AE%9A%E6%9C%9F%E4%BB%BB%E5%8A%A1/" class="post-title-link" itemprop="url">Linux基础-05-帮助命令及定期任务</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-08-25 15:08:45 / 修改时间：16:00:36" itemprop="dateCreated datePublished" datetime="2022-08-25T15:08:45+08:00">2022-08-25</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Linux基础-05-帮助命令及定期任务"><a href="#Linux基础-05-帮助命令及定期任务" class="headerlink" title="Linux基础-05-帮助命令及定期任务"></a>Linux基础-05-帮助命令及定期任务</h1><h2 id="内建命令与外部命令"><a href="#内建命令与外部命令" class="headerlink" title="内建命令与外部命令"></a>内建命令与外部命令</h2><p>什么是内建命令，什么是外部命令呢？这和帮助命令又有什么关系呢？</p>
<p>因为有一些查看帮助的工具在内建命令与外建命令上是有区别对待的。</p>
<blockquote>
<p><strong>内建命令</strong>实际上是 shell 程序的一部分，其中包含的是一些比较简单的 Linux 系统命令，这些命令是写在 bash 源码的 builtins 里面的，由 shell 程序识别并在 shell 程序内部完成运行，通常在 Linux 系统加载运行时 shell 就被加载并驻留在系统内存中。而且解析内部命令 shell 不需要创建子进程，因此其执行速度比外部命令快。比如：history、cd、exit 等等。</p>
</blockquote>
<blockquote>
<p><strong>外部命令</strong>是 Linux 系统中的实用程序部分，因为实用程序的功能通常都比较强大，所以其包含的程序量也会很大，在系统加载时并不随系统一起被加载到内存中，而是在需要时才将其调入内存。虽然其不包含在 shell 中，但是其命令执行过程是由 shell 程序控制的。外部命令是在 Bash 之外额外安装的，通常放在&#x2F;bin，&#x2F;usr&#x2F;bin，&#x2F;sbin，&#x2F;usr&#x2F;sbin 等等。比如：ls、vi 等。</p>
</blockquote>
<p>简单来说就是：一个是天生自带的天赋技能，一个是后天得来的附加技能。我们可以使用 type 命令来区分命令是内建的还是外部的。例如这两个得出的结果是不同的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> <span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">type</span> vim</span><br></pre></td></tr></table></figure>

<p>得到的是两种结果，若是对 ls 你还能得到第三种结果</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20220825150935431.png" alt="image-20220825150935431"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 得到这样的结果说明是内建命令，正如上文所说内建命令都是在 bash 源码中的 builtins 的.def中</span></span><br><span class="line">xxx is a shell <span class="built_in">builtin</span></span><br><span class="line"><span class="comment"># 得到这样的结果说明是外部命令，正如上文所说，外部命令在/usr/bin or /usr/sbin等等中</span></span><br><span class="line">xxx is /usr/bin/xxx</span><br><span class="line"><span class="comment"># 若是得到alias的结果，说明该指令为命令别名所设定的名称；</span></span><br><span class="line">xxx is an <span class="built_in">alias</span> <span class="keyword">for</span> xx --xxx</span><br></pre></td></tr></table></figure>

<h3 id="help命令"><a href="#help命令" class="headerlink" title="help命令"></a>help命令</h3><p>本实验环境是 zsh，而 zsh 中内置并没有 help 命令，我们可以进入 bash 中，在 bash 中内置有该命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash</span><br></pre></td></tr></table></figure>

<p>做好了以上的准备，我们就可以愉快的使用 help 命令了，我们可以尝试下这个命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">help</span> <span class="built_in">ls</span></span><br></pre></td></tr></table></figure>

<p>得到的结果如图所示，为什么是这样的结果？</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20220825151258857.png" alt="image-20220825151258857"></p>
<p>因为 help 命令是用于显示 shell 内建命令的简要帮助信息。帮助信息中显示有该命令的简要说明以及一些参数的使用以及说明，一定记住 help 命令只能用于显示内建命令的帮助信息，不然就会得到你刚刚得到的结果。</p>
<p>那如果是外部命令怎么办，不能就这么抛弃它呀。其实外部命令基本上都有一个参数 <code>--help</code>，这样就可以得到相应的帮助，看到你想要的东西了。试试下面这个命令是不是能看到你想要的东西了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> --<span class="built_in">help</span></span><br></pre></td></tr></table></figure>

<h3 id="man命令"><a href="#man命令" class="headerlink" title="man命令"></a>man命令</h3><p>你可以尝试下这个命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">man <span class="built_in">ls</span></span><br></pre></td></tr></table></figure>

<p>得到的内容比用 help 更多更详细，而且 man 没有内建与外部命令的区分，因为 man 工具是显示系统手册页中的内容，也就是一本电子版的字典，这些内容大多数都是对命令的解释信息，还有一些相关的描述。通过查看系统文档中的 man 也可以得到程序的更多相关信息和 Linux 的更多特性。</p>
<p>是不是好用许多，当然也不代表 help 就没有存在的必要，当你非常紧急只是忘记该用哪个参数的时候，help 这种显示简单扼要的信息就特别实用，若是不太紧急的时候就可以用 man 这种详细描述的查询方式</p>
<p>在尝试上面这个命令时我们会发现最左上角显示“ LS （1）”，在这里，“ LS ”表示手册名称，而“（1）”表示该手册位于第一章节。这个章节又是什么？在 man 手册中一共有这么几个章节</p>
<table>
<thead>
<tr>
<th>章节数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>1</code></td>
<td>Standard commands （标准命令）</td>
</tr>
<tr>
<td><code>2</code></td>
<td>System calls （系统调用）</td>
</tr>
<tr>
<td><code>3</code></td>
<td>Library functions （库函数）</td>
</tr>
<tr>
<td><code>4</code></td>
<td>Special devices （设备说明）</td>
</tr>
<tr>
<td><code>5</code></td>
<td>File formats （文件格式）</td>
</tr>
<tr>
<td><code>6</code></td>
<td>Games and toys （游戏和娱乐）</td>
</tr>
<tr>
<td><code>7</code></td>
<td>Miscellaneous （杂项）</td>
</tr>
<tr>
<td><code>8</code></td>
<td>Administrative Commands （管理员命令）</td>
</tr>
<tr>
<td><code>9</code></td>
<td>其他（Linux 特定的）， 用来存放内核例行程序的文档。</td>
</tr>
</tbody></table>
<p>打开手册之后我们可以通过 pgup 与 pgdn 或者上下键来上下翻看，可以按 q 退出当前页面</p>
<h3 id="info命令"><a href="#info命令" class="headerlink" title="info命令"></a>info命令</h3><p>要是你觉得 man 显示的信息都还不够，满足不了你的需求，那试试 info 命令，注意实验楼的环境中没有安装 info，可以手动安装，安装和操作步骤如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 info</span></span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install info</span><br><span class="line"><span class="comment"># 查看 ls 命令的 info</span></span><br><span class="line">info <span class="built_in">ls</span></span><br></pre></td></tr></table></figure>

<p>得到的信息是不是比 man 还要多了，info 来自自由软件基金会的 GNU 项目，是 GNU 的超文本帮助系统，能够更完整的显示出 GNU 信息。所以得到的信息当然更多</p>
<p>man 和 info 就像两个集合，它们有一个交集部分，但与 man 相比，info 工具可显示更完整的 GNU 工具信息。若 man 页包含的某个工具的概要信息在 info 中也有介绍，那么 man 页中会有“请参考 info 页更详细内容”的字样。</p>
<h2 id="定期任务"><a href="#定期任务" class="headerlink" title="定期任务"></a>定期任务</h2><h3 id="crontab-命令"><a href="#crontab-命令" class="headerlink" title="crontab 命令"></a>crontab 命令</h3><p>crontab 命令常见于 Unix 和类 Unix 的操作系统之中（Linux 就属于类 Unix 操作系统），用于设置周期性被执行的指令。</p>
<p>crontab 命令从输入设备读取指令，并将其存放于 crontab 文件中，以供之后读取和执行。通常，crontab 储存的指令被守护进程激活，crond 为其守护进程，crond 常常在后台运行，每一分钟会检查一次是否有预定的作业需要执行。</p>
<p>通过 crontab 命令，我们可以在固定的间隔时间执行指定的系统指令或 shell 脚本。时间间隔的单位可以是分钟、小时、日、月、周的任意组合。</p>
<p>这里我们看一看 crontab 的格式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Example of job definition:</span></span><br><span class="line"><span class="comment"># .---------------- minute (0 - 59)</span></span><br><span class="line"><span class="comment"># |  .------------- hour (0 - 23)</span></span><br><span class="line"><span class="comment"># |  |  .---------- day of month (1 - 31)</span></span><br><span class="line"><span class="comment"># |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...</span></span><br><span class="line"><span class="comment"># |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat</span></span><br><span class="line"><span class="comment"># |  |  |  |  |</span></span><br><span class="line"><span class="comment"># *  *  *  *  * user-name command to be executed</span></span><br></pre></td></tr></table></figure>

<p>crontab 在本实验环境中需要做一些特殊的准备，首先我们会启动 <code>rsyslog</code>，以便我们可以通过日志中的信息来了解我们的任务是否真正的被执行了（在本实验环境中需要手动启动，而在自己本地中 Ubuntu 会默认自行启动不需要手动启动）。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install -y rsyslog</span><br><span class="line">sudo service rsyslog start</span><br></pre></td></tr></table></figure>

<p>在本实验环境中 crontab 也是不被默认启动的，同时不能在后台由 upstart 来管理，所以需要我们来启动它:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cron －f &amp;</span><br></pre></td></tr></table></figure>

<p>下面将开始 crontab 的使用了，我们通过下面一个命令来添加一个计划任务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crontab -e</span><br></pre></td></tr></table></figure>

<p>第一次启动会出现这样一个画面，这是让我们选择编辑的工具，选择第二个基本的 vim 就可以了。</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20220825153119031.png" alt="image-20220825153119031"></p>
<p>详细的格式可以使用上一节中学习到的 man 命令查看：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">man crontab</span><br></pre></td></tr></table></figure>

<p>在了解命令格式之后，我们通过这样的一个例子来完成一个任务的添加，在文档的最后一排加上这样一排命令，该任务是每分钟我们会在&#x2F;home&#x2F;shiyanlou 目录下创建一个以当前的年月日时分秒为名字的空白文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*/1 * * * * <span class="built_in">touch</span> /home/shiyanlou/$(<span class="built_in">date</span> +\%Y\%m\%d\%H\%M\%S)</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong></p>
<blockquote>
<p>“ % ” 在 crontab 文件中，有结束命令行、换行、重定向的作用，前面加 ” \ ” 符号转义，否则，“ % ” 符号将执行其结束命令行或者换行的作用，并且其后的内容会被做为标准输入发送给前面的命令。</p>
</blockquote>
<p>添加成功后我们会得到最后一排 installing new crontab 的一个提示：</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20220825153152738.png" alt="image-20220825153152738"></p>
<p>当然我们也可以通过这样的一个指令来查看我们添加了哪些任务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crontab -l</span><br></pre></td></tr></table></figure>

<p>通过图中的显示，我们也可以看出，我们正确的保存并且添加成功了该任务的：</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20220825153207871.png" alt="image-20220825153207871"></p>
<p>虽然我们添加了任务，但是如果 <code>cron</code> 的守护进程并没有启动，它根本都不会监测到有任务，当然也就不会帮我们执行，我们可以通过以下 2 种方式来确定我们的 <code>cron</code> 是否成功的在后台启动，默默的帮我们做事，若是没有就得执行上文准备中的第二步了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ps aux | grep cron</span><br><span class="line"></span><br><span class="line"><span class="comment"># or</span></span><br><span class="line"></span><br><span class="line">pgrep cron</span><br></pre></td></tr></table></figure>

<p>通过下图可以看到任务在创建之后，执行了几次，生成了一些文件，且每分钟生成一个：</p>
<p>我们通过这样一个命令可以查看到执行任务命令之后在日志中的信息反馈：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">tail</span> -f /var/log/syslog</span><br></pre></td></tr></table></figure>

<p>从图中我们可以看到分别在 13 点 28、29、30 分的 01 秒为我们在 shiyanlou 用户的家目录下创建了文件。</p>
<p>当我们并不需要这个任务的时候我们可以使用这么一个命令去删除任务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crontab -r</span><br></pre></td></tr></table></figure>

<p>通过图中我们可以看出我们删除之后再查看任务列表，系统已经显示该用户并没有任务哦。</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20220825153318309.png" alt="image-20220825153318309"></p>
<h3 id="深入"><a href="#深入" class="headerlink" title="深入"></a>深入</h3><p>每个用户使用 <code>crontab -e</code> 添加计划任务，都会在 <code>/var/spool/cron/crontabs</code> 中添加一个该用户自己的任务文档，这样目的是为了隔离。</p>
<p>如果是系统级别的定时任务，需要 root 权限执行的任务应该怎么处理？</p>
<p>只需要使用 <code>sudo</code> 编辑 <code>/etc/crontab</code> 文件就可以。</p>
<p><code>cron</code> 服务监测时间最小单位是分钟，所以 <code>cron</code> 会每分钟去读取一次 <code>/etc/crontab</code> 与 <code>/var/spool/cron/crontabs</code> 里面的內容。</p>
<p>在 <code>/etc</code> 目录下，<code>cron</code> 相关的目录有下面几个：</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20220825153412282.png" alt="image-20220825153412282"></p>
<p>每个目录的作用：</p>
<ol>
<li><code>/etc/cron.daily</code>，目录下的脚本会每天执行一次，在每天的 6 点 25 分时运行；</li>
<li><code>/etc/cron.hourly</code>，目录下的脚本会每个小时执行一次，在每小时的 17 分钟时运行；</li>
<li><code>/etc/cron.monthly</code>，目录下的脚本会每月执行一次，在每月 1 号的 6 点 52 分时运行；</li>
<li><code>/etc/cron.weekly</code>，目录下的脚本会每周执行一次，在每周第七天的 6 点 47 分时运行；</li>
</ol>
<p>系统默认执行时间可以根据需求进行修改。</p>
<h2 id="挑战：备份日志"><a href="#挑战：备份日志" class="headerlink" title="挑战：备份日志"></a>挑战：备份日志</h2><p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20220825160033681.png" alt="image-20220825160033681"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://liketostudy.com/2022/08/25/Linux%E5%9F%BA%E7%A1%80-04-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%93%8D%E4%BD%9C%E4%B8%8E%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="文晨">
      <meta itemprop="description" content="百学须先立志">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="琛的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/25/Linux%E5%9F%BA%E7%A1%80-04-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%93%8D%E4%BD%9C%E4%B8%8E%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/" class="post-title-link" itemprop="url">Linux基础-04-文件系统操作与磁盘管理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-08-25 14:24:45 / 修改时间：15:07:24" itemprop="dateCreated datePublished" datetime="2022-08-25T14:24:45+08:00">2022-08-25</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Linux基础-04-文件系统操作与磁盘管理"><a href="#Linux基础-04-文件系统操作与磁盘管理" class="headerlink" title="Linux基础-04-文件系统操作与磁盘管理"></a>Linux基础-04-文件系统操作与磁盘管理</h1><p>df, du, mount</p>
<h2 id="查看磁盘容量和目录容量"><a href="#查看磁盘容量和目录容量" class="headerlink" title="查看磁盘容量和目录容量"></a>查看磁盘容量和目录容量</h2><ul>
<li>使用 <code>df</code> 命令查看磁盘的容量</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">df</span></span><br></pre></td></tr></table></figure>

<p>物理主机上的 <code>/dev/sda2</code> 是对应着主机硬盘的分区，后面的数字表示分区号，数字前面的字母 a 表示第几块硬盘（也可能是可移动磁盘），你如果主机上有多块硬盘则可能还会出现 <code>/dev/sdb</code>，<code>/dev/sdc</code> 这些磁盘设备都会在 <code>/dev</code> 目录下以文件的存在形式。</p>
<p>接着你还会看到”1k-块”这个陌生的东西，它表示以磁盘块大小的方式显示容量，后面为相应的以块大小表示的已用和可用容量，在你了解 Linux 的文件系统之前这个就先不管吧，我们以一种你应该看得懂的方式展示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">df</span> -h</span><br></pre></td></tr></table></figure>

<p>现在你就可以使用命令查看你主机磁盘的使用情况了。至于挂载点如果你还记得前面第 4 节介绍 Linux 目录树结构的内容，那么你就应该能很好的理解挂载的概念，这里就不再赘述。</p>
<ul>
<li>使用 <code>du</code> 命令查看目录的容量</li>
</ul>
<p>这个命令前面其实已经用了很多次了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 默认同样以块的大小展示</span></span><br><span class="line"><span class="built_in">du</span></span><br><span class="line"><span class="comment"># 加上 `-h` 参数，以更易读的方式展示</span></span><br><span class="line"><span class="built_in">du</span> -h</span><br></pre></td></tr></table></figure>

<p><code>-d</code> 参数指定查看目录的深度</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只查看 1 级目录的信息</span></span><br><span class="line"><span class="built_in">du</span> -h -d 0 ~</span><br><span class="line"><span class="comment"># 查看 2 级</span></span><br><span class="line"><span class="built_in">du</span> -h -d 1 ~</span><br></pre></td></tr></table></figure>

<p>常用参数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">du</span> -h <span class="comment"># 同 --human-readable 以 K，M，G 为单位，提高信息的可读性。</span></span><br><span class="line"><span class="built_in">du</span> -a <span class="comment"># 同 --all 显示目录中所有文件的大小。</span></span><br><span class="line"><span class="built_in">du</span> -s <span class="comment"># 同 --summarize 仅显示总计，只列出最后加总的值。</span></span><br></pre></td></tr></table></figure>

<h2 id="虚拟磁盘等"><a href="#虚拟磁盘等" class="headerlink" title="虚拟磁盘等"></a>虚拟磁盘等</h2><h3 id="dd-命令"><a href="#dd-命令" class="headerlink" title="dd 命令"></a>dd 命令</h3><h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p><code>dd</code> 命令用于转换和复制文件，不过它的复制不同于 <code>cp</code>。之前提到过关于 Linux 的很重要的一点，<strong>一切即文件</strong>，在 Linux 上，硬件的设备驱动（如硬盘）和特殊设备文件（如 <code>/dev/zero</code> 和 <code>/dev/random</code>）都像普通文件一样，只是在各自的驱动程序中实现了对应的功能，<code>dd</code> 也可以读取文件或写入这些文件。这样，<code>dd</code> 也可以用在备份硬件的引导扇区、获取一定数量的随机数据或者空数据等任务中。<code>dd</code> 程序也可以在复制时处理数据，例如转换字节序、或在 ASCII 与 EBCDIC 编码间互换。</p>
<p><code>dd</code> 的命令行语句与其他的 Linux 程序不同，因为它的命令行选项格式为 <strong>选项&#x3D;值</strong>，而不是更标准的 <strong>–选项 值</strong> 或 <strong>-选项&#x3D;值</strong>。<code>dd</code> 默认从标准输入中读取，并写入到标准输出中，但可以用选项 <code>if</code>（input file，输入文件）和 <code>of</code>（output file，输出文件）改变。</p>
<p>我们先来试试用 <code>dd</code> 命令从标准输入读入用户的输入到标准输出或者一个文件中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 输出到文件</span></span><br><span class="line"><span class="built_in">dd</span> of=<span class="built_in">test</span> bs=10 count=1 <span class="comment"># 或者 dd if=/dev/stdin of=test bs=10 count=1</span></span><br><span class="line"><span class="comment"># 输出到标准输出</span></span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/stdin of=/dev/stdout bs=10 count=1</span><br><span class="line"><span class="comment"># 在打完了这个命令后，继续在终端打字，作为你的输入</span></span><br></pre></td></tr></table></figure>

<p>上述命令从标准输入设备读入用户输入（缺省值，所以可省略）然后输出到 test 文件，<code>bs</code>（block size）用于指定块大小（缺省单位为 Byte，也可为其指定如 <code>K</code>，<code>M</code>，<code>G</code> 等单位），<code>count</code> 用于指定块数量。如上图所示，我指定只读取总共 10 个字节的数据，当我输入了 <code>hello shiyanlou</code> 之后加上空格回车总共 16 个字节（一个英文字符占一个字节）内容，显然超过了设定大小。使用 <code>du</code> 和 <code>cat</code> 10 个字节（那个黑底百分号表示这里没有换行符），而其他的多余输入将被截取并保留在标准输入。</p>
<p>前面说到 <code>dd</code> 在拷贝的同时还可以实现数据转换，那下面就举一个简单的例子：将输出的英文字符转换为大写再写入文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/stdin of=<span class="built_in">test</span> bs=10 count=1 conv=ucase</span><br></pre></td></tr></table></figure>

<p>你可以在<code>man</code>文档中查看其他所有转换参数。</p>
<h4 id="使用-dd-命令创建虚拟镜像文件"><a href="#使用-dd-命令创建虚拟镜像文件" class="headerlink" title="使用 dd 命令创建虚拟镜像文件"></a>使用 dd 命令创建虚拟镜像文件</h4><p>通过上面一小节，你应该掌握了 <code>dd</code> 的基本使用，下面就来使用 <code>dd</code> 命令来完成创建虚拟磁盘的第一步。</p>
<p>从 <code>/dev/zero</code> 设备创建一个容量为 256M 的空文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=virtual.img bs=1M count=256</span><br><span class="line"><span class="built_in">du</span> -h virtual.img</span><br></pre></td></tr></table></figure>

<p>然后我们要将这个文件格式化（写入文件系统），这里我们要学到一个（准确的说是一组）新的命令来完成这个需求。</p>
<h3 id="使用-mkfs-命令"><a href="#使用-mkfs-命令" class="headerlink" title="使用 mkfs 命令"></a>使用 mkfs 命令</h3><h4 id="格式化磁盘（我们这里是自己创建的虚拟磁盘镜像）"><a href="#格式化磁盘（我们这里是自己创建的虚拟磁盘镜像）" class="headerlink" title="格式化磁盘（我们这里是自己创建的虚拟磁盘镜像）"></a>格式化磁盘（我们这里是自己创建的虚拟磁盘镜像）</h4><p>你可以在命令行输入 <code>sudo mkfs</code> 然后按下 <code>&lt;Tab&gt;</code> 键，你可以看到很多个以 mkfs 为前缀的命令，这些不同的后缀其实就是表示着不同的文件系统，可以用 mkfs 格式化成的文件系统。</p>
<p>我们可以简单的使用下面的命令来将我们的虚拟磁盘镜像格式化为 <code>ext4</code> 文件系统：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mkfs.ext4 virtual.img</span><br></pre></td></tr></table></figure>

<p>可以看到实际 <code>mkfs.ext4</code> 是使用 <code>mke2fs</code> 来完成格式化工作的。<code>mke2fs</code> 的参数很多，不过我们也不会经常格式化磁盘来玩，所以就掌握这基本用法吧，等你有特殊需求时，再查看 man 文档解决。</p>
<p>更多关于文件系统的知识，请查看 wiki： <a target="_blank" rel="noopener" href="http://zh.wikipedia.org/wiki/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F#Linux_.E6.94.AF.E6.8F.B4.E7.9A.84.E6.AA.94.E6.A1.88.E7.B3.BB.E7.B5.B1">文件系统</a> <a target="_blank" rel="noopener" href="http://zh.wikipedia.org/wiki/Ext3">ext3</a>，<a target="_blank" rel="noopener" href="http://zh.wikipedia.org/wiki/Ext4">ext4</a></p>
<p>如果你想知道 Linux 支持哪些文件系统你可以输入 <code>ls -l /lib/modules/$(uname -r)/kernel/fs</code> 查看（我们的环境中无法查看）。</p>
<h3 id="使用-mount-命令"><a href="#使用-mount-命令" class="headerlink" title="使用 mount 命令"></a>使用 mount 命令</h3><h4 id="挂载磁盘到目录树"><a href="#挂载磁盘到目录树" class="headerlink" title="挂载磁盘到目录树"></a>挂载磁盘到目录树</h4><p>用户在 Linux&#x2F;UNIX 的机器上打开一个文件以前，包含该文件的文件系统必须先进行挂载的动作，此时用户要对该文件系统执行 <code>mount</code> 的指令以进行挂载。该指令通常是使用在 USB 或其他可移除存储设备上，而根目录则需要始终保持挂载的状态。又因为 Linux&#x2F;UNIX 文件系统可以对应一个文件而不一定要是硬件设备，所以可以挂载一个包含文件系统的文件到目录树。</p>
<p>Linux&#x2F;UNIX 命令行的 <code>mount</code> 指令是告诉操作系统，对应的文件系统已经准备好，可以使用了，而该文件系统会对应到一个特定的点（称为挂载点）。挂载好的文件、目录、设备以及特殊文件即可提供用户使用。</p>
<p>我们先来使用 <code>mount</code> 来查看下主机已经挂载的文件系统：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount</span><br></pre></td></tr></table></figure>

<p>输出的结果中每一行表示一个设备或虚拟设备，每一行最前面是设备名，然后是 on 后面是挂载点，type 后面表示文件系统类型，再后面是挂载选项（比如可以在挂载时设定以只读方式挂载等等）。</p>
<p>那么我们如何挂载真正的磁盘到目录树呢，<code>mount</code> 命令的一般格式如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount [options] [<span class="built_in">source</span>] [directory]</span><br></pre></td></tr></table></figure>

<p>一些常用操作：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount [-o [操作选项]] [-t 文件系统类型] [-w|--rw|--ro] [文件系统源] [挂载点]</span><br></pre></td></tr></table></figure>

<p><strong>注意：由于实验楼的环境限制，mount 命令挂载及 umount 卸载都无法进行操作，可以简单了解这些步骤。</strong></p>
<p>现在直接来挂载我们创建的虚拟磁盘镜像到 <code>/mnt</code> 目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mount -o loop -t ext4 virtual.img /mnt</span><br><span class="line"><span class="comment"># 也可以省略挂载类型，很多时候 mount 会自动识别</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 以只读方式挂载</span></span><br><span class="line">mount -o loop --ro virtual.img /mnt</span><br><span class="line"><span class="comment"># 或者 mount -o loop,ro virtual.img /mnt</span></span><br></pre></td></tr></table></figure>

<h4 id="使用-umount-命令卸载已挂载磁盘"><a href="#使用-umount-命令卸载已挂载磁盘" class="headerlink" title="使用 umount 命令卸载已挂载磁盘"></a>使用 umount 命令卸载已挂载磁盘</h4><p><strong>注意：由于实验楼的环境限制，mount 命令挂载及 umount 卸载都无法进行操作，可以简单了解这些步骤。</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 命令格式 sudo umount 已挂载设备名或者挂载点，如：</span></span><br><span class="line">sudo umount /mnt</span><br></pre></td></tr></table></figure>

<p>不过遗憾的是，由于我们环境的问题（环境中使用的 Linux 内核在编译时没有添加对 Loop device 的支持），所以你将无法挂载成功</p>
<p>另外关于 loop 设备，你可能会有诸多疑问，那么请看下面来自维基百科 <a target="_blank" rel="noopener" href="http://zh.wikipedia.org/wiki//dev/loop">&#x2F;dev&#x2F;loop</a>的说明：</p>
<h4 id="使用-fdisk-为磁盘分区"><a href="#使用-fdisk-为磁盘分区" class="headerlink" title="使用 fdisk 为磁盘分区"></a>使用 fdisk 为磁盘分区</h4><p>（关于分区的一些概念不清楚的用户请参看 <a target="_blank" rel="noopener" href="http://zh.wikipedia.org/wiki/%E4%B8%BB%E5%BC%95%E5%AF%BC%E8%AE%B0%E5%BD%95">主引导记录</a>）</p>
<p><strong>注意：由于实验楼的环境限制，fdisk 命令无法进行操作，可以简单了解这些步骤。</strong></p>
<p>同样因为环境中没有物理磁盘，也无法创建虚拟磁盘的原因我们就无法实验练习使用该命令了，下面我将以我的物理主机为例讲解如何为磁盘分区。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看硬盘分区表信息</span></span><br><span class="line">sudo fdisk -l</span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20220825150314725.png" alt="image-20220825150314725"></p>
<p>输出结果中开头显示了我主机上的磁盘的一些信息，包括容量扇区数，扇区大小，I&#x2F;O 大小等信息。</p>
<p>我们重点看一下中间的分区信息，<code>/dev/sda1</code>，<code>/dev/sda2</code> 为主分区分别安装了 Windows 和 Linux 操作系统，<code>/dev/sda3</code> 为交换分区（可以理解为虚拟内存），<code>/dev/sda4</code> 为扩展分区其中包含 <code>/dev/sda5</code>，<code>/dev/sda6</code>，<code>/dev/sda7</code>，<code>/dev/sda8</code> 四个逻辑分区，因为主机上有几个分区之间有空隙，没有对齐边界扇区，所以分区之间不是完全连续的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入磁盘分区模式</span></span><br><span class="line">sudo fdisk virtual.img</span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20220825150347651.png" alt="image-20220825150347651"></p>
<p>在进行操作前我们首先应先规划好我们的分区方案，这里我将在使用 128M（可用 127M 左右）的虚拟磁盘镜像创建一个 30M 的主分区剩余部分为扩展分区包含 2 个大约 45M 的逻辑分区。</p>
<p>操作完成后输入 <code>p</code> 查看结果如下:</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20220825150400564.png" alt="image-20220825150400564"></p>
<p>最后不要忘记输入 <code>w</code> 写入分区表。</p>
<h3 id="使用-losetup-命令"><a href="#使用-losetup-命令" class="headerlink" title="使用 losetup 命令"></a>使用 losetup 命令</h3><h4 id="建立镜像与回环设备的关联"><a href="#建立镜像与回环设备的关联" class="headerlink" title="建立镜像与回环设备的关联"></a>建立镜像与回环设备的关联</h4><p><strong>注意：由于实验楼的环境限制，losetup 命令无法进行操作，可以简单了解这些步骤。</strong></p>
<p>同样因为环境原因中没有物理磁盘，也没有 loop device 的原因我们就无法实验练习使用该命令了，下面我将以我的物理主机为例讲解。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo losetup /dev/loop0 virtual.img</span><br><span class="line"><span class="comment"># 如果提示设备忙你也可以使用其它的回环设备，&quot;ls /dev/loop*&quot;参看所有回环设备</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 解除设备关联</span></span><br><span class="line">sudo losetup -d /dev/loop0</span><br></pre></td></tr></table></figure>

<p>然后再使用 <code>mkfs</code> 格式化各分区（前面我们是格式化整个虚拟磁盘镜像文件或磁盘），不过格式化之前，我们还要为各分区建立虚拟设备的映射，用到 <code>kpartx</code> 工具，需要先安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install kpartx</span><br><span class="line">sudo kpartx -av /dev/loop0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 取消映射</span></span><br><span class="line">sudo kpartx -dv /dev/loop0</span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20220825150421449.png" alt="image-20220825150421449"></p>
<p>接着再是格式化，我们将其全部格式化为 ext4：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo mkfs.ext4 -q /dev/mapper/loop0p1</span><br><span class="line">sudo mkfs.ext4 -q /dev/mapper/loop0p5</span><br><span class="line">sudo mkfs.ext4 -q /dev/mapper/loop0p6</span><br></pre></td></tr></table></figure>

<p>格式化完成后在 <code>/media</code> 目录下新建四个空目录用于挂载虚拟磁盘：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /media/virtualdisk_&#123;1..3&#125;</span><br><span class="line"><span class="comment"># 挂载磁盘分区</span></span><br><span class="line">sudo mount /dev/mapper/loop0p1 /media/virtualdisk_1</span><br><span class="line">sudo mount /dev/mapper/loop0p5 /media/virtualdisk_2</span><br><span class="line">sudo mount /dev/mapper/loop0p6 /media/virtualdisk_3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 卸载磁盘分区</span></span><br><span class="line">sudo umount /dev/mapper/loop0p1</span><br><span class="line">sudo umount /dev/mapper/loop0p5</span><br><span class="line">sudo umount /dev/mapper/loop0p6</span><br></pre></td></tr></table></figure>

<p>然后：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">df</span> -h</span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20220825150436515.png" alt="image-20220825150436515"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://liketostudy.com/2022/08/24/Linux%E5%9F%BA%E7%A1%80-03-%E6%96%87%E4%BB%B6%E6%89%93%E5%8C%85%E4%B8%8E%E5%8E%8B%E7%BC%A9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="文晨">
      <meta itemprop="description" content="百学须先立志">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="琛的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/24/Linux%E5%9F%BA%E7%A1%80-03-%E6%96%87%E4%BB%B6%E6%89%93%E5%8C%85%E4%B8%8E%E5%8E%8B%E7%BC%A9/" class="post-title-link" itemprop="url">Linux基础-03-文件打包与压缩</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-08-24 17:26:45 / 修改时间：19:13:05" itemprop="dateCreated datePublished" datetime="2022-08-24T17:26:45+08:00">2022-08-24</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Linux基础-03-文件打包与压缩"><a href="#Linux基础-03-文件打包与压缩" class="headerlink" title="Linux基础-03-文件打包与压缩"></a>Linux基础-03-文件打包与压缩</h1><h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><p>在讲 Linux 上的压缩工具之前，有必要先了解一下常见常用的压缩包文件格式。在 Windows 上最常见的不外乎这两种 <code>*.zip</code>，<code>*.7z</code> 后缀的压缩文件。而在 Linux 上面常见的格式除了以上两种外，还有 <code>.rar</code>，<code>*.gz</code>，<code>*.xz</code>，<code>*.bz2</code>，<code>*.tar</code>，<code>*.tar.gz</code>，<code>*.tar.xz</code>，<code>*.tar.bz2</code>，简单介绍如下：</p>
<table>
<thead>
<tr>
<th>文件后缀名</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>*.zip</code></td>
<td>zip 程序打包压缩的文件</td>
</tr>
<tr>
<td><code>*.rar</code></td>
<td>rar 程序压缩的文件</td>
</tr>
<tr>
<td><code>*.7z</code></td>
<td>7zip 程序压缩的文件</td>
</tr>
<tr>
<td><code>*.tar</code></td>
<td>tar 程序打包，未压缩的文件</td>
</tr>
<tr>
<td><code>*.gz</code></td>
<td>gzip 程序（GNU zip）压缩的文件</td>
</tr>
<tr>
<td><code>*.xz</code></td>
<td>xz 程序压缩的文件</td>
</tr>
<tr>
<td><code>*.bz2</code></td>
<td>bzip2 程序压缩的文件</td>
</tr>
<tr>
<td><code>*.tar.gz</code></td>
<td>tar 打包，gzip 程序压缩的文件</td>
</tr>
<tr>
<td><code>*.tar.xz</code></td>
<td>tar 打包，xz 程序压缩的文件</td>
</tr>
<tr>
<td><code>*tar.bz2</code></td>
<td>tar 打包，bzip2 程序压缩的文件</td>
</tr>
<tr>
<td><code>*.tar.7z</code></td>
<td>tar 打包，7z 程序压缩的文件</td>
</tr>
</tbody></table>
<p>讲了这么多种压缩文件，这么多个命令，不过我们一般只需要掌握几个命令即可，包括 <code>zip</code>，<code>tar</code>。下面会依次介绍这几个命令及对应的解压命令。</p>
<h2 id="zip压缩打包"><a href="#zip压缩打包" class="headerlink" title="zip压缩打包"></a>zip压缩打包</h2><ul>
<li>使用 zip 打包文件夹，注意输入完整的参数和路径：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /home/shiyanlou</span><br><span class="line">zip -r -q -o shiyanlou.zip /home/shiyanlou/Desktop</span><br><span class="line"><span class="built_in">du</span> -h shiyanlou.zip</span><br><span class="line">file shiyanlou.zip</span><br></pre></td></tr></table></figure>

<p>上面命令将目录 <code>/home/shiyanlou/Desktop</code> 打包成一个文件，并查看了打包后文件的大小和类型。第一行命令中，<code>-r</code> 参数表示递归打包包含子目录的全部内容，<code>-q</code> 参数表示为安静模式，即不向屏幕输出信息，<code>-o</code>，表示输出文件，需在其后紧跟打包输出文件名。后面使用 <code>du</code> 命令查看打包后文件的大小（后面会具体说明该命令）。</p>
<ul>
<li>设置压缩级别为 9 和 1（9 最大，1 最小），重新打包：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zip -r -9 -q -o shiyanlou_9.zip /home/shiyanlou/Desktop -x ~/*.zip</span><br><span class="line">zip -r -1 -q -o shiyanlou_1.zip /home/shiyanlou/Desktop -x ~/*.zip</span><br></pre></td></tr></table></figure>

<p>这里添加了一个参数用于设置压缩级别 <code>-[1-9]</code>，1 表示最快压缩但体积大，9 表示体积最小但耗时最久。最后那个 <code>-x</code> 是为了排除我们上一次创建的 zip 文件，否则又会被打包进这一次的压缩文件中，<strong>注意：这里只能使用绝对路径，否则不起作用</strong>。</p>
<p>我们再用 <code>du</code> 命令分别查看默认压缩级别、最低、最高压缩级别及未压缩的文件的大小：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">du</span> -h -d 0 *.zip ~ | <span class="built_in">sort</span></span><br></pre></td></tr></table></figure>

<p>通过 man 手册可知：</p>
<ul>
<li><code>-h</code>， –human-readable（顾名思义，你可以试试不加的情况）</li>
<li><code>-d</code>， –max-depth（所查看文件的深度）</li>
</ul>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20220824173730418.png" alt="image-20220824173730418"></p>
<p>这样一目了然，理论上来说默认压缩级别应该是最高的，但是由于文件不大，这里的差异不明显（几乎看不出差别），不过你在环境中操作之后看到的压缩文件大小可能跟图上的有些不同，因为系统在使用过程中，会随时生成一些缓存文件在当前用户的家目录中，这对于我们学习命令使用来说，是无关紧要的，可以忽略这些不同。</p>
<ul>
<li>创建加密 zip 包</li>
</ul>
<p>使用 <code>-e</code> 参数可以创建加密压缩包：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zip -r -e -o shiyanlou_encryption.zip /home/shiyanlou/Desktop</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong> 关于 <code>zip</code> 命令，因为 Windows 系统与 Linux&#x2F;Unix 在文本文件格式上的一些兼容问题，比如换行符（为不可见字符），在 Windows 为 CR+LF（Carriage-Return+Line-Feed：回车加换行），而在 Linux&#x2F;Unix 上为 LF（换行），所以如果在不加处理的情况下，在 Linux 上编辑的文本，在 Windows 系统上打开可能看起来是没有换行的。如果你想让你在 Linux 创建的 zip 压缩文件在 Windows 上解压后没有任何问题，那么你还需要对命令做一些修改：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zip -r -l -o shiyanlou.zip /home/shiyanlou/Desktop</span><br></pre></td></tr></table></figure>

<p>需要加上 <code>-l</code> 参数将 <code>LF</code> 转换为 <code>CR+LF</code> 来达到以上目的。</p>
<h2 id="unzip解压"><a href="#unzip解压" class="headerlink" title="unzip解压"></a>unzip解压</h2><p>将 <code>shiyanlou.zip</code> 解压到当前目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unzip shiyanlou.zip</span><br></pre></td></tr></table></figure>

<p>使用安静模式，将文件解压到指定目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unzip -q shiyanlou.zip -d ziptest</span><br></pre></td></tr></table></figure>

<p>上述指定目录不存在，将会自动创建。如果你不想解压只想查看压缩包的内容你可以使用 <code>-l</code> 参数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unzip -l shiyanlou.zip</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong> 使用 unzip 解压文件时我们同样应该注意兼容问题，不过这里我们关心的不再是上面的问题，而是中文编码的问题，通常 Windows 系统上面创建的压缩文件，如果有有包含中文的文档或以中文作为文件名的文件时默认会采用 GBK 或其它编码，而 Linux 上面默认使用的是 UTF-8 编码，如果不加任何处理，直接解压的话可能会出现中文乱码的问题（有时候它会自动帮你处理），为了解决这个问题，我们可以在解压时指定编码类型。</p>
<p>使用 <code>-O</code>（英文字母，大写 o）参数指定编码类型：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unzip -O GBK 中文压缩文件.zip</span><br></pre></td></tr></table></figure>



<h2 id="tar打包工具"><a href="#tar打包工具" class="headerlink" title="tar打包工具"></a>tar打包工具</h2><p>在 Linux 上面更常用的是 <code>tar</code> 工具，tar 原本只是一个打包工具，只是同时还是实现了对 7z、gzip、xz、bzip2 等工具的支持，这些压缩工具本身只能实现对文件或目录（单独压缩目录中的文件）的压缩，没有实现对文件的打包压缩，所以我们也无需再单独去学习其他几个工具，tar 的解压和压缩都是同一个命令，只需参数不同，使用比较方便。</p>
<p>下面先掌握 <code>tar</code> 命令一些基本的使用方式，即不进行压缩只是进行打包（创建归档文件）和解包的操作。</p>
<ul>
<li>创建一个 tar 包：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /home/shiyanlou</span><br><span class="line">tar -P -cf shiyanlou.tar /home/shiyanlou/Desktop</span><br></pre></td></tr></table></figure>

<p>上面命令中，<code>-P</code> 保留绝对路径符，<code>-c</code> 表示创建一个 tar 包文件，<code>-f</code> 用于指定创建的文件名，注意文件名必须紧跟在 <code>-f</code> 参数之后，比如不能写成 <code>tar -fc shiyanlou.tar</code>，可以写成 <code>tar -f shiyanlou.tar -c ~</code>。你还可以加上 <code>-v</code> 参数以可视的的方式输出打包的文件。</p>
<ul>
<li>解包一个文件（<code>-x</code> 参数）到指定路径的<strong>已存在</strong>目录（<code>-C</code> 参数）：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> tardir</span><br><span class="line">tar -xf shiyanlou.tar -C tardir</span><br></pre></td></tr></table></figure>

<ul>
<li>只查看不解包文件 <code>-t</code> 参数：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -tf shiyanlou.tar</span><br></pre></td></tr></table></figure>

<ul>
<li>保留文件属性和跟随链接（符号链接或软链接），有时候我们使用 tar 备份文件当你在其他主机还原时希望保留文件的属性（<code>-p</code> 参数）和备份链接指向的源文件而不是链接本身（<code>-h</code> 参数）：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -cphf etc.tar /etc</span><br></pre></td></tr></table></figure>

<p>对于创建不同的压缩格式的文件，对于 tar 来说是相当简单的，需要的只是换一个参数，这里我们就以使用 <code>gzip</code> 工具创建 <code>*.tar.gz</code> 文件为例来说明。</p>
<ul>
<li>我们只需要在创建 tar 文件的基础上添加 <code>-z</code> 参数，使用 <code>gzip</code> 来压缩文件：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -czf shiyanlou.tar.gz /home/shiyanlou/Desktop</span><br></pre></td></tr></table></figure>

<ul>
<li>解压 <code>*.tar.gz</code> 文件：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -xzf shiyanlou.tar.gz</span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20220824174403703.png" alt="image-20220824174403703"></p>
<p>现在我们要使用其它的压缩工具创建或解压相应文件只需要更改一个参数即可：</p>
<table>
<thead>
<tr>
<th>压缩文件格式</th>
<th>参数</th>
</tr>
</thead>
<tbody><tr>
<td><code>*.tar.gz</code></td>
<td><code>-z</code></td>
</tr>
<tr>
<td><code>*.tar.xz</code></td>
<td><code>-J</code></td>
</tr>
<tr>
<td><code>*tar.bz2</code></td>
<td><code>-j</code></td>
</tr>
</tbody></table>
<blockquote>
<p>tar 命令的参数很多，不过常用的就是上述这些，需要了解更多你可以查看 man 手册获取帮助。</p>
</blockquote>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>现在我们要使用其它的压缩工具创建或解压相应文件只需要更改一个参数即可：</p>
<table>
<thead>
<tr>
<th>压缩文件格式</th>
<th>参数</th>
</tr>
</thead>
<tbody><tr>
<td><code>*.tar.gz</code></td>
<td><code>-z</code></td>
</tr>
<tr>
<td><code>*.tar.xz</code></td>
<td><code>-J</code></td>
</tr>
<tr>
<td><code>*tar.bz2</code></td>
<td><code>-j</code></td>
</tr>
</tbody></table>
<blockquote>
<p>tar 命令的参数很多，不过常用的就是上述这些，需要了解更多你可以查看 man 手册获取帮助。</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://liketostudy.com/2022/08/23/Linux%E5%9F%BA%E7%A1%80-02-%E6%96%87%E4%BB%B6%E5%8F%8A%E7%9B%AE%E5%BD%95%E7%AE%A1%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="文晨">
      <meta itemprop="description" content="百学须先立志">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="琛的个人博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/23/Linux%E5%9F%BA%E7%A1%80-02-%E6%96%87%E4%BB%B6%E5%8F%8A%E7%9B%AE%E5%BD%95%E7%AE%A1%E7%90%86/" class="post-title-link" itemprop="url">Linux基础-02-文件及目录管理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-08-23 20:12:57" itemprop="dateCreated datePublished" datetime="2022-08-23T20:12:57+08:00">2022-08-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-08-24 17:21:22" itemprop="dateModified" datetime="2022-08-24T17:21:22+08:00">2022-08-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Linux基础-02-文件及目录管理"><a href="#Linux基础-02-文件及目录管理" class="headerlink" title="Linux基础-02-文件及目录管理"></a>Linux基础-02-文件及目录管理</h1><h2 id="一些小操作"><a href="#一些小操作" class="headerlink" title="一些小操作"></a>一些小操作</h2><h4 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h4><p>真正学习命令行之前，你先要掌握几个十分有用、必需掌握的小技巧：</p>
<h5 id="Tab"><a href="#Tab" class="headerlink" title="[Tab]"></a>[Tab]</h5><p>使用<code>Tab</code>键来进行命令补全，<code>Tab</code>键一般是在字母<code>Q</code>旁边，这个技巧给你带来的最大的好处就是当你忘记某个命令的全称时可以只输入它的开头的一部分，然后按下<code>Tab</code>键就可以得到提示或者帮助完成：</p>
<h5 id="Ctrl-c"><a href="#Ctrl-c" class="headerlink" title="[Ctrl+c]"></a>[Ctrl+c]</h5><p>强行终止当前程序</p>
<h5 id="其他一些常用快捷键"><a href="#其他一些常用快捷键" class="headerlink" title="其他一些常用快捷键"></a>其他一些常用快捷键</h5><table>
<thead>
<tr>
<th>按键</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><code>Ctrl+d</code></td>
<td>键盘输入结束或退出终端</td>
</tr>
<tr>
<td><code>Ctrl+s</code></td>
<td>暂停当前程序，暂停后按下任意键恢复运行</td>
</tr>
<tr>
<td><code>Ctrl+z</code></td>
<td>将当前程序放到后台运行，恢复到前台为命令<code>fg</code></td>
</tr>
<tr>
<td><code>Ctrl+a</code></td>
<td>将光标移至输入行头，相当于<code>Home</code>键</td>
</tr>
<tr>
<td><code>Ctrl+e</code></td>
<td>将光标移至输入行末，相当于<code>End</code>键</td>
</tr>
<tr>
<td><code>Ctrl+k</code></td>
<td>删除从光标所在位置到行末</td>
</tr>
<tr>
<td><code>Alt+Backspace</code></td>
<td>向前删除一个单词</td>
</tr>
<tr>
<td><code>Shift+PgUp</code></td>
<td>将终端显示向上滚动</td>
</tr>
<tr>
<td><code>Shift+PgDn</code></td>
<td>将终端显示向下滚动</td>
</tr>
</tbody></table>
<h4 id="学会使用通配符"><a href="#学会使用通配符" class="headerlink" title="学会使用通配符"></a>学会使用通配符</h4><p>通配符是一种特殊语句，主要有星号（*）和问号（?），用来对字符串进行模糊匹配（比如文件名、参数名）。当查找文件夹时，可以使用它来代替一个或多个真正字符；当不知道真正字符或者懒得输入完整名字时，常常使用通配符代替一个或多个真正字符。</p>
<p>Shell 常用通配符：</p>
<table>
<thead>
<tr>
<th>字符</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td><code>*</code></td>
<td>匹配 0 或多个字符</td>
</tr>
<tr>
<td><code>?</code></td>
<td>匹配任意一个字符</td>
</tr>
<tr>
<td><code>[list]</code></td>
<td>匹配 list 中的任意单一字符</td>
</tr>
<tr>
<td><code>[^list]</code></td>
<td>匹配 除 list 中的任意单一字符以外的字符</td>
</tr>
<tr>
<td><code>[c1-c2]</code></td>
<td>匹配 c1-c2 中的任意单一字符 如：[0-9][a-z]</td>
</tr>
<tr>
<td><code>&#123;string1,string2,...&#125;</code></td>
<td>匹配 string1 或 string2 (或更多)其一字符串</td>
</tr>
<tr>
<td><code>&#123;c1..c2&#125;</code></td>
<td>匹配 c1-c2 中全部字符 如{1..10}</td>
</tr>
</tbody></table>
<h4 id="帮助"><a href="#帮助" class="headerlink" title="帮助"></a>帮助</h4><p>使用<code>man</code>命令，它是<code>Manual pages</code>的缩写。</p>
<p>通常情况下，man 手册里面的内容都是英文的，这就要求你有一定的英文基础。man 手册的内容很多，涉及了 Linux 使用过程中的方方面面。为了便于查找，man 手册被进行了分册（分区段）处理，在 Research UNIX、BSD、OS X 和 Linux 中，手册通常被分为 8 个区段，安排如下：</p>
<table>
<thead>
<tr>
<th>区段</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>一般命令</td>
</tr>
<tr>
<td>2</td>
<td>系统调用</td>
</tr>
<tr>
<td>3</td>
<td>库函数，涵盖了 C 标准函数库</td>
</tr>
<tr>
<td>4</td>
<td>特殊文件（通常是&#x2F;dev 中的设备）和驱动程序</td>
</tr>
<tr>
<td>5</td>
<td>文件格式和约定</td>
</tr>
<tr>
<td>6</td>
<td>游戏和屏保</td>
</tr>
<tr>
<td>7</td>
<td>杂项</td>
</tr>
<tr>
<td>8</td>
<td>系统管理命令和守护进程</td>
</tr>
</tbody></table>
<p>要查看相应区段的内容，就在 man 后面加上相应区段的数字即可，如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">man 1 <span class="built_in">ls</span></span><br></pre></td></tr></table></figure>

<p>会显示第一区段中的<code>ls</code>命令 man 页面。</p>
<p>所有的手册页遵循一个常见的布局，为了通过简单的 ASCII 文本展示而被优化，而这种情况下可能没有任何形式的高亮或字体控制。一般包括以下部分内容：</p>
<p><strong>NAME（名称）</strong></p>
<blockquote>
<p>该命令或函数的名称，接着是一行简介。</p>
</blockquote>
<p><strong>SYNOPSIS（概要）</strong></p>
<blockquote>
<p>对于命令，正式的描述它如何运行，以及需要什么样的命令行参数。对于函数，介绍函数所需的参数，以及哪个头文件包含该函数的定义。</p>
</blockquote>
<p><strong>DESCRIPTION（说明）</strong></p>
<blockquote>
<p>命令或函数功能的文本描述。</p>
</blockquote>
<p><strong>EXAMPLES（示例）</strong></p>
<blockquote>
<p>常用的一些示例。</p>
</blockquote>
<p><strong>SEE ALSO（参见）</strong></p>
<blockquote>
<p>相关命令或函数的列表。</p>
</blockquote>
<p>也可能存在其它部分内容，但这些部分没有得到跨手册页的标准化。常见的例子包括：OPTIONS（选项），EXIT STATUS（退出状态），ENVIRONMENT（环境），BUGS（程序漏洞），FILES（文件），AUTHOR（作者），REPORTING BUGS（已知漏洞），HISTORY（历史）和 COPYRIGHT（版权）。</p>
<p>通常 man 手册中的内容很多，你可能不太容易找到你想要的结果，不过幸运的是你可以在 man 中使用搜索<code>/&lt;你要搜索的关键字&gt;</code>，查找完毕后你可以使用<code>n</code>键切换到下一个关键字所在处，<code>shift+n</code>为上一个关键字所在处。使用<code>Space</code>（空格键）翻页，<code>Enter</code>（回车键）向下滚动一行，或者使用<code>k</code>，<code>j</code>（vim 编辑器的移动键）进行向前向后滚动一行。按下<code>h</code>键为显示使用帮助（因为 man 使用 less 作为阅读器，实为<code>less</code>工具的帮助），按下<code>q</code>退出。</p>
<p>想要获得更详细的帮助，你还可以使用<code>info</code>命令，不过通常使用<code>man</code>就足够了。如果你知道某个命令的作用，只是想快速查看一些它的某个具体参数的作用，那么你可以使用<code>--help</code>参数，大部分命令都会带有这个参数，如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> --<span class="built_in">help</span></span><br></pre></td></tr></table></figure>

<h2 id="用户及文件权限管理"><a href="#用户及文件权限管理" class="headerlink" title="用户及文件权限管理"></a>用户及文件权限管理</h2><h3 id="创建用户及切换用户"><a href="#创建用户及切换用户" class="headerlink" title="创建用户及切换用户"></a>创建用户及切换用户</h3><p><code>su &lt;user&gt;</code> 可以切换到用户 user</p>
<p><code>sudo &lt;cmd&gt;</code> 可以以特权级别运行 cmd 命令</p>
<p><code>su - &lt;user&gt;</code> 命令也是切换用户，但是同时用户的环境变量和工作目录也会跟着改变成目标用户所对应的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo adduser lilei</span><br></pre></td></tr></table></figure>

<p>使用如下命令切换登录用户：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su -l lilei</span><br></pre></td></tr></table></figure>

<h3 id="用户组"><a href="#用户组" class="headerlink" title="用户组"></a>用户组</h3><p>在 Linux 里面如何知道自己属于哪些用户组</p>
<p><strong>方法一：使用 groups 命令</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">groups</span> shiyanlou</span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/document-uid13labid3timestamp1454035714557.png" alt="此处输入图片的描述"></p>
<p><strong>方法二：查看 <code>/etc/group</code> 文件</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/group | <span class="built_in">sort</span></span><br></pre></td></tr></table></figure>

<p>这里 <code>cat</code> 命令用于读取指定文件的内容并打印到终端输出，后面会详细讲它的使用。 <code>| sort</code> 表示将读取的文本进行一个字典排序再输出，然后你将看到如下一堆输出，你可以在最下面看到 shiyanlou 的用户组信息：</p>
<p>可以使用 <code>grep</code> 命令过滤掉一些你不想看到的结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/group | grep -E <span class="string">&quot;shiyanlou&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/document-uid13labid3timestamp1454035698068.png" alt="此处输入图片的描述"></p>
<p><strong><code>/etc/group</code> 文件格式说明</strong></p>
<p>&#x2F;etc&#x2F;group 的内容包括用户组（Group）、用户组口令、GID（组 ID） 及该用户组所包含的用户（User），每个用户组一条记录。格式如下：</p>
<blockquote>
<p>group_name:password:GID:user_list</p>
</blockquote>
<p>你看到上面的 password 字段为一个 <code>x</code>，并不是说密码就是它，只是表示密码不可见而已。</p>
<p>这里需要注意，如果用户的 GID 等于用户组的 GID，那么最后一个字段 <code>user_list</code> 就是空的</p>
<p>使用 <code>usermod</code> 命令可以为用户添加用户组，同样使用该命令你必需有 root 权限，你可以直接使用 root 用户为其它用户添加用户组，或者用其它已经在 sudo 用户组的用户使用 sudo 命令获取权限来执行该命令。</p>
<p>这里我用 shiyanlou 用户执行 sudo 命令将 lilei 添加到 sudo 用户组，让它也可以使用 sudo 命令获得 root 权限，首先我们切换回 shiyanlou 用户。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su - shiyanlou</span><br></pre></td></tr></table></figure>

<p>此处需要输入 shiyanlou 用户密码，shiyanlou 的密码可以在右侧工具栏的环境信息里看到。</p>
<p>当然也可以通过 <code>sudo passwd shiyanlou</code> 进行设置，或者你直接关闭当前终端打开一个新的终端。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">groups</span> lilei</span><br><span class="line">sudo usermod -G sudo lilei</span><br><span class="line"><span class="built_in">groups</span> lilei</span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20220824143829708.png" alt="image-20220824143829708"></p>
<p>删除用户是很简单的事：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo deluser lilei --remove-home</span><br></pre></td></tr></table></figure>

<p>删除用户组可以使用 <code>groupdel</code> 命令，倘若该群组中仍包括某些用户，则必须先删除这些用户后，才能删除群组。</p>
<h3 id="查看文件权限"><a href="#查看文件权限" class="headerlink" title="查看文件权限"></a>查看文件权限</h3><p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/3-9.png" alt="pic"></p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/3-10.png" alt="pic"></p>
<h4 id="修改文件拥有者"><a href="#修改文件拥有者" class="headerlink" title="修改文件拥有者"></a>修改文件拥有者</h4><p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20220824151419258.png" alt="image-20220824151419258"></p>
<h4 id="修改文件权限"><a href="#修改文件权限" class="headerlink" title="修改文件权限"></a>修改文件权限</h4><p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20220824151812591.png" alt="image-20220824151812591"></p>
<h2 id="目录结构及文件基本操作"><a href="#目录结构及文件基本操作" class="headerlink" title="目录结构及文件基本操作"></a>目录结构及文件基本操作</h2><h3 id="Linux目录结构"><a href="#Linux目录结构" class="headerlink" title="Linux目录结构"></a>Linux目录结构</h3><p>FHS（英文：Filesystem Hierarchy Standard 中文：文件系统层次结构标准）</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/4-1.png" alt="img"></p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/document-uid18510labid59timestamp1482919171956.png" alt="此处输入图片的描述"></p>
<p>使用 <code>pwd</code> 获取当前路径：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">pwd</span></span><br></pre></td></tr></table></figure>

<h4 id="新建目录"><a href="#新建目录" class="headerlink" title="新建目录"></a>新建目录</h4><p>使用 <code>mkdir</code>（make directories）命令可以创建一个空目录，也可同时指定创建目录的权限属性。</p>
<p>创建名为“ mydir ”的空目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> mydir</span><br></pre></td></tr></table></figure>

<p>使用 <code>-p</code> 参数，同时创建父目录（如果不存在该父目录），如下我们同时创建一个多级目录（这在安装软件、配置安装路径时非常有用）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p father/son/grandson</span><br></pre></td></tr></table></figure>

<h4 id="复制文件"><a href="#复制文件" class="headerlink" title="复制文件"></a>复制文件</h4><p>使用 <code>cp</code> 命令（copy）复制一个文件到指定目录。</p>
<p>将之前创建的 <code>test</code> 文件复制到 <code>/home/shiyanlou/father/son/grandson</code> 目录中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> <span class="built_in">test</span> father/son/grandson</span><br></pre></td></tr></table></figure>

<p>是不是很方便啊，如果在图形界面则需要先在源目录复制文件，再进到目的目录粘贴文件，而命令行操作步骤就一步到位了嘛。</p>
<h4 id="复制目录"><a href="#复制目录" class="headerlink" title="复制目录"></a>复制目录</h4><p>如果直接使用 <code>cp</code> 命令复制一个目录的话，会出现错误</p>
<p>要成功复制目录需要加上 <code>-r</code> 或者 <code>-R</code> 参数，表示递归复制，就是说有点“株连九族”的意思：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /home/shiyanlou</span><br><span class="line"><span class="built_in">mkdir</span> family</span><br><span class="line"><span class="built_in">cp</span> -r father family</span><br></pre></td></tr></table></figure>

<h4 id="删除文件"><a href="#删除文件" class="headerlink" title="删除文件"></a>删除文件</h4><p>使用 <code>rm</code>（remove files or directories）命令删除一个文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> <span class="built_in">test</span></span><br></pre></td></tr></table></figure>

<p>有时候你会遇到想要删除一些为只读权限的文件，直接使用 <code>rm</code> 删除会显示一个提示，如下：</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/document-uid735639labid59timestamp1531733991692.png" alt="4-3.3-1"></p>
<p>你如果想忽略这提示，直接删除文件，可以使用 <code>-f</code> 参数强制删除：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -f <span class="built_in">test</span></span><br></pre></td></tr></table></figure>

<h4 id="删除目录"><a href="#删除目录" class="headerlink" title="删除目录"></a>删除目录</h4><p>跟复制目录一样，要删除一个目录，也需要加上 <code>-r</code> 或 <code>-R</code> 参数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -r family</span><br></pre></td></tr></table></figure>

<p>遇到权限不足删除不了的目录也可以和删除文件一样加上 <code>-f</code> 参数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf family</span><br></pre></td></tr></table></figure>

<h4 id="移动文件"><a href="#移动文件" class="headerlink" title="移动文件"></a>移动文件</h4><p>例如将文件“ file1 ”移动到 <code>Documents</code> 目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> Documents</span><br><span class="line"><span class="built_in">touch</span> file1</span><br><span class="line"><span class="built_in">mv</span> file1 Documents</span><br></pre></td></tr></table></figure>

<h4 id="重命名文件"><a href="#重命名文件" class="headerlink" title="重命名文件"></a>重命名文件</h4><p><code>mv</code> 命令除了能移动文件外，还能给文件重命名。命令格式为 <code>mv 旧的文件名 新的文件名</code>。</p>
<p>例如将文件“ file1 ”重命名为“ myfile ”：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mv</span> file1 myfile</span><br></pre></td></tr></table></figure>

<h4 id="批量重命名"><a href="#批量重命名" class="headerlink" title="批量重命名"></a>批量重命名</h4><p><code>rename</code> 命令并不是内置命令，若提示无该命令可以使用 <code>sudo apt-get install rename</code> 命令自行安装。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /home/shiyanlou/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用通配符批量创建 5 个文件:</span></span><br><span class="line"><span class="built_in">touch</span> file&#123;1..5&#125;.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 批量将这 5 个后缀为 .txt 的文本文件重命名为以 .c 为后缀的文件:</span></span><br><span class="line">rename <span class="string">&#x27;s/\.txt/\.c/&#x27;</span> *.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 批量将这 5 个文件，文件名和后缀改为大写:</span></span><br><span class="line">rename <span class="string">&#x27;y/a-z/A-Z/&#x27;</span> *.c</span><br></pre></td></tr></table></figure>

<p>简单解释一下上面的命令，<code>rename</code> 是先使用第二个参数的通配符匹配所有后缀为 <code>.txt</code> 的文件，然后使用第一个参数提供的正则表达式将匹配的这些文件的 <code>.txt</code> 后缀替换为 <code>.c</code>，这一点在我们后面学习了 <code>sed</code> 命令后，相信你会更好地理解。</p>
<h4 id="查看文件"><a href="#查看文件" class="headerlink" title="查看文件"></a>查看文件</h4><p><code>cat</code>可以加上 <code>-n</code> 参数显示行号：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> -n passwd</span><br></pre></td></tr></table></figure>

<p><code>nl</code> 命令，添加行号并打印，这是个比 <code>cat -n</code> 更专业的行号打印命令。</p>
<p>这里简单列举它的常用的几个参数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-b : 指定添加行号的方式，主要有两种：</span><br><span class="line">    -b a:表示无论是否为空行，同样列出行号(<span class="string">&quot;cat -n&quot;</span>就是这种方式)</span><br><span class="line">    -b t:只列出非空行的编号并列出（默认为这种方式）</span><br><span class="line">-n : 设置行号的样式，主要有三种：</span><br><span class="line">    -n <span class="built_in">ln</span>:在行号字段最左端显示</span><br><span class="line">    -n rn:在行号字段最右边显示，且不加 0</span><br><span class="line">    -n rz:在行号字段最右边显示，且加 0</span><br><span class="line">-w : 行号字段占用的位数(默认为 6 位)</span><br></pre></td></tr></table></figure>

<p>使用 <code>more</code> 和 <code>less</code> 命令分页查看文件</p>
<p>使用 <code>more</code> 命令打开 <code>passwd</code> 文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">more passwd</span><br></pre></td></tr></table></figure>

<p>可以使用 <code>Enter</code> 键向下滚动一行，使用 <code>Space</code> 键向下滚动一屏，按下 <code>h</code> 显示帮助，<code>q</code> 退出。</p>
<p><code>head</code>和<code>tail</code> </p>
<p>关于 <code>tail</code> 命令，不得不提的还有它一个很牛的参数 <code>-f</code>，这个参数可以实现不停地读取某个文件的内容并显示。这可以让我们动态查看日志，达到实时监视的目的。</p>
<h4 id="查看文件类型"><a href="#查看文件类型" class="headerlink" title="查看文件类型"></a>查看文件类型</h4><p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20220824160000140.png" alt="image-20220824160000140"></p>
<h3 id="环境变量与文件查找"><a href="#环境变量与文件查找" class="headerlink" title="环境变量与文件查找"></a>环境变量与文件查找</h3><p>使用 <code>declare</code> 命令创建一个变量名为 tmp 的变量：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">declare</span> tmp</span><br></pre></td></tr></table></figure>

<p>使用 <code>=</code> 号赋值运算符，将变量 tmp 赋值为 shiyanlou。注意，与其他语言不同的是， Shell 中的赋值操作，<code>=</code> 两边不可以输入空格，否则会报错。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 正确的赋值</span></span><br><span class="line">tmp=shiyanlou</span><br><span class="line"></span><br><span class="line"><span class="comment"># 错误的赋值</span></span><br><span class="line">tmp = shiyanlou</span><br></pre></td></tr></table></figure>

<p>读取变量的值，使用 <code>echo</code> 命令和 <code>$</code> 符号（**$ 符号用于表示引用一个变量的值，初学者经常忘记输入**）：</p>
<p>echo $tmp</p>
<h4 id="变量类型"><a href="#变量类型" class="headerlink" title="变量类型"></a>变量类型</h4><p>通常我们会涉及到的变量类型有三种：</p>
<ul>
<li>当前 Shell 进程私有用户自定义变量，如上面我们创建的 tmp 变量，只在当前 Shell 中有效。</li>
<li>Shell 本身内建的变量。</li>
<li>从自定义变量导出的环境变量。</li>
</ul>
<p>也有三个与上述三种环境变量相关的命令：<code>set</code>，<code>env</code>，<code>export</code>。这三个命令很相似，都是用于打印环境变量信息，区别在于涉及的变量范围不同。详见下表：</p>
<table>
<thead>
<tr>
<th>命 令</th>
<th>说 明</th>
</tr>
</thead>
<tbody><tr>
<td><code>set</code></td>
<td>显示当前 Shell 所有变量，包括其内建环境变量（与 Shell 外观等相关），用户自定义变量及导出的环境变量。</td>
</tr>
<tr>
<td><code>env</code></td>
<td>显示与当前用户相关的环境变量，还可以让命令在指定环境中运行。</td>
</tr>
<tr>
<td><code>export</code></td>
<td>显示从 Shell 中导出成环境变量的变量，也能通过它将自定义变量导出为环境变量。</td>
</tr>
</tbody></table>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/5-3.png" alt="1"></p>
<p>你可以更直观的使用 <code>vimdiff</code> 工具比较一下它们之间的差别：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">temp=shiyanlou</span><br><span class="line"><span class="built_in">export</span> temp_env=shiyanlou</span><br><span class="line"><span class="built_in">env</span>|<span class="built_in">sort</span>&gt;env.txt</span><br><span class="line"><span class="built_in">export</span>|<span class="built_in">sort</span>&gt;export.txt</span><br><span class="line"><span class="built_in">set</span>|<span class="built_in">sort</span>&gt;set.txt</span><br></pre></td></tr></table></figure>

<p>上述操作将命令输出通过管道 <code>|</code> 使用 <code>sort</code> 命令排序，再重定向到对象文本文件中。管道的概念后面我们会学到，现在你知道这是什么意思就行了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vimdiff env.txt export.txt set.txt</span><br></pre></td></tr></table></figure>

<h4 id="环境变量如何永久生效"><a href="#环境变量如何永久生效" class="headerlink" title="环境变量如何永久生效"></a>环境变量如何永久生效</h4><p>当你关机后，或者关闭当前的 shell 之后，环境变量就没了啊。怎么才能让环境变量永久生效呢？</p>
<p>按变量的生存周期来划分，Linux 变量可分为两类：</p>
<ol>
<li>永久的：需要修改配置文件，变量永久生效；</li>
<li>临时的：使用 export 命令行声明即可，变量在关闭 shell 时失效。</li>
</ol>
<p>这里介绍两个重要文件 <code>/etc/bashrc</code>（有的 Linux 没有这个文件） 和 <code>/etc/profile</code> ，它们分别存放的是 shell 变量和环境变量。还有要注意区别的是每个用户目录下的一个隐藏文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># .profile 可以用 ls -a 查看</span></span><br><span class="line"><span class="built_in">cd</span> /home/shiyanlou</span><br><span class="line"><span class="built_in">ls</span> -a</span><br></pre></td></tr></table></figure>

<p> .profile </p>
<p>这个 .profile 只对当前用户永久生效。因为它保存在当前用户的 Home 目录下，当切换用户时，工作目录可能一并被切换到对应的目录中，这个文件就无法生效。而写在 <code>/etc/profile</code> 里面的是对所有用户永久生效，所以如果想要添加一个永久生效的环境变量，只需要打开 <code>/etc/profile</code>，在最后加上你想添加的环境变量就好啦。</p>
<h4 id="命令查找"><a href="#命令查找" class="headerlink" title="命令查找"></a>命令查找</h4><p>查看 <code>PATH</code> 环境变量的内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>

<p>创建一个 Shell 脚本文件，你可以使用 gedit，vim，sublime 等工具编辑。如果你是直接复制的话，建议使用 gedit 或者 sublime，否则可能导致代码缩进混乱。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /home/shiyanlou</span><br><span class="line"><span class="built_in">touch</span> hello_shell.sh</span><br><span class="line">gedit hello_shell.sh</span><br></pre></td></tr></table></figure>

<p>在脚本中添加如下内容，保存并退出。</p>
<p><strong>注意不要省掉第一行，这不是注释，有用户反映有语法错误，就是因为没有了第一行。</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ((i=0; i&lt;10; i++));<span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;hello shell&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure>

<p>为文件添加可执行权限，否则执行会报错没有权限：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> 755 hello_shell.sh</span><br></pre></td></tr></table></figure>

<p>执行脚本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /home/shiyanlou</span><br><span class="line">./hello_shell.sh</span><br></pre></td></tr></table></figure>

<p>创建一个 C 语言 <code>hello world</code> 程序：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /home/shiyanlou</span><br><span class="line">gedit hello_world.c</span><br></pre></td></tr></table></figure>

<p>输入如下内容，同样不能省略第一行。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hello world!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>保存后使用 gcc 生成可执行文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -o hello_world hello_world.c</span><br></pre></td></tr></table></figure>

<p><strong>gcc 生成二进制文件默认具有可执行权限，不需要修改。</strong></p>
<p>在 <code>/home/shiyanlou</code> 家目录创建一个 <code>mybin</code> 目录，并将上述 <code>hello_shell.sh</code> 和 <code>hello_world</code> 文件移动到其中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /home/shiyanlou</span><br><span class="line"><span class="built_in">mkdir</span> mybin</span><br><span class="line"><span class="built_in">mv</span> hello_shell.sh hello_world mybin/</span><br></pre></td></tr></table></figure>

<p>现在你可以在 <code>mybin</code> 目录中分别运行你刚刚创建的两个程序：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> mybin</span><br><span class="line">./hello_shell.sh</span><br><span class="line">./hello_world</span><br></pre></td></tr></table></figure>

<h4 id="添加路径至环境变量中"><a href="#添加路径至环境变量中" class="headerlink" title="添加路径至环境变量中"></a>添加路径至环境变量中</h4><p>在前面我们应该注意到 <code>PATH</code> 里面的路径是以 <code>:</code> 作为分割符的，所以我们可以这样添加自定义路径：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PATH=<span class="variable">$PATH</span>:/home/shiyanlou/mybin</span><br></pre></td></tr></table></figure>

<p><strong>注意这里一定要使用绝对路径。</strong></p>
<p>现在你就可以在任意目录执行那两个命令了（注意需要去掉前面的 <code>./</code>）。你可能会意识到这样还并没有很好的解决问题，因为我给 PATH 环境变量追加了一个路径，它也只是在当前 Shell 有效，我一旦退出终端，再打开就会发现又失效了。有没有方法让添加的环境变量全局有效？或者每次启动 Shell 时自动执行上面添加自定义路径到 PATH 的命令？下面我们就来说说后一种方式——让它自动执行。</p>
<p>在每个用户的 home 目录中有一个 Shell 每次启动时会默认执行一个配置脚本，以初始化环境，包括添加一些用户自定义环境变量等等。实验楼的环境使用的 Shell 是 zsh，它的配置文件是 <code>.zshrc</code>，相应的如果使用的 Shell 是 Bash，则配置文件为 <code>.bashrc</code>。它们在 <code>etc</code> 下还都有一个或多个全局的配置文件，不过我们一般只修改用户目录下的配置文件。Shell 的种类有很多，可以使用 <code>cat /etc/shells</code> 命令查看当前系统已安装的 Shell。</p>
<p>我们可以简单地使用下面命令直接添加内容到 <code>.zshrc</code> 中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;PATH=<span class="variable">$PATH</span>:/home/shiyanlou/mybin&quot;</span> &gt;&gt; .zshrc</span><br></pre></td></tr></table></figure>

<p><strong>上述命令中 <code>&gt;&gt;</code> 表示将标准输出以追加的方式重定向到一个文件中，注意前面用到的 <code>&gt;</code> 是以覆盖的方式重定向到一个文件中，使用的时候一定要注意分辨。在指定文件不存在的情况下都会创建新的文件。</strong></p>
<h4 id="变量修改"><a href="#变量修改" class="headerlink" title="变量修改"></a>变量修改</h4><p>变量的修改有以下几种方式：</p>
<table>
<thead>
<tr>
<th>变量设置方式</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>$&#123;变量名#匹配字串&#125;</code></td>
<td>从头向后开始匹配，删除符合匹配字串的最短数据</td>
</tr>
<tr>
<td><code>$&#123;变量名##匹配字串&#125;</code></td>
<td>从头向后开始匹配，删除符合匹配字串的最长数据</td>
</tr>
<tr>
<td><code>$&#123;变量名%匹配字串&#125;</code></td>
<td>从尾向前开始匹配，删除符合匹配字串的最短数据</td>
</tr>
<tr>
<td><code>$&#123;变量名%%匹配字串&#125;</code></td>
<td>从尾向前开始匹配，删除符合匹配字串的最长数据</td>
</tr>
<tr>
<td><code>$&#123;变量名/旧的字串/新的字串&#125;</code></td>
<td>将符合旧字串的第一个字串替换为新的字串</td>
</tr>
<tr>
<td><code>$&#123;变量名//旧的字串/新的字串&#125;</code></td>
<td>将符合旧字串的全部字串替换为新的字串</td>
</tr>
</tbody></table>
<p>比如我们可以修改前面添加到 PATH 的环境变量，将添加的 mybin 目录从环境变量里删除。为了避免操作失误导致命令找不到，我们先将 PATH 赋值给一个新的自定义变量 mypath：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mypath=<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$mypath</span></span><br><span class="line">mypath=<span class="variable">$&#123;mypath%/home/shiyanlou/mybin&#125;</span></span><br><span class="line"><span class="comment"># 或使用通配符 * 表示任意多个任意字符</span></span><br><span class="line">mypath=<span class="variable">$&#123;mypath%*/mybin&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="变量删除"><a href="#变量删除" class="headerlink" title="变量删除"></a>变量删除</h4><p>可以使用 <code>unset</code> 命令删除一个环境变量：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">unset</span> mypath</span><br></pre></td></tr></table></figure>

<h4 id="变量立即生效"><a href="#变量立即生效" class="headerlink" title="变量立即生效"></a>变量立即生效</h4><p>前面我们在 Shell 中修改了一个配置脚本文件之后（比如 zsh 的配置文件 home 目录下的 <code>.zshrc</code>），每次都要退出终端重新打开甚至重启主机之后其才能生效，很是麻烦，我们可以使用 <code>source</code> 命令来让其立即生效，如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /home/shiyanlou</span><br><span class="line"><span class="built_in">source</span> .zshrc</span><br></pre></td></tr></table></figure>

<p><code>source</code> 命令还有一个别名就是 <code>.</code>，上面的命令如果替换成 <code>.</code> 的方式就该是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">. ./.zshrc</span><br></pre></td></tr></table></figure>

<h4 id="搜索文件"><a href="#搜索文件" class="headerlink" title="搜索文件"></a>搜索文件</h4><p>与搜索相关的命令常用的有 <code>whereis</code>，<code>which</code>，<code>find</code> 和 <code>locate</code>。</p>
<ul>
<li><code>whereis</code> 简单快速</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">whereis <span class="built_in">who</span></span><br><span class="line">whereis find</span><br></pre></td></tr></table></figure>

<p>你会看到 <code>whereis find</code> 找到了三个路径，两个可执行文件路径和一个 man 在线帮助文件所在路径，这个搜索很快，因为它并没有从硬盘中依次查找，而是直接从数据库中查询。</p>
<p><code>whereis</code> 只能搜索二进制文件（<code>-b</code>），man 帮助文件（<code>-m</code>）和源代码文件（<code>-s</code>）。如果想要获得更全面的搜索结果可以使用 <code>locate</code> 命令。</p>
<ul>
<li><code>locate</code> 快而全</li>
</ul>
<p>使用 <code>locate</code> 命令查找文件也不会遍历硬盘，它通过查询 <code>/var/lib/mlocate/mlocate.db</code> 数据库来检索信息。不过这个数据库也不是实时更新的，系统会使用定时任务每天自动执行 <code>updatedb</code> 命令来更新数据库。所以有时候你刚添加的文件，它可能会找不到，需要手动执行一次 <code>updatedb</code> 命令（在我们的环境中必须先执行一次该命令）。注意这个命令也不是内置的命令，在部分环境中需要手动安装，然后执行更新。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install locate</span><br><span class="line">sudo updatedb</span><br></pre></td></tr></table></figure>

<p>它可以用来查找指定目录下的不同文件类型，如查找 <code>/etc</code> 下所有以 sh 开头的文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">locate /etc/sh</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意，它不只是在 &#x2F;etc 目录下查找，还会自动递归子目录进行查找。</strong></p>
</blockquote>
<p>查找 <code>/usr/share/</code> 下所有 jpg 文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">locate /usr/share/*.jpg</span><br></pre></td></tr></table></figure>

<blockquote>
<p>环境里使用 zsh，在 <code>~/.zshrc</code> 文件里添加了 <code>setopt nonomatch</code> 配置，这样就不会自动处理和修复命令，因此可以不使用 <code>\</code> 转义。如果其他环境中执行该命令提示 <code>zsh: no matches found: /usr/share/*.jpg</code>，则可以在 <code>.zshrc</code> 中添加上述配置，或者使用 <code>\</code> 转义。</p>
</blockquote>
<p>如果想只统计数目可以加上 <code>-c</code> 参数，<code>-i</code> 参数可以忽略大小写进行查找，<code>whereis</code> 的 <code>-b</code>、<code>-m</code>、<code>-s</code> 同样可以使用。</p>
<ul>
<li><code>which</code> 小而精</li>
</ul>
<p><code>which</code> 本身是 Shell 内建的一个命令，我们通常使用 <code>which</code> 来确定是否安装了某个指定的程序，因为它只从 <code>PATH</code> 环境变量指定的路径中去搜索命令并且返回第一个搜索到的结果。也就是说，我们可以看到某个系统命令是否存在以及执行的到底是哪一个地方的命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">which</span> man</span><br><span class="line"><span class="built_in">which</span> nginx</span><br><span class="line"><span class="built_in">which</span> ping</span><br></pre></td></tr></table></figure>

<ul>
<li><code>find</code> 精而细</li>
</ul>
<p><code>find</code> 应该是这几个命令中最强大的了，它不但可以通过文件类型、文件名进行查找而且可以根据文件的属性（如文件的时间戳，文件的权限等）进行搜索。<code>find</code> 命令强大到，要把它讲明白至少需要单独好几节课程才行，我们这里只介绍一些常用的内容。</p>
<p>这条命令表示去 <code>/etc/</code> 目录下面 ，搜索名字叫做 interfaces 的文件或者目录。这是 <code>find</code> 命令最常见的格式，千万记住 <code>find</code> 的第一个参数是要搜索的地方。命令前面加上 <code>sudo</code> 是因为 shiyanlou 只是普通用户，对 <code>/etc</code> 目录下的很多文件都没有访问的权限，如果是 root 用户则不用使用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo find /etc/ -name interfaces</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意 find 命令的路径是作为第一个参数的， 基本命令格式为 find [path][option] [action] 。</strong></p>
</blockquote>
<p>与时间相关的命令参数：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>-atime</code></td>
<td>最后访问时间</td>
</tr>
<tr>
<td><code>-ctime</code></td>
<td>最后修改文件内容的时间</td>
</tr>
<tr>
<td><code>-mtime</code></td>
<td>最后修改文件属性的时间</td>
</tr>
</tbody></table>
<p>下面以 <code>-mtime</code> 参数举例：</p>
<ul>
<li><code>-mtime n</code>：n 为数字，表示为在 n 天之前的“一天之内”修改过的文件</li>
<li><code>-mtime +n</code>：列出在 n 天之前（不包含 n 天本身）被修改过的文件</li>
<li><code>-mtime -n</code>：列出在 n 天之内（包含 n 天本身）被修改过的文件</li>
<li><code>-newer file</code>：file 为一个已存在的文件，列出比 file 还要新的文件名</li>
</ul>
<p>列出 home 目录中，当天（24 小时之内）有改动的文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find ~ -mtime 0</span><br></pre></td></tr></table></figure>

<p>列出用户家目录下比 &#x2F;etc 目录新的文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find ~ -newer /etc</span><br></pre></td></tr></table></figure>

<h2 id="挑战：寻找文件"><a href="#挑战：寻找文件" class="headerlink" title="挑战：寻找文件"></a>挑战：寻找文件</h2><p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20220824171942624.png" alt="image-20220824171942624"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="文晨"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">文晨</p>
  <div class="site-description" itemprop="description">百学须先立志</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">12</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; Thu Apr 07 2022 08:00:00 GMT+0800 (中国标准时间) – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">文晨</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
