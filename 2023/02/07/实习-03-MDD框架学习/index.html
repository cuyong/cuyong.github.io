<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.1.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"liketostudy.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="MDD框架学习1.任务 https:&#x2F;&#x2F;bip-daily.yyuap.com&#x2F;#&#x2F;用户名：19908188888密码： test0630 验证码666666  1.1.从图书订单TCC开始看，跟代码进行逻辑梳理 首先是进入页面     查看构建    可以对应上开发和实际页面，点击配置后进行代码跟进 1.2.order–&gt;stock–&gt;pay 工程间调用关系梳理    工程中，分别学">
<meta property="og:type" content="article">
<meta property="og:title" content="实习-03-MDD框架学习">
<meta property="og:url" content="http://liketostudy.com/2023/02/07/%E5%AE%9E%E4%B9%A0-03-MDD%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0/index.html">
<meta property="og:site_name" content="琛的个人博客">
<meta property="og:description" content="MDD框架学习1.任务 https:&#x2F;&#x2F;bip-daily.yyuap.com&#x2F;#&#x2F;用户名：19908188888密码： test0630 验证码666666  1.1.从图书订单TCC开始看，跟代码进行逻辑梳理 首先是进入页面     查看构建    可以对应上开发和实际页面，点击配置后进行代码跟进 1.2.order–&gt;stock–&gt;pay 工程间调用关系梳理    工程中，分别学">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230202170945908.png">
<meta property="og:image" content="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230202171010198.png">
<meta property="og:image" content="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230202171110864.png">
<meta property="og:image" content="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230202171203111.png">
<meta property="og:image" content="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230201111246717.png">
<meta property="og:image" content="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230202171333291.png">
<meta property="og:image" content="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230202171348768.png">
<meta property="og:image" content="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230202171404751.png">
<meta property="og:image" content="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230202171448043.png">
<meta property="og:image" content="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230214151116644.png">
<meta property="og:image" content="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230214150755125.png">
<meta property="og:image" content="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230214151429919.png">
<meta property="og:image" content="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230214151002135.png">
<meta property="og:image" content="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230214151036553.png">
<meta property="og:image" content="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230214151053561.png">
<meta property="og:image" content="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230203100154865.png">
<meta property="og:image" content="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230203100239463.png">
<meta property="og:image" content="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230203100319880.png">
<meta property="og:image" content="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230203141336848.png">
<meta property="article:published_time" content="2023-02-07T06:59:57.000Z">
<meta property="article:modified_time" content="2023-02-14T07:48:15.133Z">
<meta property="article:author" content="文晨">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230202170945908.png">

<link rel="canonical" href="http://liketostudy.com/2023/02/07/%E5%AE%9E%E4%B9%A0-03-MDD%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>实习-03-MDD框架学习 | 琛的个人博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">琛的个人博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-resources">

    <a href="/resources/" rel="section"><i class="download fa-fw"></i>资源</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-schedule">

    <a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>日程表</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://liketostudy.com/2023/02/07/%E5%AE%9E%E4%B9%A0-03-MDD%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="文晨">
      <meta itemprop="description" content="百学须先立志">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="琛的个人博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          实习-03-MDD框架学习
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-02-07 14:59:57" itemprop="dateCreated datePublished" datetime="2023-02-07T14:59:57+08:00">2023-02-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-02-14 15:48:15" itemprop="dateModified" datetime="2023-02-14T15:48:15+08:00">2023-02-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AE%9E%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">实习</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="MDD框架学习"><a href="#MDD框架学习" class="headerlink" title="MDD框架学习"></a>MDD框架学习</h1><h2 id="1-任务"><a href="#1-任务" class="headerlink" title="1.任务"></a>1.任务</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://bip-daily.yyuap.com/#/">https://bip-daily.yyuap.com/#/</a><br>用户名：19908188888<br>密码： test0630</p>
<p>验证码666666</p>
</blockquote>
<h3 id="1-1-从图书订单TCC开始看，跟代码进行逻辑梳理"><a href="#1-1-从图书订单TCC开始看，跟代码进行逻辑梳理" class="headerlink" title="1.1.从图书订单TCC开始看，跟代码进行逻辑梳理"></a>1.1.从图书订单TCC开始看，跟代码进行逻辑梳理</h3><ul>
<li>首先是进入页面</li>
</ul>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230202170945908.png" alt="image-20230202170945908"></p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230202171010198.png" alt="image-20230202171010198"></p>
<ul>
<li>查看构建</li>
</ul>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230202171110864.png" alt="image-20230202171110864"></p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230202171203111.png" alt="image-20230202171203111"></p>
<p>可以对应上开发和实际页面，点击配置后进行代码跟进</p>
<h3 id="1-2-order–-gt-stock–-gt-pay"><a href="#1-2-order–-gt-stock–-gt-pay" class="headerlink" title="1.2.order–&gt;stock–&gt;pay"></a>1.2.order–&gt;stock–&gt;pay</h3><ul>
<li>工程间调用关系梳理</li>
</ul>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230201111246717.png" alt="image-20230201111246717"></p>
<ul>
<li>工程中，分别学习</li>
</ul>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230202171333291.png" alt="image-20230202171333291"></p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230202171348768.png" alt="image-20230202171348768"></p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230202171404751.png" alt="image-20230202171404751"></p>
<h3 id="1-3-看的过程中，结合mdd工程代码，进行学习"><a href="#1-3-看的过程中，结合mdd工程代码，进行学习" class="headerlink" title="1.3.看的过程中，结合mdd工程代码，进行学习"></a>1.3.看的过程中，结合mdd工程代码，进行学习</h3><p>采用double shift进行查找yts相关进行学习，结合yts评审文档中mdd和yts结合过程，梳理yts在mdd中的作用，结合方式等</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230202171448043.png" alt="image-20230202171448043"></p>
<h2 id="2-学习笔记"><a href="#2-学习笔记" class="headerlink" title="2.学习笔记"></a>2.学习笔记</h2><h3 id="2-1-总览"><a href="#2-1-总览" class="headerlink" title="2.1.总览"></a>2.1.总览</h3><p>全局：</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230214151116644.png" alt="image-20230214151116644"></p>
<p>上方：</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230214150755125.png" alt="image-20230214150755125"></p>
<p>左侧：</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230214151429919.png" alt="image-20230214151429919"></p>
<p>右侧为：</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230214151002135.png" alt="image-20230214151002135"></p>
<p>下左侧为：</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230214151036553.png"></p>
<p>下右侧为：</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230214151053561.png" alt="image-20230214151053561"></p>
<h3 id="2-2-配置保存流程–跟进代码-md"><a href="#2-2-配置保存流程–跟进代码-md" class="headerlink" title="2.2.配置保存流程–跟进代码.md"></a>2.2.配置保存流程–跟进代码.md</h3><h4 id="2-2-3-页面操作及规则查看"><a href="#2-2-3-页面操作及规则查看" class="headerlink" title="2.2.3.页面操作及规则查看"></a>2.2.3.页面操作及规则查看</h4><p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230203100154865.png" alt="image-20230203100154865"></p>
<p>对应</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230203100239463.png" alt="image-20230203100239463"></p>
<p>查看保存过程</p>
<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230203100319880.png" alt="image-20230203100319880"></p>
<h4 id="2-2-4-规则详细内容"><a href="#2-2-4-规则详细内容" class="headerlink" title="2.2.4.规则详细内容"></a>2.2.4.规则详细内容</h4><h5 id="com-yonyou-ucf-mdd-ext-bill-rule-biz-FillPKRule"><a href="#com-yonyou-ucf-mdd-ext-bill-rule-biz-FillPKRule" class="headerlink" title="com.yonyou.ucf.mdd.ext.bill.rule.biz.FillPKRule"></a>com.yonyou.ucf.mdd.ext.bill.rule.biz.FillPKRule</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service(&quot;fillPKRule&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FillPKRule</span> <span class="keyword">extends</span> <span class="title class_">AbstractCommonRule</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FillPKRule</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> RuleExecuteResult <span class="title function_">execute</span><span class="params">(BillContext billContext, Map&lt;String, Object&gt; paramMap)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//列表查询dto:查询条件、分页、汇总显示</span></span><br><span class="line">        <span class="type">BillDataDto</span> <span class="variable">billData</span> <span class="operator">=</span> (BillDataDto)<span class="built_in">this</span>.getParam(paramMap);</span><br><span class="line">        </span><br><span class="line">        List&lt;BizObject&gt; bills = <span class="built_in">this</span>.getBills(billContext, paramMap);</span><br><span class="line">        FillFkDao.execute(billContext.getFullname(), bills);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RuleExecuteResult</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">###  com.yonyou.ucf.mdd.ext.dao.meta.biz.FillFkDao</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T <span class="keyword">extends</span> <span class="title class_">BizObject</span>&gt; <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(String fullname, List&lt;T&gt; bills)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    initIPKGeneratorConfig();</span><br><span class="line">    Map&lt;String, KeyIterator&gt; insertEntityPK = ipkGeneratorConfig.configMap();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Entity entity=MetaDaoHelper.getEntity(fullname);</span><br><span class="line">    <span class="comment">// 遍历所有对象</span></span><br><span class="line">    <span class="keyword">for</span> (BizObject bill : bills) &#123;</span><br><span class="line"></span><br><span class="line">        ObjectHierarchyBuilder.build(bill, entity);</span><br><span class="line">        <span class="comment">// 设置主键</span></span><br><span class="line">        <span class="comment">//20200722 只支持number 类型 ObjectPKWalker pkWalker = new ObjectPKWalker(insertEntityPK);</span></span><br><span class="line">        <span class="type">MddObjectPKWalker</span> <span class="variable">pkWalker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MddObjectPKWalker</span>(insertEntityPK);</span><br><span class="line">        ObjectWalker.walk(pkWalker, bill, fullname);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置关联关系字段值（主子实体中，子对象外键）</span></span><br><span class="line">        <span class="type">ObjectFKWalker</span> <span class="variable">fkWalker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectFKWalker</span>();</span><br><span class="line">        <span class="comment">// 在一次遍历中通过next可以设置多个walker</span></span><br><span class="line">        <span class="comment">// ChainWalker&lt;Association, BizObject&gt; otherWalker = new ...;</span></span><br><span class="line">        <span class="comment">// fkWalker.setNext(otherWalker);</span></span><br><span class="line">        ObjectWalker.walk(fkWalker, bill, fullname);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="com-yonyou-ucf-mdd-ext-bill-rule-check-CheckUniqueRule"><a href="#com-yonyou-ucf-mdd-ext-bill-rule-check-CheckUniqueRule" class="headerlink" title="com.yonyou.ucf.mdd.ext.bill.rule.check.CheckUniqueRule"></a>com.yonyou.ucf.mdd.ext.bill.rule.check.CheckUniqueRule</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service(&quot;checkUniqueRule&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CheckUniqueRule</span> <span class="keyword">extends</span> <span class="title class_">AbstractCommonRule</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(CheckUniqueRule.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CheckUniqueRule</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> RuleExecuteResult <span class="title function_">execute</span><span class="params">(BillContext billContext, Map&lt;String, Object&gt; paramMap)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (billContext == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RuleExecuteResult</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            List&lt;BizObject&gt; bills = <span class="built_in">this</span>.getBills(billContext, paramMap);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != bills &amp;&amp; bills.size() != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="type">Entity</span> <span class="variable">entity</span> <span class="operator">=</span> MetaDaoHelper.getEntity(billContext.getFullname());</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> == entity) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">&quot;查询元数据失败:&quot;</span> + billContext.getFullname());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="type">ServiceSupportHolder</span> <span class="variable">holder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServiceSupportHolder</span>(billContext, paramMap, bills, entity);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">config</span> <span class="operator">=</span> <span class="built_in">this</span>.getConfig();</span><br><span class="line">                    holder.setConfig(config);</span><br><span class="line">                    <span class="type">BillDataDto</span> <span class="variable">billDataDto</span> <span class="operator">=</span> (BillDataDto)<span class="built_in">this</span>.getParam(paramMap);</span><br><span class="line">                    holder.setBillData(billDataDto);</span><br><span class="line">                    <span class="type">IServiceSupportApi</span> <span class="variable">iServiceSupportApi</span> <span class="operator">=</span> (IServiceSupportApi)AppContext.getBean(CheckUniqueSupportService.class);</span><br><span class="line">                    <span class="keyword">return</span> (RuleExecuteResult)iServiceSupportApi.execute(holder);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RuleExecuteResult</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### com.yonyou.ucf.mdd.support.abs.AbstractServiceSupport</span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">execute</span><span class="params">(ServiceSupportHolder holder)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    beforeHandler(holder);	<span class="comment">//空</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">resultHandler</span> <span class="operator">=</span> doExecute(holder);</span><br><span class="line">    afterExecute(holder, resultHandler);	<span class="comment">//空</span></span><br><span class="line">    <span class="keyword">return</span> resultHandler;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">### com.yonyou.ucf.mdd.support.support.CheckUniqueSupportService</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">doExecute</span><span class="params">(ServiceSupportHolder holder)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">IDoBillService</span> <span class="variable">iDoBillService</span> <span class="operator">=</span> getBeanDo(ServiceSupportStatic.CheckUnique.DO);</span><br><span class="line">        <span class="keyword">return</span> iDoBillService.doExecute(holder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">### com.yonyou.ucf.mdd.support.support.check.checkunique.DoExecuteCheckUniqueService</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">doExecute</span><span class="params">(ServiceSupportHolder holder)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">BillDataDto</span> <span class="variable">item</span> <span class="operator">=</span> holder.getBillData();</span><br><span class="line">    <span class="comment">//是否check具体某个属性比如check_name,check_code</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isHasItem</span> <span class="operator">=</span> <span class="literal">null</span> == item.getItem() ? <span class="literal">false</span> : <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (isHasItem) &#123;</span><br><span class="line">        <span class="type">CheckItem</span> <span class="variable">checkItem</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Gson</span>().fromJson(item.getItem(), CheckItem.class);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == checkItem || checkItem.getKey() == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RuleExecuteResult</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Entity</span> <span class="variable">entity</span> <span class="operator">=</span> holder.getEntity();</span><br><span class="line">    <span class="comment">//构建检查唯一性的BO对象</span></span><br><span class="line">    <span class="type">CheckUnionBO</span> <span class="variable">checkUnionBO</span> <span class="operator">=</span> createCheckUnionBO(holder);</span><br><span class="line">    <span class="comment">//待回滚的参数 并发唯一了</span></span><br><span class="line">    List&lt;String&gt; needRollList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    List&lt;BizObject&gt; bills = holder.getBillList();</span><br><span class="line">    <span class="comment">//是否支持内存check</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">autoCode</span> <span class="operator">=</span> checkUnionBO.isAutoCode();</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; codeTempDataCaches = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 自动编码下需要把编码换成UUID，防止并发时被唯一校验控制，在UpdateBillCodeRule由编码规则统一控制</span></span><br><span class="line">        <span class="keyword">if</span> (!isHasItem &amp;&amp; autoCode) &#123;</span><br><span class="line">            codeTempDataCaches = checkUniqueCodeService.writeTempCode(bills, entity, holder.getBillContext(), holder.getParamMap());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//内存+redis检查</span></span><br><span class="line">        checkLocalUniqueService.checkUnionKeyObJVM(holder.getBillContext(), entity, checkUnionBO, bills, needRollList);</span><br><span class="line">        <span class="comment">//数据库检查 联合唯一性校验， 当校验参数为 null 用 is null 拼接条件</span></span><br><span class="line">        <span class="type">UniqueCheckWalker</span> <span class="variable">uniqueCheckWalker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UniqueCheckWalker</span>(AppContext.getPartitionContextData(entity, <span class="literal">true</span>), <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (!isHasItem) &#123;</span><br><span class="line">            checkDbUniqueService.checkUnionWithOutItem(holder, bills, entity, checkUnionBO.isCheckChild(), uniqueCheckWalker);</span><br><span class="line">            <span class="keyword">if</span> (autoCode) &#123;</span><br><span class="line">                checkUniqueCodeService.reWriteCode(codeTempDataCaches, bills, autoCode);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            checkDbUniqueService.checkUnionWithItem(holder.getBillContext(), bills, item, entity, uniqueCheckWalker);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != needRollList &amp;&amp; needRollList.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (TransactionSynchronizationManager.isActualTransactionActive()) &#123;</span><br><span class="line">                TransactionSynchronizationManager.registerSynchronization(<span class="keyword">new</span> <span class="title class_">DoExecuteAfterTransactionCompletion</span>(needRollList));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RuleExecuteResult</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="com-yonyou-ucf-mdd-ext-bill-rule-crud-SaveBillRule"><a href="#com-yonyou-ucf-mdd-ext-bill-rule-crud-SaveBillRule" class="headerlink" title="com.yonyou.ucf.mdd.ext.bill.rule.crud.SaveBillRule"></a>com.yonyou.ucf.mdd.ext.bill.rule.crud.SaveBillRule</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service(&quot;saveBillRule&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SaveBillRule</span> <span class="keyword">extends</span> <span class="title class_">AbstractCommonRule</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(SaveBillRule.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SaveBillRule</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ResubmitAnnotations</span></span><br><span class="line">    <span class="keyword">public</span> RuleExecuteResult <span class="title function_">execute</span><span class="params">(BillContext billContext, Map&lt;String, Object&gt; paramMap)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.executeCommon(billContext, paramMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> RuleExecuteResult <span class="title function_">executeCommon</span><span class="params">(BillContext billContext, Map&lt;String, Object&gt; paramMap)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        List&lt;BizObject&gt; bills = <span class="built_in">this</span>.getBills(billContext, paramMap);</span><br><span class="line">        <span class="type">Entity</span> <span class="variable">entity</span> <span class="operator">=</span> StringUtils.isBlank(billContext.getFullname()) ? <span class="literal">null</span> : IMetaUtils.entity(billContext.getFullname());</span><br><span class="line">        <span class="type">ServiceSupportHolder</span> <span class="variable">holder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServiceSupportHolder</span>(billContext, paramMap, bills, entity);</span><br><span class="line">        holder.setcBillNo(billContext.getBillnum());</span><br><span class="line">        <span class="built_in">this</span>.extendEnhance(holder);</span><br><span class="line">        <span class="type">IServiceSupportApi</span> <span class="variable">iServiceSupportApi</span> <span class="operator">=</span> (IServiceSupportApi)AppContext.getBean(SaveBillSupportService.class);</span><br><span class="line">        <span class="keyword">return</span> (RuleExecuteResult)iServiceSupportApi.execute(holder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">extendEnhance</span><span class="params">(ServiceSupportHolder holder)</span> &#123;</span><br><span class="line">        holder.getAttribute().setAttr(<span class="string">&quot;saveRealAutoCode&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### com.yonyou.ucf.mdd.support.abs.AbstractServiceSupport</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">execute</span><span class="params">(ServiceSupportHolder holder)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        beforeHandler(holder);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">resultHandler</span> <span class="operator">=</span> doExecute(holder);</span><br><span class="line">        afterExecute(holder, resultHandler);</span><br><span class="line">        <span class="keyword">return</span> resultHandler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> Object <span class="title function_">doExecute</span><span class="params">(ServiceSupportHolder holder)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### com.yonyou.ucf.mdd.support.support.SaveBillSupportService</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">doExecute</span><span class="params">(ServiceSupportHolder holder)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">IDoBillService</span> <span class="variable">iDoBillService</span> <span class="operator">=</span> getBeanDo(ServiceSupportStatic.Save.DO);</span><br><span class="line">        <span class="keyword">return</span> iDoBillService.doExecute(holder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">### com.yonyou.ucf.mdd.support.support.save.DoExecuteSaveBillService</span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> holder</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Seraph</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2021/5/2710:57 PM</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">doExecute</span><span class="params">(ServiceSupportHolder holder)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        List&lt;BizObject&gt; bills = holder.getBillList();</span><br><span class="line">        <span class="keyword">for</span> (BizObject bill : bills) &#123;</span><br><span class="line">            checkRelevantRuleVerify(holder,bill);</span><br><span class="line">            executeOneBill(holder, bill);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RuleExecuteResult</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> holder</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bill</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Seraph</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2021/5/2710:57 PM</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">executeOneBill</span><span class="params">(ServiceSupportHolder holder, BizObject bill)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">BillContext</span> <span class="variable">billContext</span> <span class="operator">=</span> holder.getBillContext();</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isInsert</span> <span class="operator">=</span> EntityStatus.Insert == bill.getEntityStatus() ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line">        setAudit(isInsert, bill, holder.getEntity().fullname());</span><br><span class="line">        BarCodeSupport.generateBarCode(billContext, holder.getEntity(), bill);<span class="comment">//处理条形码</span></span><br><span class="line">        setStatusInfoWhenInsert(holder,Status.newopen, bill, isInsert); <span class="comment">//设置单据状态</span></span><br><span class="line">        dealSupportBpm(bill, billContext, isInsert);<span class="comment">//处理工作流</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> getAndDealCode(holder, billContext, bill, isInsert); <span class="comment">//获取处置编码规则</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//保存业务逻辑</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> saveBillServiceImpl.executeSave(billContext, bill, holder.getParamMap(), holder.getEntity(), isInsert);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//重置编码规则</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != code) &#123;</span><br><span class="line">            bill.set(<span class="string">&quot;code&quot;</span>, code);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">BillSaveResult</span> <span class="variable">billSaveResult</span> <span class="operator">=</span> (BillSaveResult) result;</span><br><span class="line">        <span class="type">String</span> <span class="variable">partitionWhereCondition</span> <span class="operator">=</span> saveBillServiceImpl.buildQueryWhere4UpdateTree(holder.getEntity(), billContext); <span class="comment">//构建扩展分词条件</span></span><br><span class="line">        updateTree(bill, billContext.getFullname(), AppContext.getTenantId(), billSaveResult, partitionWhereCondition);    <span class="comment">//更新树</span></span><br><span class="line"><span class="comment">//        sendTimeLineSnapshot(billContext, bill, holder.getParamMap(), isInsert);  //新增时上传时间轴快照</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### com.yonyou.ucf.mdd.ext.bill.service.SaveBillServiceImpl</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> SaveBillServiceImpl#executeSave(com.yonyou.ucf.mdd.ext.model.BillContext, org.imeta.orm.base.BizObject, java.util.Map, org.imeta.core.model.Entity, java.lang.Boolean)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> InsertSqlExecutor#execute(org.imeta.core.model.Entity, java.util.List)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> UpdateSqlExecutor#execute(org.imeta.core.model.Entity, java.util.List)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     *      execute insert or update with _statis value &lt;code&gt;String&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> billContext billContext is one thread context &#123;<span class="doctag">@link</span> BillContext&#125; in the variable has props  context &#123;<span class="doctag">@link</span> Map&#125; &lt;code&gt;null&lt;/code&gt;save Resubmit key and other So.</span></span><br><span class="line"><span class="comment">     *      *             fullname : metaUri of metaServer  is the index of entity of meta</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bill  business data in &#123;<span class="doctag">@link</span> com.yonyou.ucf.mdd.ext.bill.dto.BillDataDto&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> paramMap Singleton instance in rule china &#123;<span class="doctag">@link</span> Map&#125; ,the request DTO in paramMap when in rule ,the DTO is instance of &#123;<span class="doctag">@link</span> BizObject&#125; Array</span></span><br><span class="line"><span class="comment">     *      *          when complete this rule  set paramMap for return</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> entity meta entity in metaServer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> isInert _statis value &lt;code&gt;String&lt;/code&gt;  insert or update</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> execute result</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">executeSave</span><span class="params">(BillContext billContext, BizObject bill, Map&lt;String, Object&gt; paramMap, Entity entity, Boolean isInert)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (isInert) &#123;</span><br><span class="line">                <span class="keyword">return</span> executeInsert(billContext, bill, paramMap, entity);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> executeUpdate(billContext, bill, entity);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (MddZeroResultMsgException zr)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MddVouchStateMsgException</span>(MsgExceptionCode.BILL_CHANGED_PLEASE_REFRESH);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> SaveBillServiceImpl#executeSave(com.yonyou.ucf.mdd.ext.model.BillContext, org.imeta.orm.base.BizObject, java.util.Map, org.imeta.core.model.Entity, java.lang.Boolean)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> InsertSqlExecutor#execute(org.imeta.core.model.Entity, java.util.List)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     *      execute insert or update with _statis value &lt;code&gt;String&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> billContext billContext is one thread context &#123;<span class="doctag">@link</span> BillContext&#125; in the variable has props  context &#123;<span class="doctag">@link</span> Map&#125; &lt;code&gt;null&lt;/code&gt;save Resubmit key and other So.</span></span><br><span class="line"><span class="comment">     *      *             fullname : metaUri of metaServer  is the index of entity of meta</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bill  business data in &#123;<span class="doctag">@link</span> com.yonyou.ucf.mdd.ext.bill.dto.BillDataDto&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> paramMap Singleton instance in rule china &#123;<span class="doctag">@link</span> Map&#125; ,the request DTO in paramMap when in rule ,the DTO is instance of &#123;<span class="doctag">@link</span> BizObject&#125; Array</span></span><br><span class="line"><span class="comment">     *      *          when complete this rule  set paramMap for return</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> entity meta entity in metaServer</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> execute result</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object <span class="title function_">executeInsert</span><span class="params">(BillContext billContext, BizObject bill, Map&lt;String, Object&gt; paramMap, Entity entity)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        fillPubts4Insert(bill);</span><br><span class="line">        <span class="comment">//开始递归插入数据</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InsertSqlExecutor</span>(AppContext.getSqlSession()).execute(entity, bill);</span><br><span class="line">        <span class="comment">//check project is open config of timeline and this bill is opened in timeline server</span></span><br><span class="line">        <span class="comment">//sendTimeLineSnapshot(billContext, bill, paramMap);</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BillSaveResult</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### com.yonyou.ucf.mdd.ext.dao.meta.crud.InsertSqlExecutor</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 元数据crud封装的insert实现</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Bob</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;DuplicatedCode&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InsertSqlExecutor</span> <span class="keyword">extends</span> <span class="title class_">MetaDaoSupport</span> &#123;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">public</span> &lt;T <span class="keyword">extends</span> <span class="title class_">BizObject</span>&gt; <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Entity entity, T data)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        List&lt;T&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;T&gt;(<span class="number">1</span>);</span><br><span class="line">        list.add(data);</span><br><span class="line">        execute(entity, list, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> &lt;T <span class="keyword">extends</span> <span class="title class_">BizObject</span>&gt; <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Entity entity, List&lt;T&gt; list, <span class="type">boolean</span> isPartition)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">true</span>) &#123;<span class="comment">//强制切换到InsertSqlExecutorNew</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InsertSqlExecutorNew</span>(getSqlSession()).execute(entity, list);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        printLogWHenEntityNull(entity, list);</span><br><span class="line">        <span class="comment">//传递多语开关配置到元数据上下文</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">fullname</span> <span class="operator">=</span> entity.fullname();</span><br><span class="line">        MddMultilingualUtil.setEnableI18n2Imeta();</span><br><span class="line">        <span class="comment">//提前将insert插入，为yTenant 判断做准备</span></span><br><span class="line">        <span class="type">EntityStatusWalker</span> <span class="variable">statusWalker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EntityStatusWalker</span>();</span><br><span class="line">        <span class="keyword">for</span> (BizObject bill : list) &#123;</span><br><span class="line">            bill.setEntityStatus(EntityStatus.Insert);</span><br><span class="line">            ObjectWalker.walk(statusWalker, bill, fullname);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (isPartition) &#123;</span><br><span class="line">            setTenantandCorpWhenSave(entity, list);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">InsertCheckWalker</span> <span class="variable">insertCheck</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InsertCheckWalker</span>();</span><br><span class="line">        insertCheck.setNext(<span class="keyword">new</span> <span class="title class_">FormatCheckWalker</span>());</span><br><span class="line">        <span class="comment">// 构造SQL语句</span></span><br><span class="line">        SqlBuilder&lt;BizObject&gt; builder = <span class="keyword">new</span> <span class="title class_">InsertSqlBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (BizObject bill : list) &#123;</span><br><span class="line">            ObjectHierarchyBuilder.build(bill, entity);</span><br><span class="line">            ObjectFullWalker.walk(insertCheck, bill, fullname);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                batchSaveExecute(builder.build(entity, bill));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">                logger.error(throwable.getMessage());</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MddOrmErrorException</span>(throwable.getMessage(),throwable);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>





<h5 id="com-yonyou-ucf-mdd-ext-pub-rule-SaveBusinessLogRule"><a href="#com-yonyou-ucf-mdd-ext-pub-rule-SaveBusinessLogRule" class="headerlink" title="com.yonyou.ucf.mdd.ext.pub.rule.SaveBusinessLogRule"></a>com.yonyou.ucf.mdd.ext.pub.rule.SaveBusinessLogRule</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Order(2147483647)</span></span><br><span class="line"><span class="meta">@Service(&quot;saveBusinessLogRule&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SaveBusinessLogRule</span> <span class="keyword">extends</span> <span class="title class_">AbstractCommonRule</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(SaveBusinessLogRule.class);</span><br><span class="line">    <span class="keyword">private</span> ExecutorService taskExecutor;</span><br><span class="line">    <span class="keyword">private</span> AuditLogSender auditLogSender;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SaveBusinessLogRule</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> RuleExecuteResult <span class="title function_">execute</span><span class="params">(<span class="keyword">final</span> BillContext billContext, <span class="keyword">final</span> Map&lt;String, Object&gt; paramMap)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> List&lt;BizObject&gt; bills = <span class="built_in">this</span>.getCloneBills(billContext, paramMap);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> InvocationInfoProxy.getYhtAccessToken();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">clientIp</span> <span class="operator">=</span> (String)InvocationInfoProxy.getExtendAttribute(<span class="string">&quot;clientIp&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">serviceCode</span> <span class="operator">=</span> (String)InvocationInfoProxy.getExtendAttribute(<span class="string">&quot;serviceCode&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(serviceCode)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">BillDataDto</span> <span class="variable">billDataDto</span> <span class="operator">=</span> (BillDataDto)<span class="built_in">this</span>.getParam(paramMap);</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> != billDataDto) &#123;</span><br><span class="line">                    Map&lt;String, Object&gt; externalData = BillUtils.getExternalData(billDataDto);</span><br><span class="line">                    serviceCode = (String)externalData.get(<span class="string">&quot;serviceCode&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception var10) &#123;</span><br><span class="line">                <span class="keyword">if</span> (logger.isErrorEnabled()) &#123;</span><br><span class="line">                    logger.error(<span class="string">&quot;从BillDataDto扩展参数中获取serviceCode失败&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!CollectionUtils.isEmpty(bills)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (TransactionSynchronizationManager.isSynchronizationActive()) &#123;</span><br><span class="line">                TransactionSynchronizationManager.registerSynchronization(<span class="keyword">new</span> <span class="title class_">TransactionSynchronizationAdapter</span>() &#123;</span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(<span class="type">int</span> status)</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="number">0</span> == status) &#123;</span><br><span class="line">                            SaveBusinessLogRule.<span class="built_in">this</span>.getTaskExecutor().execute(() -&gt; &#123;</span><br><span class="line">                                SaveBusinessLogRule.<span class="built_in">this</span>.executeAsync(billContext, paramMap, token, clientIp, bills, serviceCode);</span><br><span class="line">                            &#125;);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                logger.warn(<span class="string">&quot;业务日志异步执行，未开启事务。&quot;</span>);</span><br><span class="line">                <span class="built_in">this</span>.getTaskExecutor().execute(() -&gt; &#123;</span><br><span class="line">                    <span class="built_in">this</span>.executeAsync(billContext, paramMap, token, clientIp, bills, serviceCode);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">JsonFormatter</span> <span class="variable">formatter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JsonFormatter</span>(BizContext.getMetaRepository());</span><br><span class="line">            <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> formatter.toJson(bills, billContext.getFullname(), <span class="literal">false</span>, <span class="number">32</span>).toString();</span><br><span class="line">            logger.error(<span class="string">&quot;业务日志getCloneBills为空: 参数---billContext:&#123;&#125;,bills:&#123;&#125;&quot;</span>, JSONObject.toJSONString(billContext), json);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RuleExecuteResult</span>();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h5 id="com-yonyou-ucf-mdd-ext-bill-rule-biz-RefreshTsRule"><a href="#com-yonyou-ucf-mdd-ext-bill-rule-biz-RefreshTsRule" class="headerlink" title="com.yonyou.ucf.mdd.ext.bill.rule.biz.RefreshTsRule"></a>com.yonyou.ucf.mdd.ext.bill.rule.biz.RefreshTsRule</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service(&quot;refreshTsRule&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RefreshTsRule</span> <span class="keyword">extends</span> <span class="title class_">AbstractCommonRule</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RefreshTsRule</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> RuleExecuteResult <span class="title function_">execute</span><span class="params">(BillContext billContext, Map&lt;String, Object&gt; paramMap)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">fullname</span> <span class="operator">=</span> billContext.getFullname();</span><br><span class="line">        List&lt;BizObject&gt; bills = <span class="built_in">this</span>.getBills(billContext, paramMap);</span><br><span class="line">        <span class="type">String</span> <span class="variable">refreshField</span> <span class="operator">=</span> (String)<span class="built_in">this</span>.getParam(paramMap, <span class="string">&quot;refreshField&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != bills &amp;&amp; bills.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">Iterator</span> <span class="variable">var6</span> <span class="operator">=</span> bills.iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(var6.hasNext()) &#123;</span><br><span class="line">                <span class="type">BizObject</span> <span class="variable">bill</span> <span class="operator">=</span> (BizObject)var6.next();</span><br><span class="line">                BillInfoUtils.refreshTs(fullname, bill, refreshField, AppContext.getTenantId());</span><br><span class="line">                <span class="type">DataCleanWalker</span> <span class="variable">dataCleanWalker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataCleanWalker</span>();</span><br><span class="line">                dataCleanWalker.setNext(<span class="keyword">new</span> <span class="title class_">ParallelTableWalker</span>());</span><br><span class="line">                ObjectFullWalker.walk(dataCleanWalker, bill, fullname);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            LogicDeleteHelper.removeLogicDelete(fullname, bills);</span><br><span class="line">            <span class="keyword">if</span> (bills.size() == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.putParam(paramMap, <span class="string">&quot;return&quot;</span>, bills.get(<span class="number">0</span>));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.putParam(paramMap, <span class="string">&quot;return&quot;</span>, bills);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RuleExecuteResult</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h5 id="com-yonyou-common-bizflow-rule-BizFlowWriteBackRule低代码回写规则"><a href="#com-yonyou-common-bizflow-rule-BizFlowWriteBackRule低代码回写规则" class="headerlink" title="com.yonyou.common.bizflow.rule.BizFlowWriteBackRule低代码回写规则"></a>com.yonyou.common.bizflow.rule.BizFlowWriteBackRule低代码回写规则</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> RuleExecuteResult <span class="title function_">execute</span><span class="params">(BillContext billContext, Map&lt;String, Object&gt; paramMap)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">RuleExecuteResult</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RuleExecuteResult</span>();</span><br><span class="line">    LogUtil.log(<span class="string">&quot;业务流：BizFlowWriteBackRule start! &quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.doWriteBack(billContext, paramMap);</span><br><span class="line">        LogUtil.log(<span class="string">&quot;业务流：BizFlowWriteBackRule end! &quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var5) &#123;</span><br><span class="line">        LogUtil.log(<span class="string">&quot;业务流：BizFlowWriteBackRule error!&quot;</span>, var5);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doWriteBack</span><span class="params">(BillContext billContext, Map&lt;String, Object&gt; paramMap)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">BillDataDto</span> <span class="variable">reqDto</span> <span class="operator">=</span> (BillDataDto)paramMap.get(<span class="string">&quot;param&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">domain</span> <span class="operator">=</span> BizFlowUtil.getDomain(billContext);</span><br><span class="line">    <span class="type">String</span> <span class="variable">billNum</span> <span class="operator">=</span> BizFlowUtil.getBillNum(reqDto);</span><br><span class="line">    <span class="type">String</span> <span class="variable">tenantId</span> <span class="operator">=</span> BizFlowUtil.getTenantId();</span><br><span class="line">    <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> InvocationInfoProxy.getYhtAccessToken();</span><br><span class="line">    <span class="type">String</span> <span class="variable">operate</span> <span class="operator">=</span> billContext.getAction();</span><br><span class="line">    <span class="type">String</span> <span class="variable">subId</span> <span class="operator">=</span> billContext.getSubid();</span><br><span class="line">    List&lt;JSONObject&gt; bills = BizFlowUtil.getBills(reqDto);</span><br><span class="line">    <span class="type">Iterator</span> <span class="variable">var11</span> <span class="operator">=</span> bills.iterator();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(var11.hasNext()) &#123;</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">bill</span> <span class="operator">=</span> (JSONObject)var11.next();</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.noNeedWriteBackConvert(bill, domain, operate)) &#123;</span><br><span class="line">            LogUtil.log(<span class="string">&quot;业务流：BizFlowWriteBackRule skip bill: &quot;</span> + bill);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LogUtil.log(<span class="string">&quot;业务流：BizFlowWriteBackRule bill: &quot;</span> + bill);</span><br><span class="line">            <span class="type">ConvertParam</span> <span class="variable">convertParam</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConvertParam</span>();</span><br><span class="line">            convertParam.setTenantId(tenantId);</span><br><span class="line">            convertParam.setBillNum(billNum);</span><br><span class="line">            convertParam.setBillId(bill.getString(<span class="string">&quot;id&quot;</span>));</span><br><span class="line">            convertParam.addBill(bill);</span><br><span class="line">            convertParam.setToken(token);</span><br><span class="line">            convertParam.setOperate(operate);</span><br><span class="line">            convertParam.setSubId(subId);</span><br><span class="line">            convertParam.setDomain(domain);</span><br><span class="line">            LogUtil.log(<span class="string">&quot;业务流：BizFlowWriteBackRule convert PARAM: &quot;</span> + JSON.toJSONString(convertParam));</span><br><span class="line">            <span class="type">ConvertResult</span> <span class="variable">convertResult</span> <span class="operator">=</span> BizFlowUtil.doWriteBackConvert(convertParam);</span><br><span class="line">            LogUtil.log(<span class="string">&quot;业务流：BizFlowWriteBackRule convert result: &quot;</span> + JSON.toJSONString(convertResult));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">noNeedWriteBackConvert</span><span class="params">(JSONObject bill, String domain, String action)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="string">&quot;audit&quot;</span>.equalsIgnoreCase(action) &amp;&amp; !<span class="string">&quot;unaudit&quot;</span>.equalsIgnoreCase(action)) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">flowId</span> <span class="operator">=</span> ObjectUtil.getString(bill, <span class="string">&quot;bizFlowId&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;developplatform&quot;</span>.equalsIgnoreCase(domain) &amp;&amp; ObjectUtil.isEmpty(flowId)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">writeBackSign</span> <span class="operator">=</span> ObjectUtil.getString(bill, <span class="string">&quot;bizFlowWriteBackSign&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;bizFlowWriteBackSign&quot;</span>.equals(writeBackSign);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="com-yonyou-common-bizflow-rule-BizFlowPushRule"><a href="#com-yonyou-common-bizflow-rule-BizFlowPushRule" class="headerlink" title="com.yonyou.common.bizflow.rule.BizFlowPushRule"></a>com.yonyou.common.bizflow.rule.BizFlowPushRule</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(BizFlowPushRule.class);</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">IYpdBillDataService iYpdBillDataService;</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">MdfTemplateRunTimeServiceImpl mdfTemplateRunTimeService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">BizFlowPushRule</span><span class="params">()</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> RuleExecuteResult <span class="title function_">execute</span><span class="params">(BillContext billContext, Map&lt;String, Object&gt; paramMap)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">BizFlowRuleResult</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BizFlowRuleResult</span>();</span><br><span class="line">    LogUtil.log(<span class="string">&quot;业务流：bizFlowPush start! &quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">BillDataDto</span> <span class="variable">reqDto</span> <span class="operator">=</span> (BillDataDto)paramMap.get(<span class="string">&quot;param&quot;</span>);</span><br><span class="line">        Map&lt;String, Object&gt; cusMap = reqDto.getCustMap();</span><br><span class="line">        <span class="type">String</span> <span class="variable">billNum</span> <span class="operator">=</span> BizFlowUtil.removeSuffix(reqDto.getBillnum());</span><br><span class="line">        List&lt;JSONObject&gt; bills = BizFlowUtil.getBills(reqDto);</span><br><span class="line">        <span class="type">String</span> <span class="variable">domain</span> <span class="operator">=</span> BizFlowUtil.getDomain(billContext);</span><br><span class="line">        <span class="type">ConvertResult</span> <span class="variable">convertResult</span> <span class="operator">=</span> BizFlowUtil.doPush(billNum, bills, cusMap, billContext.getSubid(), domain, billContext.getAction());</span><br><span class="line">        <span class="keyword">if</span> (Boolean.TRUE.equals(AppContext.getCurrentUser().getNewArch())) &#123;</span><br><span class="line">            <span class="built_in">this</span>.busObjToUIData(billContext, paramMap, convertResult);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        paramMap.put(<span class="string">&quot;bizFlowReturn&quot;</span>, convertResult);</span><br><span class="line">        result.setConvertResult(convertResult);</span><br><span class="line">        LogUtil.log(<span class="string">&quot;业务流：bizFlowPush end! &quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var10) &#123;</span><br><span class="line">        LogUtil.log(<span class="string">&quot;业务流：bizFlowPush error!&quot;</span>, var10);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="https://bucket-wjc-imageload.oss-cn-beijing.aliyuncs.com/imageload-for-typora/image-20230203141336848.png" alt="image-20230203141336848"></p>
<h5 id="com-yonyou-business-StockServiceTccRule"><a href="#com-yonyou-business-StockServiceTccRule" class="headerlink" title="com.yonyou.business.StockServiceTccRule"></a>com.yonyou.business.StockServiceTccRule</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component(&quot;stockServiceTccRule&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StockSer</span>  viceTccRule <span class="keyword">extends</span> <span class="title class_">AbstractCommonRule</span> <span class="keyword">implements</span> <span class="title class_">ITccRule</span> &#123;</span><br><span class="line"><span class="comment">// private static final String URI = &quot;XMFYGJ102.XMFYGJ102.bookstock_yts&quot;;</span></span><br><span class="line">   <span class="comment">//日常</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">URI</span> <span class="operator">=</span> <span class="string">&quot;GT52146AT26.GT52146AT26.bookstock_yts&quot;</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PRODUCTID</span> <span class="operator">=</span> <span class="string">&quot;sproductid&quot;</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ITOTAL</span> <span class="operator">=</span> <span class="string">&quot;itotal&quot;</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">INUMBER</span> <span class="operator">=</span> <span class="string">&quot;inumber&quot;</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">IONWAY</span> <span class="operator">=</span> <span class="string">&quot;ionway&quot;</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SNAME</span> <span class="operator">=</span> <span class="string">&quot;sname&quot;</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(StockServiceTccRule.class);</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">    IOrderService orderService;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> RuleExecuteResult <span class="title function_">execute</span><span class="params">(BillContext billContext, Map&lt;String, Object&gt; map)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      logger.info(<span class="string">&quot;StockServiceRule running!&quot;</span>);</span><br><span class="line">      List&lt;BizObject&gt; bills = <span class="built_in">this</span>.getBills(billContext, map);</span><br><span class="line">      <span class="type">boolean</span> <span class="variable">hasTccFlag</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">for</span> (BizObject bizObject : bills) &#123;</span><br><span class="line">         <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> bizObject.get(SNAME);</span><br><span class="line">         <span class="keyword">if</span> (!StringUtils.isEmpty(name) &amp;&amp; name.toLowerCase(Locale.ENGLISH).indexOf(<span class="string">&quot;iris&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">            hasTccFlag = <span class="literal">true</span>;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span> (BizObject bizObject : bills) &#123;</span><br><span class="line">         <span class="type">String</span> <span class="variable">ProductId</span> <span class="operator">=</span> bizObject.get(PRODUCTID);</span><br><span class="line">         <span class="keyword">if</span> (<span class="literal">null</span> == ProductId) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;商品ID不能为空&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">// 下单数量</span></span><br><span class="line">         <span class="type">Integer</span> <span class="variable">num</span> <span class="operator">=</span> bizObject.get(INUMBER);</span><br><span class="line">         <span class="keyword">if</span> (<span class="literal">null</span> == num || num &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;数量不能为空或小于0&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="type">BizObject</span> <span class="variable">stock</span> <span class="operator">=</span> MetaDaoHelper.findById(URI, ProductId);</span><br><span class="line">         stock.put(<span class="string">&quot;_status&quot;</span>, EntityStatus.Update);</span><br><span class="line">         <span class="comment">// tcc模式，正向先扣库存</span></span><br><span class="line">         <span class="type">Integer</span> <span class="variable">oldItotal</span> <span class="operator">=</span> (Integer)stock.get(ITOTAL);</span><br><span class="line">         <span class="keyword">if</span> (num &gt; oldItotal) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;库存不足&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         stock.put(ITOTAL, oldItotal - num);</span><br><span class="line">         <span class="comment">// 增加在途库存</span></span><br><span class="line">         <span class="type">Integer</span> <span class="variable">oldIonway</span> <span class="operator">=</span> (Integer)stock.get(IONWAY);</span><br><span class="line">         stock.put(IONWAY, oldIonway + num);</span><br><span class="line">         </span><br><span class="line">         <span class="type">Transaction</span> <span class="variable">yts</span> <span class="operator">=</span> YtsContext.currentTransaction();</span><br><span class="line">         <span class="keyword">if</span> (<span class="literal">null</span> != yts) &#123;</span><br><span class="line">            stock.put(<span class="string">&quot;gtxid&quot;</span>, yts.getGtxId());</span><br><span class="line">            stock.put(<span class="string">&quot;ptxid&quot;</span>, yts.getPtxId());</span><br><span class="line">            stock.put(<span class="string">&quot;txid&quot;</span>, yts.getTxId());</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="comment">//将sorderid存入redis</span></span><br><span class="line">         <span class="type">String</span> <span class="variable">sorderid</span> <span class="operator">=</span> bizObject.get(<span class="string">&quot;sorderid&quot;</span>);</span><br><span class="line">         redisTemplate.opsForValue().set(sorderid,yts.getGtxId(),<span class="number">30l</span>, TimeUnit.MINUTES);</span><br><span class="line">         </span><br><span class="line">         MetaDaoHelper.update(URI, stock);</span><br><span class="line">         </span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (hasTccFlag) &#123;</span><br><span class="line">         <span class="type">TourOrder</span> <span class="variable">order</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TourOrder</span>();</span><br><span class="line">         order.setUserId(UUID.randomUUID().toString());</span><br><span class="line">         order.setTourOrderId(UUID.randomUUID().toString());</span><br><span class="line">         order.setOrderName(<span class="string">&quot;订单号:&quot;</span> + order.getOrderName());</span><br><span class="line">         order.setUserName(<span class="string">&quot;yongyou&quot;</span>);</span><br><span class="line"></span><br><span class="line">         <span class="type">TourOrder</span> <span class="variable">norder</span> <span class="operator">=</span> orderService.sagas(order);</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;order: &#123;&#125;&quot;</span>, JSON.toJSONString(norder));</span><br><span class="line">         &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            logger.warn(<span class="string">&quot;toJSONString error &quot;</span>, e);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>  <span class="keyword">new</span> <span class="title class_">RuleExecuteResult</span>();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> RuleExecuteResult <span class="title function_">confirm</span><span class="params">(BillContext billContext, Map&lt;String, Object&gt; paramMap)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      logger.info(<span class="string">&quot;StockServiceRule rollback!&quot;</span>);</span><br><span class="line">      List&lt;BizObject&gt; bills = <span class="built_in">this</span>.getBills(billContext, paramMap);</span><br><span class="line">      <span class="keyword">for</span> (BizObject bizObject : bills) &#123;</span><br><span class="line">         <span class="type">String</span> <span class="variable">ProductId</span> <span class="operator">=</span> bizObject.get(PRODUCTID);</span><br><span class="line">         <span class="keyword">if</span> (<span class="literal">null</span> == ProductId) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;商品ID不能为空&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">// 下单数量</span></span><br><span class="line">         <span class="type">Integer</span> <span class="variable">num</span> <span class="operator">=</span> bizObject.get(INUMBER);</span><br><span class="line">         <span class="keyword">if</span> (<span class="literal">null</span> == num || num &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;数量不能为空或小于0&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">// tcc模式成功，减去在途库存,交易完成</span></span><br><span class="line">         <span class="type">BizObject</span> <span class="variable">stock</span> <span class="operator">=</span> MetaDaoHelper.findById(URI, ProductId);</span><br><span class="line">         stock.put(<span class="string">&quot;_status&quot;</span>, EntityStatus.Update);</span><br><span class="line">         <span class="type">Integer</span> <span class="variable">oldIonway</span> <span class="operator">=</span> (Integer)stock.get(IONWAY);</span><br><span class="line">         stock.put(IONWAY, oldIonway - num);</span><br><span class="line">         </span><br><span class="line">         MetaDaoHelper.update(URI, stock);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RuleExecuteResult</span>();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> RuleExecuteResult <span class="title function_">cancel</span><span class="params">(BillContext billContext, Map&lt;String, Object&gt; map)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      logger.info(<span class="string">&quot;StockServiceRule rollback!&quot;</span>);</span><br><span class="line">      List&lt;BizObject&gt; bills = <span class="built_in">this</span>.getBills(billContext, map);</span><br><span class="line">      <span class="keyword">for</span> (BizObject bizObject : bills) &#123;</span><br><span class="line">         <span class="type">String</span> <span class="variable">ProductId</span> <span class="operator">=</span> bizObject.get(PRODUCTID);</span><br><span class="line">         <span class="keyword">if</span> (<span class="literal">null</span> == ProductId) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;商品ID不能为空&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">// 下单数量</span></span><br><span class="line">         <span class="type">Integer</span> <span class="variable">num</span> <span class="operator">=</span> bizObject.get(INUMBER);</span><br><span class="line">         <span class="keyword">if</span> (<span class="literal">null</span> == num || num &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;数量不能为空或小于0&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">// tcc模式失败，将在途库存加回可用库存</span></span><br><span class="line">         <span class="type">BizObject</span> <span class="variable">stock</span> <span class="operator">=</span> MetaDaoHelper.findById(URI, ProductId);</span><br><span class="line">         stock.put(<span class="string">&quot;_status&quot;</span>, EntityStatus.Update);</span><br><span class="line">         <span class="type">Integer</span> <span class="variable">oldItotal</span> <span class="operator">=</span> (Integer)stock.get(ITOTAL);</span><br><span class="line">         stock.put(ITOTAL, oldItotal + num);</span><br><span class="line">         </span><br><span class="line">         <span class="type">Integer</span> <span class="variable">oldIonway</span> <span class="operator">=</span> (Integer)stock.get(IONWAY);</span><br><span class="line">         stock.put(IONWAY, oldIonway - num);</span><br><span class="line">         </span><br><span class="line">         MetaDaoHelper.update(URI, stock);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RuleExecuteResult</span>();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="com-yonyou-business-PayServiceTccRule"><a href="#com-yonyou-business-PayServiceTccRule" class="headerlink" title="com.yonyou.business.PayServiceTccRule"></a>com.yonyou.business.PayServiceTccRule</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component(&quot;payServiceTccRule&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayServiceTccRule</span> <span class="keyword">extends</span> <span class="title class_">AbstractCommonRule</span> <span class="keyword">implements</span> <span class="title class_">ITccRule</span> &#123;</span><br><span class="line"><span class="comment">// private static final String URI = &quot;XMFYGJ103.XMFYGJ103.bookpay_yts&quot;;</span></span><br><span class="line">   <span class="comment">//日常</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">URI</span> <span class="operator">=</span> <span class="string">&quot;GT52131AT25.GT52131AT25.bookpay_yts&quot;</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SUSERID</span> <span class="operator">=</span> <span class="string">&quot;sbuyer&quot;</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FTOTAL</span> <span class="operator">=</span> <span class="string">&quot;ftotal&quot;</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FAVAILABLE</span> <span class="operator">=</span> <span class="string">&quot;favailable&quot;</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FONWAY</span> <span class="operator">=</span> <span class="string">&quot;fonway&quot;</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SNAME</span> <span class="operator">=</span> <span class="string">&quot;sname&quot;</span>;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   IOrderService orderService;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(PayServiceTccRule.class);</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> RuleExecuteResult <span class="title function_">execute</span><span class="params">(BillContext billContext, Map&lt;String, Object&gt; map)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      logger.info(<span class="string">&quot;PayServiceRule running!&quot;</span>);</span><br><span class="line">      List&lt;BizObject&gt; bills = <span class="built_in">this</span>.getBills(billContext, map);</span><br><span class="line">      <span class="type">boolean</span> <span class="variable">hasTccFlag</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">for</span> (BizObject bizObject : bills) &#123;</span><br><span class="line">         <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> bizObject.get(SNAME);</span><br><span class="line">         <span class="keyword">if</span> (!StringUtils.isEmpty(name) &amp;&amp; name.toLowerCase(Locale.ENGLISH).indexOf(<span class="string">&quot;tcc&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">            hasTccFlag = <span class="literal">true</span>;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/*if(hasTccFlag) &#123;</span></span><br><span class="line"><span class="comment">         TourOrder order = new TourOrder();</span></span><br><span class="line"><span class="comment">         order.setUserId(UUID.randomUUID().toString());</span></span><br><span class="line"><span class="comment">         order.setTourOrderId(UUID.randomUUID().toString());</span></span><br><span class="line"><span class="comment">         order.setOrderName(&quot;订单号:&quot; + order.getOrderName());</span></span><br><span class="line"><span class="comment">         order.setUserName(&quot;yongyou&quot;);</span></span><br><span class="line"><span class="comment">         orderService.tcc(order);</span></span><br><span class="line"><span class="comment">      &#125;*/</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (BizObject bizObject : bills) &#123;</span><br><span class="line">         <span class="comment">// 账户</span></span><br><span class="line">         <span class="type">String</span> <span class="variable">UserId</span> <span class="operator">=</span> bizObject.get(SUSERID);</span><br><span class="line">         <span class="keyword">if</span> (<span class="literal">null</span> == UserId) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;账户ID不能为空&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">// 待支付金额</span></span><br><span class="line">         <span class="type">BigDecimal</span> <span class="variable">total</span> <span class="operator">=</span> bizObject.get(FTOTAL);</span><br><span class="line">         <span class="keyword">if</span> (<span class="literal">null</span> == total || total.floatValue() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;支付金额不能为空或小于0&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="type">BizObject</span> <span class="variable">pay</span> <span class="operator">=</span> MetaDaoHelper.findById(URI, UserId);</span><br><span class="line">         pay.put(<span class="string">&quot;_status&quot;</span>, EntityStatus.Update);</span><br><span class="line">         <span class="comment">// 账户可用金额</span></span><br><span class="line">         <span class="type">BigDecimal</span> <span class="variable">oldFavailable</span> <span class="operator">=</span>  pay.get(FAVAILABLE);</span><br><span class="line">         <span class="keyword">if</span> (total.floatValue() &gt; oldFavailable.floatValue()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;当前账户余额不足&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">          </span><br><span class="line">         pay.put(FAVAILABLE, oldFavailable.subtract(total));</span><br><span class="line">         <span class="comment">// 账户在途金额，增加待付金额</span></span><br><span class="line">         <span class="type">BigDecimal</span> <span class="variable">oldOnway</span> <span class="operator">=</span>  pay.get(FONWAY);</span><br><span class="line">         pay.put(FONWAY, oldOnway.add(total));</span><br><span class="line">         </span><br><span class="line">         <span class="type">Transaction</span> <span class="variable">yts</span> <span class="operator">=</span> YtsContext.currentTransaction();</span><br><span class="line">         <span class="keyword">if</span> (<span class="literal">null</span> != yts) &#123;</span><br><span class="line">            pay.put(<span class="string">&quot;gtxid&quot;</span>, yts.getGtxId());</span><br><span class="line">            pay.put(<span class="string">&quot;ptxid&quot;</span>, yts.getPtxId());</span><br><span class="line">            pay.put(<span class="string">&quot;txid&quot;</span>, yts.getTxId());</span><br><span class="line">         &#125;</span><br><span class="line">         MetaDaoHelper.update(URI, pay);    </span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span>  <span class="keyword">new</span> <span class="title class_">RuleExecuteResult</span>();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> RuleExecuteResult <span class="title function_">confirm</span><span class="params">(BillContext billContext, Map&lt;String, Object&gt; map)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      logger.info(<span class="string">&quot;PayServiceRule rollback!&quot;</span>);</span><br><span class="line">      List&lt;BizObject&gt; bills = <span class="built_in">this</span>.getBills(billContext, map);</span><br><span class="line">      <span class="keyword">for</span> (BizObject bizObject : bills) &#123;</span><br><span class="line">         <span class="comment">// 账户</span></span><br><span class="line">         <span class="type">String</span> <span class="variable">UserId</span> <span class="operator">=</span> bizObject.get(SUSERID);</span><br><span class="line">         <span class="keyword">if</span> (<span class="literal">null</span> == UserId) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;账户ID不能为空&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">// 待支付金额</span></span><br><span class="line">         <span class="type">BigDecimal</span> <span class="variable">total</span> <span class="operator">=</span> bizObject.get(FTOTAL);</span><br><span class="line">         <span class="keyword">if</span> (<span class="literal">null</span> == total || total.floatValue() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;支付金额不能为空或小于0&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="type">BizObject</span> <span class="variable">pay</span> <span class="operator">=</span> MetaDaoHelper.findById(URI, UserId);</span><br><span class="line">         pay.put(<span class="string">&quot;_status&quot;</span>, EntityStatus.Update);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// 成功则把在途金额减掉，交易完成    </span></span><br><span class="line">         <span class="type">BigDecimal</span> <span class="variable">oldOnway</span> <span class="operator">=</span>  pay.get(FONWAY);</span><br><span class="line">         pay.put(FONWAY, oldOnway.subtract(total));</span><br><span class="line">         </span><br><span class="line">         MetaDaoHelper.update(URI, pay);    </span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RuleExecuteResult</span>();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> RuleExecuteResult <span class="title function_">cancel</span><span class="params">(BillContext billContext, Map&lt;String, Object&gt; map)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      logger.info(<span class="string">&quot;PayServiceRule rollback!&quot;</span>);</span><br><span class="line">      List&lt;BizObject&gt; bills = <span class="built_in">this</span>.getBills(billContext, map);</span><br><span class="line">      <span class="keyword">for</span> (BizObject bizObject : bills) &#123;</span><br><span class="line">         <span class="comment">// 账户</span></span><br><span class="line">         <span class="type">String</span> <span class="variable">UserId</span> <span class="operator">=</span> bizObject.get(SUSERID);</span><br><span class="line">         <span class="keyword">if</span> (<span class="literal">null</span> == UserId) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;账户ID不能为空&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">// 待支付金额</span></span><br><span class="line">         <span class="type">BigDecimal</span> <span class="variable">total</span> <span class="operator">=</span> bizObject.get(FTOTAL);</span><br><span class="line">         <span class="keyword">if</span> (<span class="literal">null</span> == total || total.floatValue() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;支付金额不能为空或小于0&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="type">BizObject</span> <span class="variable">pay</span> <span class="operator">=</span> MetaDaoHelper.findById(URI, UserId);</span><br><span class="line">         pay.put(<span class="string">&quot;_status&quot;</span>, EntityStatus.Update);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// 失败则把在途金额加回可用金额</span></span><br><span class="line">         <span class="type">BigDecimal</span> <span class="variable">old</span> <span class="operator">=</span> pay.get(FAVAILABLE);</span><br><span class="line">         pay.put(FAVAILABLE, old.add(total));</span><br><span class="line">      </span><br><span class="line">         <span class="type">BigDecimal</span> <span class="variable">oldOnway</span> <span class="operator">=</span>  pay.get(FONWAY);</span><br><span class="line">         pay.put(FONWAY, oldOnway.subtract(total));</span><br><span class="line">         </span><br><span class="line">         MetaDaoHelper.update(URI, pay);    </span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RuleExecuteResult</span>();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-3-MDD框架com-yonyou-ucf-mdf-app-service-impl-BillServiceImp-add方法梳理（部分内容）-md"><a href="#2-3-MDD框架com-yonyou-ucf-mdf-app-service-impl-BillServiceImp-add方法梳理（部分内容）-md" class="headerlink" title="2.3.MDD框架com.yonyou.ucf.mdf.app.service.impl.BillServiceImp add方法梳理（部分内容）.md"></a>2.3.MDD框架com.yonyou.ucf.mdf.app.service.impl.BillServiceImp add方法梳理（部分内容）.md</h3><p>com.yonyou.ucf.mdf.app.service.impl.<strong>BillServiceImp</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">add</span><span class="params">(BaseReqDto addDto)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="type">RuleContext</span> <span class="variable">ruleContext</span> <span class="operator">=</span> RuleEngineUtils.prepareRuleContext(addDto, OperationTypeEnum.ADD);</span><br><span class="line">        <span class="type">RuleExecuteResult</span> <span class="variable">result</span> <span class="operator">=</span> RuleEngine.getInstance().execute(ruleContext);</span><br><span class="line">        <span class="keyword">if</span> (result.getMsgCode() != <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(result.getMessage());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> result.getData() == <span class="literal">null</span> ? <span class="string">&quot;&quot;</span> : GsonHelper.ToJSon(result.getData());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;bill add 异常&quot;</span>,e);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>com&#x2F;yonyou&#x2F;ucf&#x2F;mdd&#x2F;rule&#x2F;api&#x2F;<strong>RuleEngine</strong>.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 规则引擎执行入口</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ruleContext 规则执行所需数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> RuleExecuteResult <span class="title function_">execute</span><span class="params">(RuleContext ruleContext)</span> <span class="keyword">throws</span> MddBaseException &#123;</span><br><span class="line">    Queue&lt;? <span class="keyword">extends</span> <span class="title class_">RuleRegister</span>&gt; ruleList ;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ruleList = doGetRules(ruleContext);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;获取规则列表异常!&quot;</span>, e);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> doExecRules(ruleContext, ruleList);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;执行rule异常!&quot;</span>, e);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 调用handleRuleList 方法返回 规则列表</span></span><br><span class="line"><span class="comment">     * 可适配自定义获取规则列表的 处理器。</span></span><br><span class="line"><span class="comment">     * 自定义RuleListHandler 需实现 IRuleListHandler</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ruleContext</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">public</span> Queue&lt;? <span class="keyword">extends</span> <span class="title class_">RuleRegister</span>&gt; doGetRules(RuleContext ruleContext) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">IRuleListHandler</span> <span class="variable">ruleListHandler</span> <span class="operator">=</span> ruleContext.getRuleListHandler();</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == ruleListHandler) &#123;</span><br><span class="line">        ruleListHandler = <span class="keyword">new</span> <span class="title class_">DefaultRuleListHandler</span>();</span><br><span class="line">        log.debug(<span class="string">&quot;##RuleEngine:doGetRules # 使用 DefaultRuleListHandler&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;##RuleEngine:doGetRules # 使用自定义 RuleListHandler&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Queue</span> <span class="variable">ruleList</span> <span class="operator">=</span>  ruleListHandler.handleRuleList(ruleContext);</span><br><span class="line">    ExtListUtil.checkRuleList(ruleList);</span><br><span class="line">    <span class="keyword">return</span> ruleList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>com&#x2F;yonyou&#x2F;ucf&#x2F;mdd&#x2F;rule&#x2F;handler&#x2F;<strong>DefaultRuleListHandler</strong>.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Queue&lt;RuleRegister&gt; <span class="title function_">handleRuleList</span><span class="params">(RuleContext ruleContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">Object</span> <span class="variable">bill</span> <span class="operator">=</span> ruleContext.getCustomMap().get(<span class="string">&quot;param&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">action</span> <span class="operator">=</span> ruleContext.getOperateType() == <span class="literal">null</span> ? ruleContext.getOperationTypeEx() : ruleContext.getOperateType().getValue();</span><br><span class="line">    String[] ruleLvs = ruleContext.getRuleLvs();</span><br><span class="line">    <span class="keyword">if</span> (ruleContext.isMakeup()) &#123;<span class="comment">//如果是异步规则，是否支持失败后规则补偿</span></span><br><span class="line">        <span class="keyword">return</span> getMakeupRuleList(action, ruleContext.getTenantId());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">uiTenantId</span> <span class="operator">=</span> ruleContext.getTenantId();</span><br><span class="line">    <span class="keyword">if</span> (ruleContext.getTenantId() == <span class="literal">null</span> || StringUtils.isEmpty(ruleContext.getTenantId() + <span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">        uiTenantId = AppContext.getTenantIdNoCallBack();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> getRuleList(ruleContext.getBillnum(), ruleLvs, action, bill, uiTenantId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * important : action eq check and key is not null in billObject action set value check_key&lt;code&gt;null&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     * getList should merge check with check_key</span></span><br><span class="line"><span class="comment">     * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ruleLvs  Rule Level :ruleLvs[0] = &quot;common&quot;; ruleLvs[1] = uiMetaBaseInfo.getSubid(); ruleLvs[2] = uiMetaBaseInfo.getBillnum();</span></span><br><span class="line"><span class="comment">     *                 over rule : from high to low</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> action   the action for request exp: save,delete,update,list and so on</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bill     object &#123;<span class="doctag">@link</span> BaseDto&#125; if type of &#123;<span class="doctag">@link</span> BaseDto&#125; return this else come from param others is &lt;code&gt;null&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tenantId tenantId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&#123;&quot;rawtypes&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">private</span> Queue&lt;RuleRegister&gt; <span class="title function_">getRuleList</span><span class="params">(String billnum, String[] ruleLvs, String action, Object bill, Object tenantId)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">BaseDto</span> <span class="variable">billDto</span> <span class="operator">=</span> getBaseDto(bill);</span><br><span class="line">        <span class="keyword">if</span> (isCheck(action)) &#123;</span><br><span class="line">            <span class="type">Map</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Gson</span>().fromJson(billDto.getItem(), Map.class);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != obj &amp;&amp; obj.get(<span class="string">&quot;key&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">                action = <span class="string">&quot;check_&quot;</span> + obj.get(<span class="string">&quot;key&quot;</span>).toString();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">ruleKey</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != billDto) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != billDto.getRuleKey()) &#123;</span><br><span class="line">                ruleKey = billDto.getRuleKey();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.equalsIgnoreCase(OperationTypeEnum.REFER.getValue(), action) || StringUtils.equalsIgnoreCase(action, OperationTypeEnum.REFERREFRESH.getValue())) &#123;</span><br><span class="line">                    ruleKey = billDto.getrefCode();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取可执行的redis队列</span></span><br><span class="line">        Queue&lt;RuleRegister&gt; ruleList = getAndFilterRules(billnum, action, ruleKey, tenantId, ruleLvs);</span><br><span class="line">        <span class="comment">/* 设置依赖关系 */</span></span><br><span class="line">        dependOnRule(ruleList);</span><br><span class="line">        <span class="keyword">return</span> ruleList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取规则列表</span></span><br><span class="line"><span class="comment">     * 根据ruleKey 规则关键字过滤</span></span><br><span class="line"><span class="comment">     * 高级别规则对低级别规则的覆盖</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 通过lvs循环查找规则</span></span><br><span class="line"><span class="comment">     * 1)ruleLvs[2] = &quot;common&quot;;</span></span><br><span class="line"><span class="comment">     * 2)ruleLvs[1] = uiMetaBaseInfo.getSubid();</span></span><br><span class="line"><span class="comment">     * 3)ruleLvs[0] = uiMetaBaseInfo.getBillnum();</span></span><br><span class="line"><span class="comment">     * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> action   动作</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ruleKey  规则关键字</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tenantId 租户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Queue&lt;RuleRegister&gt; <span class="title function_">getAndFilterRules</span><span class="params">(String billnum, String action, String ruleKey, Object tenantId, String[] ruleLvsOri)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取缓存， foreach 外，减少调用次数</span></span><br><span class="line">        List&lt;RuleRegister&gt; ruleRegisters;</span><br><span class="line">        <span class="keyword">if</span> (RuleUtil.isOpenCache()) &#123;<span class="comment">//是否开启规则缓存，建议都开启，默认开启</span></span><br><span class="line">            ruleRegisters = RuleUtil.getBillNumRuleFromCache(tenantId, billnum, ruleLvsOri, action);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ruleRegisters = RuleUtil.initBillNumRuleRegister(tenantId, ruleLvsOri,action);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(Tracker.switchEnable())&#123;</span><br><span class="line">            Map&lt;String, Object&gt; inparam = <span class="keyword">new</span> <span class="title class_">HashMap</span> &lt;&gt;();</span><br><span class="line">            inparam.put(<span class="string">&quot;billnum&quot;</span>, billnum);</span><br><span class="line">            inparam.put(<span class="string">&quot;action&quot;</span>, action);</span><br><span class="line">            inparam.put(<span class="string">&quot;ruleKey&quot;</span>, ruleKey);</span><br><span class="line">            inparam.put(<span class="string">&quot;tenantId&quot;</span>, tenantId);</span><br><span class="line">            inparam.put(<span class="string">&quot;ruleLvsOri&quot;</span>, ruleLvsOri);</span><br><span class="line">            Tracker.recordLogClues(<span class="built_in">this</span>.getClass().getName(), <span class="string">&quot;getAndFilterRules&quot;</span>, inparam, ruleRegisters, <span class="string">&quot;获取规则列表, 通过RuleUtil 获取的结果&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Queue&lt;RuleRegister&gt; ruleRegisterQueue = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        <span class="type">RuleStatus</span> <span class="variable">ruleStatus</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RuleStatus</span>();</span><br><span class="line">        String[] ruleLvs = ruleLvsOri.clone();</span><br><span class="line">        <span class="comment">//数组反转</span></span><br><span class="line">        ArrayUtils.reverse(ruleLvs);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; ruleLvs.length; i++) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">ruleLv</span> <span class="operator">=</span> ruleLvs[i];</span><br><span class="line">            List&lt;RuleRegister&gt; tmpList = filterRules(ruleLv, ruleKey, ruleRegisters);</span><br><span class="line">            <span class="comment">//增加同级别覆盖逻辑, 通过配置指定</span></span><br><span class="line">            overrideRule(tmpList, ruleRegisterQueue, ruleStatus, ruleLvs.length - i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//队列排序</span></span><br><span class="line">        List&lt;RuleRegister&gt; list = <span class="keyword">new</span> <span class="title class_">LinkedList</span>(ruleRegisterQueue);</span><br><span class="line">        Collections.sort(list, RuleComparatorUtil.getInstance().getCmp());</span><br><span class="line">        ruleRegisterQueue.clear();</span><br><span class="line">        ruleRegisterQueue.addAll(list);</span><br><span class="line">        <span class="keyword">return</span> ruleRegisterQueue;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>





<p>com&#x2F;yonyou&#x2F;ucf&#x2F;mdd&#x2F;rule&#x2F;utils&#x2F;<strong>RuleUtil</strong>.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化表单基本的规则列表,如果是check_action，同步查询出check的规则列表</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> tenantId   租户ID</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ruleLvsOri</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;RuleRegister&gt; <span class="title function_">initBillNumRuleRegister</span><span class="params">(Object tenantId, String[] ruleLvsOri,String ruleaction)</span> &#123;</span><br><span class="line">    Map&lt;String, Object&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    params.put(<span class="string">&quot;tenantId&quot;</span>, tenantId);</span><br><span class="line">    List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String rule :ruleLvsOri)&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(rule))&#123;</span><br><span class="line">            list.add(rule);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;String&gt; actionList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    actionList.add(ruleaction);</span><br><span class="line">    <span class="keyword">if</span> (ruleaction.startsWith(<span class="string">&quot;check_&quot;</span>))&#123;</span><br><span class="line">        list.add(<span class="string">&quot;check&quot;</span>);</span><br><span class="line">        actionList.add(<span class="string">&quot;check&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    params.put(<span class="string">&quot;list&quot;</span>, list);</span><br><span class="line">    params.put(<span class="string">&quot;actionList&quot;</span>, actionList);</span><br><span class="line">    List&lt;RuleRegister&gt; ruleRegisterList = findAllBillRuleRegister(params);</span><br><span class="line">    <span class="keyword">return</span> ruleRegisterList;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取表单列表，可按照billnum进行过滤</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> params</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;RuleRegister&gt; <span class="title function_">findAllBillRuleRegister</span><span class="params">(Map&lt;String, Object&gt; params)</span> &#123;</span><br><span class="line">        List&lt;RuleRegister&gt; ruleRegisterList = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">IRuleRegisterMapperDao</span> <span class="variable">iruledao</span> <span class="operator">=</span> UBaseContext.getBean(IRuleRegisterMapperDao.class);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == iruledao) &#123;</span><br><span class="line">                iruledao = <span class="keyword">new</span> <span class="title class_">RuleRegisterMapperDaoImpl</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            ruleRegisterList = iruledao.findAllBillRuleRegister(params);</span><br><span class="line">            <span class="comment">// 增加逻辑如果初始化当前租户没有规则，则使用公共规则 使用租户ID为0的</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == ruleRegisterList || ruleRegisterList.isEmpty()) &#123;</span><br><span class="line">                params.put(MddConstants.PARAM_TENANT_ID, ExtCommonUtil.getZeroTenant());</span><br><span class="line">                ruleRegisterList = AppContext.getBean(IRuleRegisterMapperDao.class).findAllBillRuleRegister(params);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ruleRegisterList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/01/13/%E5%AE%9E%E4%B9%A0-02-YMS%E7%A4%BA%E4%BE%8B%E5%B7%A5%E7%A8%8B%E6%90%AD%E5%BB%BA/" rel="prev" title="实习-02-YMS示例工程搭建">
      <i class="fa fa-chevron-left"></i> 实习-02-YMS示例工程搭建
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/02/09/%E5%AE%9E%E4%B9%A0-04-YMS-JDBC%E5%B7%A5%E7%A8%8B%E6%B5%8B%E8%AF%95%E5%8F%8A%E6%8E%A5%E5%8F%A3%E7%BC%96%E5%86%99/" rel="next" title="实习-04-YMS-JDBC工程测试及接口编写">
      实习-04-YMS-JDBC工程测试及接口编写 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#MDD%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0"><span class="nav-number">1.</span> <span class="nav-text">MDD框架学习</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E4%BB%BB%E5%8A%A1"><span class="nav-number">1.1.</span> <span class="nav-text">1.任务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E4%BB%8E%E5%9B%BE%E4%B9%A6%E8%AE%A2%E5%8D%95TCC%E5%BC%80%E5%A7%8B%E7%9C%8B%EF%BC%8C%E8%B7%9F%E4%BB%A3%E7%A0%81%E8%BF%9B%E8%A1%8C%E9%80%BB%E8%BE%91%E6%A2%B3%E7%90%86"><span class="nav-number">1.1.1.</span> <span class="nav-text">1.1.从图书订单TCC开始看，跟代码进行逻辑梳理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-order%E2%80%93-gt-stock%E2%80%93-gt-pay"><span class="nav-number">1.1.2.</span> <span class="nav-text">1.2.order–&gt;stock–&gt;pay</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E7%9C%8B%E7%9A%84%E8%BF%87%E7%A8%8B%E4%B8%AD%EF%BC%8C%E7%BB%93%E5%90%88mdd%E5%B7%A5%E7%A8%8B%E4%BB%A3%E7%A0%81%EF%BC%8C%E8%BF%9B%E8%A1%8C%E5%AD%A6%E4%B9%A0"><span class="nav-number">1.1.3.</span> <span class="nav-text">1.3.看的过程中，结合mdd工程代码，进行学习</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0"><span class="nav-number">1.2.</span> <span class="nav-text">2.学习笔记</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%E6%80%BB%E8%A7%88"><span class="nav-number">1.2.1.</span> <span class="nav-text">2.1.总览</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E9%85%8D%E7%BD%AE%E4%BF%9D%E5%AD%98%E6%B5%81%E7%A8%8B%E2%80%93%E8%B7%9F%E8%BF%9B%E4%BB%A3%E7%A0%81-md"><span class="nav-number">1.2.2.</span> <span class="nav-text">2.2.配置保存流程–跟进代码.md</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-3-%E9%A1%B5%E9%9D%A2%E6%93%8D%E4%BD%9C%E5%8F%8A%E8%A7%84%E5%88%99%E6%9F%A5%E7%9C%8B"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">2.2.3.页面操作及规则查看</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-4-%E8%A7%84%E5%88%99%E8%AF%A6%E7%BB%86%E5%86%85%E5%AE%B9"><span class="nav-number">1.2.2.2.</span> <span class="nav-text">2.2.4.规则详细内容</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#com-yonyou-ucf-mdd-ext-bill-rule-biz-FillPKRule"><span class="nav-number">1.2.2.2.1.</span> <span class="nav-text">com.yonyou.ucf.mdd.ext.bill.rule.biz.FillPKRule</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#com-yonyou-ucf-mdd-ext-bill-rule-check-CheckUniqueRule"><span class="nav-number">1.2.2.2.2.</span> <span class="nav-text">com.yonyou.ucf.mdd.ext.bill.rule.check.CheckUniqueRule</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#com-yonyou-ucf-mdd-ext-bill-rule-crud-SaveBillRule"><span class="nav-number">1.2.2.2.3.</span> <span class="nav-text">com.yonyou.ucf.mdd.ext.bill.rule.crud.SaveBillRule</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#com-yonyou-ucf-mdd-ext-pub-rule-SaveBusinessLogRule"><span class="nav-number">1.2.2.2.4.</span> <span class="nav-text">com.yonyou.ucf.mdd.ext.pub.rule.SaveBusinessLogRule</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#com-yonyou-ucf-mdd-ext-bill-rule-biz-RefreshTsRule"><span class="nav-number">1.2.2.2.5.</span> <span class="nav-text">com.yonyou.ucf.mdd.ext.bill.rule.biz.RefreshTsRule</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#com-yonyou-common-bizflow-rule-BizFlowWriteBackRule%E4%BD%8E%E4%BB%A3%E7%A0%81%E5%9B%9E%E5%86%99%E8%A7%84%E5%88%99"><span class="nav-number">1.2.2.2.6.</span> <span class="nav-text">com.yonyou.common.bizflow.rule.BizFlowWriteBackRule低代码回写规则</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#com-yonyou-common-bizflow-rule-BizFlowPushRule"><span class="nav-number">1.2.2.2.7.</span> <span class="nav-text">com.yonyou.common.bizflow.rule.BizFlowPushRule</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#com-yonyou-business-StockServiceTccRule"><span class="nav-number">1.2.2.2.8.</span> <span class="nav-text">com.yonyou.business.StockServiceTccRule</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#com-yonyou-business-PayServiceTccRule"><span class="nav-number">1.2.2.2.9.</span> <span class="nav-text">com.yonyou.business.PayServiceTccRule</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-MDD%E6%A1%86%E6%9E%B6com-yonyou-ucf-mdf-app-service-impl-BillServiceImp-add%E6%96%B9%E6%B3%95%E6%A2%B3%E7%90%86%EF%BC%88%E9%83%A8%E5%88%86%E5%86%85%E5%AE%B9%EF%BC%89-md"><span class="nav-number">1.2.3.</span> <span class="nav-text">2.3.MDD框架com.yonyou.ucf.mdf.app.service.impl.BillServiceImp add方法梳理（部分内容）.md</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="文晨"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">文晨</p>
  <div class="site-description" itemprop="description">百学须先立志</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">12</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; Thu Apr 07 2022 08:00:00 GMT+0800 (中国标准时间) – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">文晨</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
